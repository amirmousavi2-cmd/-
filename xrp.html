<!DOCTYPE html>
<html dir="rtl" lang="fa">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport" />
    <meta name="robots" content="noindex, nofollow, noarchive">
    <title>
        کیف پول ریپل
    </title>
    <link rel="icon" type="image/x-icon"
        href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAIABAMAAAAGVsnJAAAAG1BMVEVHcEwjKS8jKS8jKS8jKS8jKS8jKS8jKS8jKS9OtnAjAAAACHRSTlMA4BeXcb9NMLc9QqUAAAsQSURBVHja7d3NUxNNEAbwqUiRMyVBjqmI5IqgyDEBRK4R1ByJgF7BF+ScQqz9s9+UWhZaAj2zM91P9/Zz1iUz+9vZj/kKwePxeDwej8fj8Xg8Ho/H4/F4PB6Px+PxeDwej8fj8Xg8Ho/H47GZVo+QruGSzS0QsqixAoaUkg1C2KoIGegr/xylXNezf/iI8g+/6auAffKJJRFY01b+Ffp5tUlgP+LK3jdIIOqsrhgkENe02yMQeVmvUO8YRgHYIxDdrs8ZIxD/cEcisK6l/E/jW3UaASXvRK2Up3tLBEgtwGLSq0PXLABLBJ6mADBEIBGAHQKJAMwQIAGYDpJfINfNAjBCoAYAGwRqAJgRWFZPoBaAEIbqCZAAfL/7S7J2AjQAR3cfQDsBEoClew5AInDTNQtAO4FndQGEMK+ZQGtcGwCRwFuzAIgEMG8EWQCEMFFLIAsAxa1AJgB6CWQCoJZANgBaCWQDoJRARgA6CWQEoJJAOycAjQQucwKgEjgzC4BI4INZAOoIZAegjQAJwJOoQ6oiQAMQ+WPPFREoAEAVgSIANBEoAmBWr1oIFAKgh0AhAEQCU3ECBX+mDgIFf6UKAkWbqvNSV5cOAMT2VfZGUPhedQlPoHA7VewWqwQAPoHiL63gBBheWLAJMDypQBNgeWPN/rVNUwtQ6HObKgDIBJi+W8ISYPtmhUqArfsKlABjByYmAcb+yxYiAdYe7GeABFg7sAEJMA9hwCPAPIIBjgD7GBY0AuwjmsEICAxiwiIgMKQdioDI1CYSge9mAWSZjqMaQO0ZedwA8s9rgiEgNsW51qzcjNmXmthWc1quegAoBMQAgBAQXeQAgYAggBrrsxgBgEBAFAAAAfFlTqQJCAMQJwCwzk3CSn2WAAgTgFjoSHIVZgAAogRIdV9+4VMxAi0SgLXyr6NSBEAAyBHYAgEgRQBoDfw5kZ+CA4DYGg3MApBZi13+TTz6iSTrr3mKBECCABYA/uX4wQCwL8ffQgPATQAOADMBQAC8BAABsH6cgATA+XUCEgAjAVAAfARAAbARAOmVlyMAC4CJADAAHgLAAFgI0AZoCgHgGLFImq4jtycubS32s/Q/0MYGQCRQYwz1BBsAkUD6GSp8+BwhnaJvie0g7SF4SbL8tHOUOoGX1AJWR6IVQCOQNoSYNC9EGACVwONuqQtgKgyASKB6H3/g00oDACrU6XaRZ2AAAFQCN5G/dH6sBACVQHUd9UDY3lIDgEqgWoxoCNvPKzUAyAQiaqA1rBQBIBOoDrt5yw8CgE6AWANtavlRANAJVI/P8l3/OAAiCFSPPz50rNVRpQ5ABIHq5tW9l0HrmFyXQABiCMwagi/3nP7X9OMgAYghMEOweQeC9vE44jBIAOIIVFVn7x8K+iejmGNgASCubXirCl58/oNB6+vOKO4IWACIy5v+cQY7G3ufr3qzXH092RhF/3cwANEEfmbhR1L+5xO08scTqBX5Rd0zEUgNHgBeAogAWAkgAuAkgAmAkQAmAGJfrmEA1L6s2vmAWn4mArgAmAjgAuAhcAMMgIUAMgDiqK56ALrQFUDs06yRdezyE3v103MNDoA4xTM92wE+w5LlX8Qvf+T3Ue0fwphvhR80lL9gO4jfAv7MSoNbwPh+IsVdAdyvBNgvAX9dBAXuBNPtoCin+SvgvabyU4e5GbwDlHoc0vEIdDv/5a2AV0FdTpvbAPx6IHyer/yPuworIOPTwM1RUJmVcROfAPI/D+kt/+xWkKEGpq9CaHQNqC5/CMc1a2C6GUKja0B9+etdBdNXwUAulptd/vTngZvtYCTzSU/FD88tUPRe8Dr6MpgengVDaV1EXgY3b4KxrL6MKf/Bx2AurQvygPjOXjdYTH+H1BJMX3wJVrP6cBUsHH4MltO/f2ZIx/DZ//2h6OTlHVMkFg727Bf/J4OTjdFflbDQ2WhK6X/dE64+7W68fPcjBxu7n666oZHp9Xrdhhbd4/F4PB6Px+PxeDwej8fj8Xg8Ho/H4/F4PB6Ppylp7PiQVv/r7s7GzzFCGy/2Pn9pVEX0T3be/T1K7N2LpowS613cNU6wc/DGvoP+caNHivYfXkL9xnAVtI9JA+Y7m2c22/2I+QIW24J+zLSh6aG56+Aicv+Ejq05Q63T+Flj7w1dBu20eYNm2sLVUdrM0Y6RyTMX49S5wzYmDzZ99ni9NST010DdNTS010D9NUQav4aK6hpo+jpC8+MqS7SupJVvUUVNq4neev7PuMZ2zJ7FMGn6eoKZNxpYb2oDqHVN0fzriytbVbbp6wo3fWXp/Msq/7gI9DwNNH11+blCm2xMB029Ayi7EzR9j5HG7zLT9H2G5qqiGTS3BVTSDjZ9t7nG7zf4rCqet9AvAePyFQD9gbDpu87y7DsMTKDpO09z7T0OS4AJACwBLgCwBNgAVNWTZgMAJcAIAJJAe5mzAqZ4BM6TyrEwy7IJAvEAOge7n66uer2rq0+7L0fqCUQCWDj83Lv933tfd0aqCcQB6Gz+YzR8/3ikmEAMgDv3D2hHbcr0RCuA+zaPidmHA4oAHcB0895PWq0IBEBdhfS+kIf3TqKPrQfqJZnk4P+7Np+rI0AGQJsD0h5qI0AFsEhstsgjDJd0AaDPAaLWAAiBSe7y02dZLSkCEDfimTjKCIIADUDsGK/VsRYCRADRsx6eLishMCl1pk51EKABSBniRxtpIE6ABCBtfButbpc0AEjsyLhUQIAEIHVYC+0iWMIHMEg9PGnIqSiBSeFTNAEnMF/6DNF6m46wAdTqyr2EJkC6ROt147WgCZAA1BzURRp3uIgMoFvvj5BuhUITCYYMAJAJsABAJsADgEjgmwAArrHdqAT22YZ2YxJgA4BKgA8AJgFGANTX4oFZAIjPAqwAZoEjwAsArxXgBgBHgBtACI+gCPADACPADwCLgAQAYq0PzAIIYQWGgAyA0CLV+xpDBWyJACBWPAMBEsXrAn8YhcCW2M/AIPBICgC19V0zC4Da/NoFAEFA9olUnsAj4V+wL3QLhvk2JfQQBvRGIksA4OOkLAGED1OSBCC+TksSwPgyKUcApHtCjgDKp+mhEAGY/inSwIwCBHD6JmQIAHVQyhBA6p+UIADVQz0vQACrg5qfANgQBRKBrCsvoo1QmDATgBumxE3gGRgAnnHatwCMwQBwEyAB+B6CVQI0AEe8FcBJgASAfdoKHwFIAJwEMAHwEQAFwEcAFQAXAVgAXARwAXDM2yTOXZWavkwjcFbrb2BPXT0vTgAaAAcBbADlCYADIC7kWIMAOoDSBOABlCaAD6AsAQUAyhLQAKAkARqAM+kKKPczSQAAVje+LERACYByP/RcCYBSVEmtK8bq1mUI6AFQhoAiAGUIlH/TxiZQ+i0LnoAuAPkJzOsCkP+1RRuA3O8t6gDkJjBRByBv/4VCAHl7sDQCyElAJYCcBHQCyEdAKYB8BLQCyEWAfxguGAHeIZh4BBQDyENAM4AcBFQDoI5qPzILgDivYcksAOrMliOzAIgEvpsFULcVGKoHUI+AxHQ8IQKDdADrIRgg8M/5TXMWANQhYANAOgEjANJnue4bAZBKQHqNJnECdgAQF7xaNAsgjYAlAClrnpkCkELAFoB4AsYAhOiVL60BiCVgD0AkAXsA4lZhRliuN/+NYJ9OgPRP15RVQMRy/CYBhIgdGWwCoJ9YrP1b2FuB7TBcIEQhgBkBSskWQ4+SoDKGi+bxeDwej8fj8Xg8Ho/H4/F4PB6Px+PxeDwej8fj8Xg8Ho/H4/E8mP8BpTvVT45ZXXcAAAAASUVORK5CYII=" />
    <script src="https://cdn.jsdelivr.net/npm/xrpl@4.4.3/build/xrpl-latest-min.js">
    </script>
    <script>
        var QRCode = function () { function a(a) { this.mode = c.MODE_8BIT_BYTE, this.data = a, this.parsedData = []; for (var b = [], d = 0, e = this.data.length; e > d; d++) { var f = this.data.charCodeAt(d); f > 65536 ? (b[0] = 240 | (1835008 & f) >>> 18, b[1] = 128 | (258048 & f) >>> 12, b[2] = 128 | (4032 & f) >>> 6, b[3] = 128 | 63 & f) : f > 2048 ? (b[0] = 224 | (61440 & f) >>> 12, b[1] = 128 | (4032 & f) >>> 6, b[2] = 128 | 63 & f) : f > 128 ? (b[0] = 192 | (1984 & f) >>> 6, b[1] = 128 | 63 & f) : b[0] = f, this.parsedData = this.parsedData.concat(b) } this.parsedData.length != this.data.length && (this.parsedData.unshift(191), this.parsedData.unshift(187), this.parsedData.unshift(239)) } function b(a, b) { this.typeNumber = a, this.errorCorrectLevel = b, this.modules = null, this.moduleCount = 0, this.dataCache = null, this.dataList = [] } function i(a, b) { if (void 0 == a.length) throw new Error(a.length + "/" + b); for (var c = 0; c < a.length && 0 == a[c];)c++; this.num = new Array(a.length - c + b); for (var d = 0; d < a.length - c; d++)this.num[d] = a[d + c] } function j(a, b) { this.totalCount = a, this.dataCount = b } function k() { this.buffer = [], this.length = 0 } function m() { return "undefined" != typeof CanvasRenderingContext2D } function n() { var a = !1, b = navigator.userAgent; return /android/i.test(b) && (a = !0, aMat = b.toString().match(/android ([0-9]\.[0-9])/i), aMat && aMat[1] && (a = parseFloat(aMat[1]))), a } function r(a, b) { for (var c = 1, e = s(a), f = 0, g = l.length; g >= f; f++) { var h = 0; switch (b) { case d.L: h = l[f][0]; break; case d.M: h = l[f][1]; break; case d.Q: h = l[f][2]; break; case d.H: h = l[f][3] }if (h >= e) break; c++ } if (c > l.length) throw new Error("Too long data"); return c } function s(a) { var b = encodeURI(a).toString().replace(/\%[0-9a-fA-F]{2}/g, "a"); return b.length + (b.length != a ? 3 : 0) } a.prototype = { getLength: function () { return this.parsedData.length }, write: function (a) { for (var b = 0, c = this.parsedData.length; c > b; b++)a.put(this.parsedData[b], 8) } }, b.prototype = { addData: function (b) { var c = new a(b); this.dataList.push(c), this.dataCache = null }, isDark: function (a, b) { if (0 > a || this.moduleCount <= a || 0 > b || this.moduleCount <= b) throw new Error(a + "," + b); return this.modules[a][b] }, getModuleCount: function () { return this.moduleCount }, make: function () { this.makeImpl(!1, this.getBestMaskPattern()) }, makeImpl: function (a, c) { this.moduleCount = 4 * this.typeNumber + 17, this.modules = new Array(this.moduleCount); for (var d = 0; d < this.moduleCount; d++) { this.modules[d] = new Array(this.moduleCount); for (var e = 0; e < this.moduleCount; e++)this.modules[d][e] = null } this.setupPositionProbePattern(0, 0), this.setupPositionProbePattern(this.moduleCount - 7, 0), this.setupPositionProbePattern(0, this.moduleCount - 7), this.setupPositionAdjustPattern(), this.setupTimingPattern(), this.setupTypeInfo(a, c), this.typeNumber >= 7 && this.setupTypeNumber(a), null == this.dataCache && (this.dataCache = b.createData(this.typeNumber, this.errorCorrectLevel, this.dataList)), this.mapData(this.dataCache, c) }, setupPositionProbePattern: function (a, b) { for (var c = -1; 7 >= c; c++)if (!(-1 >= a + c || this.moduleCount <= a + c)) for (var d = -1; 7 >= d; d++)-1 >= b + d || this.moduleCount <= b + d || (this.modules[a + c][b + d] = c >= 0 && 6 >= c && (0 == d || 6 == d) || d >= 0 && 6 >= d && (0 == c || 6 == c) || c >= 2 && 4 >= c && d >= 2 && 4 >= d ? !0 : !1) }, getBestMaskPattern: function () { for (var a = 0, b = 0, c = 0; 8 > c; c++) { this.makeImpl(!0, c); var d = f.getLostPoint(this); (0 == c || a > d) && (a = d, b = c) } return b }, setupTimingPattern: function () { for (var a = 8; a < this.moduleCount - 8; a++)null == this.modules[a][6] && (this.modules[a][6] = 0 == a % 2); for (var b = 8; b < this.moduleCount - 8; b++)null == this.modules[6][b] && (this.modules[6][b] = 0 == b % 2) }, setupPositionAdjustPattern: function () { for (var a = f.getPatternPosition(this.typeNumber), b = 0; b < a.length; b++)for (var c = 0; c < a.length; c++) { var d = a[b], e = a[c]; if (null == this.modules[d][e]) for (var g = -2; 2 >= g; g++)for (var h = -2; 2 >= h; h++)this.modules[d + g][e + h] = -2 == g || 2 == g || -2 == h || 2 == h || 0 == g && 0 == h ? !0 : !1 } }, setupTypeNumber: function (a) { for (var b = f.getBCHTypeNumber(this.typeNumber), c = 0; 18 > c; c++) { var d = !a && 1 == (1 & b >> c); this.modules[Math.floor(c / 3)][c % 3 + this.moduleCount - 8 - 3] = d } for (var c = 0; 18 > c; c++) { var d = !a && 1 == (1 & b >> c); this.modules[c % 3 + this.moduleCount - 8 - 3][Math.floor(c / 3)] = d } }, setupTypeInfo: function (a, b) { for (var c = this.errorCorrectLevel << 3 | b, d = f.getBCHTypeInfo(c), e = 0; 15 > e; e++) { var g = !a && 1 == (1 & d >> e); 6 > e ? this.modules[e][8] = g : 8 > e ? this.modules[e + 1][8] = g : this.modules[this.moduleCount - 15 + e][8] = g } for (var e = 0; 15 > e; e++) { var g = !a && 1 == (1 & d >> e); 8 > e ? this.modules[8][this.moduleCount - e - 1] = g : 9 > e ? this.modules[8][15 - e - 1 + 1] = g : this.modules[8][15 - e - 1] = g } this.modules[this.moduleCount - 8][8] = !a }, mapData: function (a, b) { for (var c = -1, d = this.moduleCount - 1, e = 7, g = 0, h = this.moduleCount - 1; h > 0; h -= 2)for (6 == h && h--; ;) { for (var i = 0; 2 > i; i++)if (null == this.modules[d][h - i]) { var j = !1; g < a.length && (j = 1 == (1 & a[g] >>> e)); var k = f.getMask(b, d, h - i); k && (j = !j), this.modules[d][h - i] = j, e--, -1 == e && (g++, e = 7) } if (d += c, 0 > d || this.moduleCount <= d) { d -= c, c = -c; break } } } }, b.PAD0 = 236, b.PAD1 = 17, b.createData = function (a, c, d) { for (var e = j.getRSBlocks(a, c), g = new k, h = 0; h < d.length; h++) { var i = d[h]; g.put(i.mode, 4), g.put(i.getLength(), f.getLengthInBits(i.mode, a)), i.write(g) } for (var l = 0, h = 0; h < e.length; h++)l += e[h].dataCount; if (g.getLengthInBits() > 8 * l) throw new Error("code length overflow. (" + g.getLengthInBits() + ">" + 8 * l + ")"); for (g.getLengthInBits() + 4 <= 8 * l && g.put(0, 4); 0 != g.getLengthInBits() % 8;)g.putBit(!1); for (; ;) { if (g.getLengthInBits() >= 8 * l) break; if (g.put(b.PAD0, 8), g.getLengthInBits() >= 8 * l) break; g.put(b.PAD1, 8) } return b.createBytes(g, e) }, b.createBytes = function (a, b) { for (var c = 0, d = 0, e = 0, g = new Array(b.length), h = new Array(b.length), j = 0; j < b.length; j++) { var k = b[j].dataCount, l = b[j].totalCount - k; d = Math.max(d, k), e = Math.max(e, l), g[j] = new Array(k); for (var m = 0; m < g[j].length; m++)g[j][m] = 255 & a.buffer[m + c]; c += k; var n = f.getErrorCorrectPolynomial(l), o = new i(g[j], n.getLength() - 1), p = o.mod(n); h[j] = new Array(n.getLength() - 1); for (var m = 0; m < h[j].length; m++) { var q = m + p.getLength() - h[j].length; h[j][m] = q >= 0 ? p.get(q) : 0 } } for (var r = 0, m = 0; m < b.length; m++)r += b[m].totalCount; for (var s = new Array(r), t = 0, m = 0; d > m; m++)for (var j = 0; j < b.length; j++)m < g[j].length && (s[t++] = g[j][m]); for (var m = 0; e > m; m++)for (var j = 0; j < b.length; j++)m < h[j].length && (s[t++] = h[j][m]); return s }; for (var c = { MODE_NUMBER: 1, MODE_ALPHA_NUM: 2, MODE_8BIT_BYTE: 4, MODE_KANJI: 8 }, d = { L: 1, M: 0, Q: 3, H: 2 }, e = { PATTERN000: 0, PATTERN001: 1, PATTERN010: 2, PATTERN011: 3, PATTERN100: 4, PATTERN101: 5, PATTERN110: 6, PATTERN111: 7 }, f = { PATTERN_POSITION_TABLE: [[], [6, 18], [6, 22], [6, 26], [6, 30], [6, 34], [6, 22, 38], [6, 24, 42], [6, 26, 46], [6, 28, 50], [6, 30, 54], [6, 32, 58], [6, 34, 62], [6, 26, 46, 66], [6, 26, 48, 70], [6, 26, 50, 74], [6, 30, 54, 78], [6, 30, 56, 82], [6, 30, 58, 86], [6, 34, 62, 90], [6, 28, 50, 72, 94], [6, 26, 50, 74, 98], [6, 30, 54, 78, 102], [6, 28, 54, 80, 106], [6, 32, 58, 84, 110], [6, 30, 58, 86, 114], [6, 34, 62, 90, 118], [6, 26, 50, 74, 98, 122], [6, 30, 54, 78, 102, 126], [6, 26, 52, 78, 104, 130], [6, 30, 56, 82, 108, 134], [6, 34, 60, 86, 112, 138], [6, 30, 58, 86, 114, 142], [6, 34, 62, 90, 118, 146], [6, 30, 54, 78, 102, 126, 150], [6, 24, 50, 76, 102, 128, 154], [6, 28, 54, 80, 106, 132, 158], [6, 32, 58, 84, 110, 136, 162], [6, 26, 54, 82, 110, 138, 166], [6, 30, 58, 86, 114, 142, 170]], G15: 1335, G18: 7973, G15_MASK: 21522, getBCHTypeInfo: function (a) { for (var b = a << 10; f.getBCHDigit(b) - f.getBCHDigit(f.G15) >= 0;)b ^= f.G15 << f.getBCHDigit(b) - f.getBCHDigit(f.G15); return (a << 10 | b) ^ f.G15_MASK }, getBCHTypeNumber: function (a) { for (var b = a << 12; f.getBCHDigit(b) - f.getBCHDigit(f.G18) >= 0;)b ^= f.G18 << f.getBCHDigit(b) - f.getBCHDigit(f.G18); return a << 12 | b }, getBCHDigit: function (a) { for (var b = 0; 0 != a;)b++, a >>>= 1; return b }, getPatternPosition: function (a) { return f.PATTERN_POSITION_TABLE[a - 1] }, getMask: function (a, b, c) { switch (a) { case e.PATTERN000: return 0 == (b + c) % 2; case e.PATTERN001: return 0 == b % 2; case e.PATTERN010: return 0 == c % 3; case e.PATTERN011: return 0 == (b + c) % 3; case e.PATTERN100: return 0 == (Math.floor(b / 2) + Math.floor(c / 3)) % 2; case e.PATTERN101: return 0 == b * c % 2 + b * c % 3; case e.PATTERN110: return 0 == (b * c % 2 + b * c % 3) % 2; case e.PATTERN111: return 0 == (b * c % 3 + (b + c) % 2) % 2; default: throw new Error("bad maskPattern:" + a) } }, getErrorCorrectPolynomial: function (a) { for (var b = new i([1], 0), c = 0; a > c; c++)b = b.multiply(new i([1, g.gexp(c)], 0)); return b }, getLengthInBits: function (a, b) { if (b >= 1 && 10 > b) switch (a) { case c.MODE_NUMBER: return 10; case c.MODE_ALPHA_NUM: return 9; case c.MODE_8BIT_BYTE: return 8; case c.MODE_KANJI: return 8; default: throw new Error("mode:" + a) } else if (27 > b) switch (a) { case c.MODE_NUMBER: return 12; case c.MODE_ALPHA_NUM: return 11; case c.MODE_8BIT_BYTE: return 16; case c.MODE_KANJI: return 10; default: throw new Error("mode:" + a) } else { if (!(41 > b)) throw new Error("type:" + b); switch (a) { case c.MODE_NUMBER: return 14; case c.MODE_ALPHA_NUM: return 13; case c.MODE_8BIT_BYTE: return 16; case c.MODE_KANJI: return 12; default: throw new Error("mode:" + a) } } }, getLostPoint: function (a) { for (var b = a.getModuleCount(), c = 0, d = 0; b > d; d++)for (var e = 0; b > e; e++) { for (var f = 0, g = a.isDark(d, e), h = -1; 1 >= h; h++)if (!(0 > d + h || d + h >= b)) for (var i = -1; 1 >= i; i++)0 > e + i || e + i >= b || (0 != h || 0 != i) && g == a.isDark(d + h, e + i) && f++; f > 5 && (c += 3 + f - 5) } for (var d = 0; b - 1 > d; d++)for (var e = 0; b - 1 > e; e++) { var j = 0; a.isDark(d, e) && j++, a.isDark(d + 1, e) && j++, a.isDark(d, e + 1) && j++, a.isDark(d + 1, e + 1) && j++; (0 == j || 4 == j) && (c += 3) } for (var d = 0; b > d; d++)for (var e = 0; b - 6 > e; e++)a.isDark(d, e) && !a.isDark(d, e + 1) && a.isDark(d, e + 2) && a.isDark(d, e + 3) && a.isDark(d, e + 4) && !a.isDark(d, e + 5) && a.isDark(d, e + 6) && (c += 40); for (var e = 0; b > e; e++)for (var d = 0; b - 6 > d; d++)a.isDark(d, e) && !a.isDark(d + 1, e) && a.isDark(d + 2, e) && a.isDark(d + 3, e) && a.isDark(d + 4, e) && !a.isDark(d + 5, e) && a.isDark(d + 6, e) && (c += 40); for (var k = 0, e = 0; b > e; e++)for (var d = 0; b > d; d++)a.isDark(d, e) && k++; var l = Math.abs(100 * k / b / b - 50) / 5; return c += 10 * l } }, g = { glog: function (a) { if (1 > a) throw new Error("glog(" + a + ")"); return g.LOG_TABLE[a] }, gexp: function (a) { for (; 0 > a;)a += 255; for (; a >= 256;)a -= 255; return g.EXP_TABLE[a] }, EXP_TABLE: new Array(256), LOG_TABLE: new Array(256) }, h = 0; 8 > h; h++)g.EXP_TABLE[h] = 1 << h; for (var h = 8; 256 > h; h++)g.EXP_TABLE[h] = g.EXP_TABLE[h - 4] ^ g.EXP_TABLE[h - 5] ^ g.EXP_TABLE[h - 6] ^ g.EXP_TABLE[h - 8]; for (var h = 0; 255 > h; h++)g.LOG_TABLE[g.EXP_TABLE[h]] = h; i.prototype = { get: function (a) { return this.num[a] }, getLength: function () { return this.num.length }, multiply: function (a) { for (var b = new Array(this.getLength() + a.getLength() - 1), c = 0; c < this.getLength(); c++)for (var d = 0; d < a.getLength(); d++)b[c + d] ^= g.gexp(g.glog(this.get(c)) + g.glog(a.get(d))); return new i(b, 0) }, mod: function (a) { if (this.getLength() - a.getLength() < 0) return this; for (var b = g.glog(this.get(0)) - g.glog(a.get(0)), c = new Array(this.getLength()), d = 0; d < this.getLength(); d++)c[d] = this.get(d); for (var d = 0; d < a.getLength(); d++)c[d] ^= g.gexp(g.glog(a.get(d)) + b); return new i(c, 0).mod(a) } }, j.RS_BLOCK_TABLE = [[1, 26, 19], [1, 26, 16], [1, 26, 13], [1, 26, 9], [1, 44, 34], [1, 44, 28], [1, 44, 22], [1, 44, 16], [1, 70, 55], [1, 70, 44], [2, 35, 17], [2, 35, 13], [1, 100, 80], [2, 50, 32], [2, 50, 24], [4, 25, 9], [1, 134, 108], [2, 67, 43], [2, 33, 15, 2, 34, 16], [2, 33, 11, 2, 34, 12], [2, 86, 68], [4, 43, 27], [4, 43, 19], [4, 43, 15], [2, 98, 78], [4, 49, 31], [2, 32, 14, 4, 33, 15], [4, 39, 13, 1, 40, 14], [2, 121, 97], [2, 60, 38, 2, 61, 39], [4, 40, 18, 2, 41, 19], [4, 40, 14, 2, 41, 15], [2, 146, 116], [3, 58, 36, 2, 59, 37], [4, 36, 16, 4, 37, 17], [4, 36, 12, 4, 37, 13], [2, 86, 68, 2, 87, 69], [4, 69, 43, 1, 70, 44], [6, 43, 19, 2, 44, 20], [6, 43, 15, 2, 44, 16], [4, 101, 81], [1, 80, 50, 4, 81, 51], [4, 50, 22, 4, 51, 23], [3, 36, 12, 8, 37, 13], [2, 116, 92, 2, 117, 93], [6, 58, 36, 2, 59, 37], [4, 46, 20, 6, 47, 21], [7, 42, 14, 4, 43, 15], [4, 133, 107], [8, 59, 37, 1, 60, 38], [8, 44, 20, 4, 45, 21], [12, 33, 11, 4, 34, 12], [3, 145, 115, 1, 146, 116], [4, 64, 40, 5, 65, 41], [11, 36, 16, 5, 37, 17], [11, 36, 12, 5, 37, 13], [5, 109, 87, 1, 110, 88], [5, 65, 41, 5, 66, 42], [5, 54, 24, 7, 55, 25], [11, 36, 12], [5, 122, 98, 1, 123, 99], [7, 73, 45, 3, 74, 46], [15, 43, 19, 2, 44, 20], [3, 45, 15, 13, 46, 16], [1, 135, 107, 5, 136, 108], [10, 74, 46, 1, 75, 47], [1, 50, 22, 15, 51, 23], [2, 42, 14, 17, 43, 15], [5, 150, 120, 1, 151, 121], [9, 69, 43, 4, 70, 44], [17, 50, 22, 1, 51, 23], [2, 42, 14, 19, 43, 15], [3, 141, 113, 4, 142, 114], [3, 70, 44, 11, 71, 45], [17, 47, 21, 4, 48, 22], [9, 39, 13, 16, 40, 14], [3, 135, 107, 5, 136, 108], [3, 67, 41, 13, 68, 42], [15, 54, 24, 5, 55, 25], [15, 43, 15, 10, 44, 16], [4, 144, 116, 4, 145, 117], [17, 68, 42], [17, 50, 22, 6, 51, 23], [19, 46, 16, 6, 47, 17], [2, 139, 111, 7, 140, 112], [17, 74, 46], [7, 54, 24, 16, 55, 25], [34, 37, 13], [4, 151, 121, 5, 152, 122], [4, 75, 47, 14, 76, 48], [11, 54, 24, 14, 55, 25], [16, 45, 15, 14, 46, 16], [6, 147, 117, 4, 148, 118], [6, 73, 45, 14, 74, 46], [11, 54, 24, 16, 55, 25], [30, 46, 16, 2, 47, 17], [8, 132, 106, 4, 133, 107], [8, 75, 47, 13, 76, 48], [7, 54, 24, 22, 55, 25], [22, 45, 15, 13, 46, 16], [10, 142, 114, 2, 143, 115], [19, 74, 46, 4, 75, 47], [28, 50, 22, 6, 51, 23], [33, 46, 16, 4, 47, 17], [8, 152, 122, 4, 153, 123], [22, 73, 45, 3, 74, 46], [8, 53, 23, 26, 54, 24], [12, 45, 15, 28, 46, 16], [3, 147, 117, 10, 148, 118], [3, 73, 45, 23, 74, 46], [4, 54, 24, 31, 55, 25], [11, 45, 15, 31, 46, 16], [7, 146, 116, 7, 147, 117], [21, 73, 45, 7, 74, 46], [1, 53, 23, 37, 54, 24], [19, 45, 15, 26, 46, 16], [5, 145, 115, 10, 146, 116], [19, 75, 47, 10, 76, 48], [15, 54, 24, 25, 55, 25], [23, 45, 15, 25, 46, 16], [13, 145, 115, 3, 146, 116], [2, 74, 46, 29, 75, 47], [42, 54, 24, 1, 55, 25], [23, 45, 15, 28, 46, 16], [17, 145, 115], [10, 74, 46, 23, 75, 47], [10, 54, 24, 35, 55, 25], [19, 45, 15, 35, 46, 16], [17, 145, 115, 1, 146, 116], [14, 74, 46, 21, 75, 47], [29, 54, 24, 19, 55, 25], [11, 45, 15, 46, 46, 16], [13, 145, 115, 6, 146, 116], [14, 74, 46, 23, 75, 47], [44, 54, 24, 7, 55, 25], [59, 46, 16, 1, 47, 17], [12, 151, 121, 7, 152, 122], [12, 75, 47, 26, 76, 48], [39, 54, 24, 14, 55, 25], [22, 45, 15, 41, 46, 16], [6, 151, 121, 14, 152, 122], [6, 75, 47, 34, 76, 48], [46, 54, 24, 10, 55, 25], [2, 45, 15, 64, 46, 16], [17, 152, 122, 4, 153, 123], [29, 74, 46, 14, 75, 47], [49, 54, 24, 10, 55, 25], [24, 45, 15, 46, 46, 16], [4, 152, 122, 18, 153, 123], [13, 74, 46, 32, 75, 47], [48, 54, 24, 14, 55, 25], [42, 45, 15, 32, 46, 16], [20, 147, 117, 4, 148, 118], [40, 75, 47, 7, 76, 48], [43, 54, 24, 22, 55, 25], [10, 45, 15, 67, 46, 16], [19, 148, 118, 6, 149, 119], [18, 75, 47, 31, 76, 48], [34, 54, 24, 34, 55, 25], [20, 45, 15, 61, 46, 16]], j.getRSBlocks = function (a, b) { var c = j.getRsBlockTable(a, b); if (void 0 == c) throw new Error("bad rs block @ typeNumber:" + a + "/errorCorrectLevel:" + b); for (var d = c.length / 3, e = [], f = 0; d > f; f++)for (var g = c[3 * f + 0], h = c[3 * f + 1], i = c[3 * f + 2], k = 0; g > k; k++)e.push(new j(h, i)); return e }, j.getRsBlockTable = function (a, b) { switch (b) { case d.L: return j.RS_BLOCK_TABLE[4 * (a - 1) + 0]; case d.M: return j.RS_BLOCK_TABLE[4 * (a - 1) + 1]; case d.Q: return j.RS_BLOCK_TABLE[4 * (a - 1) + 2]; case d.H: return j.RS_BLOCK_TABLE[4 * (a - 1) + 3]; default: return void 0 } }, k.prototype = { get: function (a) { var b = Math.floor(a / 8); return 1 == (1 & this.buffer[b] >>> 7 - a % 8) }, put: function (a, b) { for (var c = 0; b > c; c++)this.putBit(1 == (1 & a >>> b - c - 1)) }, getLengthInBits: function () { return this.length }, putBit: function (a) { var b = Math.floor(this.length / 8); this.buffer.length <= b && this.buffer.push(0), a && (this.buffer[b] |= 128 >>> this.length % 8), this.length++ } }; var l = [[17, 14, 11, 7], [32, 26, 20, 14], [53, 42, 32, 24], [78, 62, 46, 34], [106, 84, 60, 44], [134, 106, 74, 58], [154, 122, 86, 64], [192, 152, 108, 84], [230, 180, 130, 98], [271, 213, 151, 119], [321, 251, 177, 137], [367, 287, 203, 155], [425, 331, 241, 177], [458, 362, 258, 194], [520, 412, 292, 220], [586, 450, 322, 250], [644, 504, 364, 280], [718, 560, 394, 310], [792, 624, 442, 338], [858, 666, 482, 382], [929, 711, 509, 403], [1003, 779, 565, 439], [1091, 857, 611, 461], [1171, 911, 661, 511], [1273, 997, 715, 535], [1367, 1059, 751, 593], [1465, 1125, 805, 625], [1528, 1190, 868, 658], [1628, 1264, 908, 698], [1732, 1370, 982, 742], [1840, 1452, 1030, 790], [1952, 1538, 1112, 842], [2068, 1628, 1168, 898], [2188, 1722, 1228, 958], [2303, 1809, 1283, 983], [2431, 1911, 1351, 1051], [2563, 1989, 1423, 1093], [2699, 2099, 1499, 1139], [2809, 2213, 1579, 1219], [2953, 2331, 1663, 1273]], o = function () { var a = function (a, b) { this._el = a, this._htOption = b }; return a.prototype.draw = function (a) { function g(a, b) { var c = document.createElementNS("http://www.w3.org/2000/svg", a); for (var d in b) b.hasOwnProperty(d) && c.setAttribute(d, b[d]); return c } var b = this._htOption, c = this._el, d = a.getModuleCount(); Math.floor(b.width / d), Math.floor(b.height / d), this.clear(); var h = g("svg", { viewBox: "0 0 " + String(d) + " " + String(d), width: "100%", height: "100%", fill: b.colorLight }); h.setAttributeNS("http://www.w3.org/2000/xmlns/", "xmlns:xlink", "http://www.w3.org/1999/xlink"), c.appendChild(h), h.appendChild(g("rect", { fill: b.colorDark, width: "1", height: "1", id: "template" })); for (var i = 0; d > i; i++)for (var j = 0; d > j; j++)if (a.isDark(i, j)) { var k = g("use", { x: String(i), y: String(j) }); k.setAttributeNS("http://www.w3.org/1999/xlink", "href", "#template"), h.appendChild(k) } }, a.prototype.clear = function () { for (; this._el.hasChildNodes();)this._el.removeChild(this._el.lastChild) }, a }(), p = "svg" === document.documentElement.tagName.toLowerCase(), q = function () { var a = function (a, b) { this._bIsPainted = !1, this._android = n(), this._htOption = b, this._elCanvas = document.createElement("canvas"), this._elCanvas.width = b.width, this._elCanvas.height = b.height, a.appendChild(this._elCanvas), this._el = a, this._oContext = this._elCanvas.getContext("2d"), this._bIsPainted = !1, this._elImage = document.createElement("img"), this._elImage.style.display = "none", this._el.appendChild(this._elImage), this._bSupportDataURI = !0 }; return a.prototype.draw = function (a) { var b = this._elImage, c = this._oContext, d = this._htOption, e = a.getModuleCount(), f = Math.floor(d.width / e), g = Math.floor(d.height / e), h = f * e, i = g * e; this._elCanvas.width = h, this._elCanvas.height = i, c.imageSmoothingEnabled = !1, c.mozImageSmoothingEnabled = !1, c.webkitImageSmoothingEnabled = !1, c.msImageSmoothingEnabled = !1, b.style.display = "none", this.clear(); for (var j = 0; e > j; j++)for (var k = 0; e > k; k++)a.isDark(j, k) ? (c.fillStyle = d.colorDark, c.fillRect(k * f, j * g, f, g)) : (c.fillStyle = d.colorLight, c.fillRect(k * f, j * g, f, g)) }, a.prototype.makeImage = function () { this._bIsPainted && (this._elImage.src = this._elCanvas.toDataURL("image/png"), this._elImage.style.display = "block", this._elCanvas.style.display = "none") }, a.prototype.isPainted = function () { return this._bIsPainted }, a.prototype.clear = function () { this._oContext.clearRect(0, 0, this._elCanvas.width, this._elCanvas.height), this._bIsPainted = !1 }, a }(); return QRCode = function (a, c) { if (this._htOption = { width: 256, height: 256, typeNumber: 4, colorDark: "#000000", colorLight: "#ffffff", correctLevel: d.H }, "string" == typeof c && (c = { text: c }), c) for (var e in c) this._htOption[e] = c[e]; "string" == typeof a && (a = document.getElementById(a)), this._android = n(), this._el = a, this._oQRCode = null, this._oDrawing = new q(this._el, this._htOption), this._htOption.text && this.makeCode(this._htOption.text) }, QRCode.prototype.makeCode = function (a) { this._oQRCode = new b(r(a, this._htOption.correctLevel), this._htOption.correctLevel), this._oQRCode.addData(a), this._oQRCode.make(), this._el.title = a, this._oDrawing.draw(this._oQRCode), this.makeImage() }, QRCode.prototype.makeImage = function () { "function" == typeof this._oDrawing.makeImage && (!this._android || this._android >= 3) && this._oDrawing.makeImage() }, QRCode.prototype.clear = function () { this._oDrawing.clear() }, QRCode.CorrectLevel = d, QRCode }();
    </script>
    <script>
        (function webpackUniversalModuleDefinition(root, factory) { if (typeof exports === 'object' && typeof module === 'object') module.exports = factory(); else if (typeof define === 'function' && define.amd) define([], factory); else if (typeof exports === 'object') exports["jsQR"] = factory(); else root["jsQR"] = factory(); })(typeof self !== 'undefined' ? self : this, function () { return (function (modules) { var installedModules = {}; function __webpack_require__(moduleId) { if (installedModules[moduleId]) { return installedModules[moduleId].exports; } var module = installedModules[moduleId] = { i: moduleId, l: false, exports: {} }; modules[moduleId].call(module.exports, module, module.exports, __webpack_require__); module.l = true; return module.exports; } __webpack_require__.m = modules; __webpack_require__.c = installedModules; __webpack_require__.d = function (exports, name, getter) { if (!__webpack_require__.o(exports, name)) { Object.defineProperty(exports, name, { configurable: false, enumerable: true, get: getter }); } }; __webpack_require__.n = function (module) { var getter = module && module.__esModule ? function getDefault() { return module['default']; } : function getModuleExports() { return module; }; __webpack_require__.d(getter, 'a', getter); return getter; }; __webpack_require__.o = function (object, property) { return Object.prototype.hasOwnProperty.call(object, property); }; __webpack_require__.p = ""; return __webpack_require__(__webpack_require__.s = 3); })([(function (module, exports, __webpack_require__) { "use strict"; Object.defineProperty(exports, "__esModule", { value: true }); var BitMatrix = (function () { function BitMatrix(data, width) { this.width = width; this.height = data.length / width; this.data = data; } BitMatrix.createEmpty = function (width, height) { return new BitMatrix(new Uint8ClampedArray(width * height), width); }; BitMatrix.prototype.get = function (x, y) { if (x < 0 || x >= this.width || y < 0 || y >= this.height) { return false; } return !!this.data[y * this.width + x]; }; BitMatrix.prototype.set = function (x, y, v) { this.data[y * this.width + x] = v ? 1 : 0; }; BitMatrix.prototype.setRegion = function (left, top, width, height, v) { for (var y = top; y < top + height; y++) { for (var x = left; x < left + width; x++) { this.set(x, y, !!v); } } }; return BitMatrix; }()); exports.BitMatrix = BitMatrix; }), (function (module, exports, __webpack_require__) { "use strict"; Object.defineProperty(exports, "__esModule", { value: true }); var GenericGFPoly_1 = __webpack_require__(2); function addOrSubtractGF(a, b) { return a ^ b; } exports.addOrSubtractGF = addOrSubtractGF; var GenericGF = (function () { function GenericGF(primitive, size, genBase) { this.primitive = primitive; this.size = size; this.generatorBase = genBase; this.expTable = new Array(this.size); this.logTable = new Array(this.size); var x = 1; for (var i = 0; i < this.size; i++) { this.expTable[i] = x; x = x * 2; if (x >= this.size) { x = (x ^ this.primitive) & (this.size - 1); } } for (var i = 0; i < this.size - 1; i++) { this.logTable[this.expTable[i]] = i; } this.zero = new GenericGFPoly_1.default(this, Uint8ClampedArray.from([0])); this.one = new GenericGFPoly_1.default(this, Uint8ClampedArray.from([1])); } GenericGF.prototype.multiply = function (a, b) { if (a === 0 || b === 0) { return 0; } return this.expTable[(this.logTable[a] + this.logTable[b]) % (this.size - 1)]; }; GenericGF.prototype.inverse = function (a) { if (a === 0) { throw new Error("Can't invert 0"); } return this.expTable[this.size - this.logTable[a] - 1]; }; GenericGF.prototype.buildMonomial = function (degree, coefficient) { if (degree < 0) { throw new Error("Invalid monomial degree less than 0"); } if (coefficient === 0) { return this.zero; } var coefficients = new Uint8ClampedArray(degree + 1); coefficients[0] = coefficient; return new GenericGFPoly_1.default(this, coefficients); }; GenericGF.prototype.log = function (a) { if (a === 0) { throw new Error("Can't take log(0)"); } return this.logTable[a]; }; GenericGF.prototype.exp = function (a) { return this.expTable[a]; }; return GenericGF; }()); exports.default = GenericGF; }), (function (module, exports, __webpack_require__) { "use strict"; Object.defineProperty(exports, "__esModule", { value: true }); var GenericGF_1 = __webpack_require__(1); var GenericGFPoly = (function () { function GenericGFPoly(field, coefficients) { if (coefficients.length === 0) { throw new Error("No coefficients."); } this.field = field; var coefficientsLength = coefficients.length; if (coefficientsLength > 1 && coefficients[0] === 0) { var firstNonZero = 1; while (firstNonZero < coefficientsLength && coefficients[firstNonZero] === 0) { firstNonZero++; } if (firstNonZero === coefficientsLength) { this.coefficients = field.zero.coefficients; } else { this.coefficients = new Uint8ClampedArray(coefficientsLength - firstNonZero); for (var i = 0; i < this.coefficients.length; i++) { this.coefficients[i] = coefficients[firstNonZero + i]; } } } else { this.coefficients = coefficients; } } GenericGFPoly.prototype.degree = function () { return this.coefficients.length - 1; }; GenericGFPoly.prototype.isZero = function () { return this.coefficients[0] === 0; }; GenericGFPoly.prototype.getCoefficient = function (degree) { return this.coefficients[this.coefficients.length - 1 - degree]; }; GenericGFPoly.prototype.addOrSubtract = function (other) { var _a; if (this.isZero()) { return other; } if (other.isZero()) { return this; } var smallerCoefficients = this.coefficients; var largerCoefficients = other.coefficients; if (smallerCoefficients.length > largerCoefficients.length) { _a = [largerCoefficients, smallerCoefficients], smallerCoefficients = _a[0], largerCoefficients = _a[1]; } var sumDiff = new Uint8ClampedArray(largerCoefficients.length); var lengthDiff = largerCoefficients.length - smallerCoefficients.length; for (var i = 0; i < lengthDiff; i++) { sumDiff[i] = largerCoefficients[i]; } for (var i = lengthDiff; i < largerCoefficients.length; i++) { sumDiff[i] = GenericGF_1.addOrSubtractGF(smallerCoefficients[i - lengthDiff], largerCoefficients[i]); } return new GenericGFPoly(this.field, sumDiff); }; GenericGFPoly.prototype.multiply = function (scalar) { if (scalar === 0) { return this.field.zero; } if (scalar === 1) { return this; } var size = this.coefficients.length; var product = new Uint8ClampedArray(size); for (var i = 0; i < size; i++) { product[i] = this.field.multiply(this.coefficients[i], scalar); } return new GenericGFPoly(this.field, product); }; GenericGFPoly.prototype.multiplyPoly = function (other) { if (this.isZero() || other.isZero()) { return this.field.zero; } var aCoefficients = this.coefficients; var aLength = aCoefficients.length; var bCoefficients = other.coefficients; var bLength = bCoefficients.length; var product = new Uint8ClampedArray(aLength + bLength - 1); for (var i = 0; i < aLength; i++) { var aCoeff = aCoefficients[i]; for (var j = 0; j < bLength; j++) { product[i + j] = GenericGF_1.addOrSubtractGF(product[i + j], this.field.multiply(aCoeff, bCoefficients[j])); } } return new GenericGFPoly(this.field, product); }; GenericGFPoly.prototype.multiplyByMonomial = function (degree, coefficient) { if (degree < 0) { throw new Error("Invalid degree less than 0"); } if (coefficient === 0) { return this.field.zero; } var size = this.coefficients.length; var product = new Uint8ClampedArray(size + degree); for (var i = 0; i < size; i++) { product[i] = this.field.multiply(this.coefficients[i], coefficient); } return new GenericGFPoly(this.field, product); }; GenericGFPoly.prototype.evaluateAt = function (a) { var result = 0; if (a === 0) { return this.getCoefficient(0); } var size = this.coefficients.length; if (a === 1) { this.coefficients.forEach(function (coefficient) { result = GenericGF_1.addOrSubtractGF(result, coefficient); }); return result; } result = this.coefficients[0]; for (var i = 1; i < size; i++) { result = GenericGF_1.addOrSubtractGF(this.field.multiply(a, result), this.coefficients[i]); } return result; }; return GenericGFPoly; }()); exports.default = GenericGFPoly; }), (function (module, exports, __webpack_require__) { "use strict"; Object.defineProperty(exports, "__esModule", { value: true }); var binarizer_1 = __webpack_require__(4); var decoder_1 = __webpack_require__(5); var extractor_1 = __webpack_require__(11); var locator_1 = __webpack_require__(12); function scan(matrix) { var locations = locator_1.locate(matrix); if (!locations) { return null; } for (var _i = 0, locations_1 = locations; _i < locations_1.length; _i++) { var location_1 = locations_1[_i]; var extracted = extractor_1.extract(matrix, location_1); var decoded = decoder_1.decode(extracted.matrix); if (decoded) { return { binaryData: decoded.bytes, data: decoded.text, chunks: decoded.chunks, version: decoded.version, location: { topRightCorner: extracted.mappingFunction(location_1.dimension, 0), topLeftCorner: extracted.mappingFunction(0, 0), bottomRightCorner: extracted.mappingFunction(location_1.dimension, location_1.dimension), bottomLeftCorner: extracted.mappingFunction(0, location_1.dimension), topRightFinderPattern: location_1.topRight, topLeftFinderPattern: location_1.topLeft, bottomLeftFinderPattern: location_1.bottomLeft, bottomRightAlignmentPattern: location_1.alignmentPattern, }, }; } } return null; } var defaultOptions = { inversionAttempts: "attemptBoth", }; function jsQR(data, width, height, providedOptions) { if (providedOptions === void 0) { providedOptions = {}; } var options = defaultOptions; Object.keys(options || {}).forEach(function (opt) { options[opt] = providedOptions[opt] || options[opt]; }); var shouldInvert = options.inversionAttempts === "attemptBoth" || options.inversionAttempts === "invertFirst"; var tryInvertedFirst = options.inversionAttempts === "onlyInvert" || options.inversionAttempts === "invertFirst"; var _a = binarizer_1.binarize(data, width, height, shouldInvert), binarized = _a.binarized, inverted = _a.inverted; var result = scan(tryInvertedFirst ? inverted : binarized); if (!result && (options.inversionAttempts === "attemptBoth" || options.inversionAttempts === "invertFirst")) { result = scan(tryInvertedFirst ? binarized : inverted); } return result; } jsQR.default = jsQR; exports.default = jsQR; }), (function (module, exports, __webpack_require__) { "use strict"; Object.defineProperty(exports, "__esModule", { value: true }); var BitMatrix_1 = __webpack_require__(0); var REGION_SIZE = 8; var MIN_DYNAMIC_RANGE = 24; function numBetween(value, min, max) { return value < min ? min : value > max ? max : value; } var Matrix = (function () { function Matrix(width, height) { this.width = width; this.data = new Uint8ClampedArray(width * height); } Matrix.prototype.get = function (x, y) { return this.data[y * this.width + x]; }; Matrix.prototype.set = function (x, y, value) { this.data[y * this.width + x] = value; }; return Matrix; }()); function binarize(data, width, height, returnInverted) { if (data.length !== width * height * 4) { throw new Error("Malformed data passed to binarizer."); } var greyscalePixels = new Matrix(width, height); for (var x = 0; x < width; x++) { for (var y = 0; y < height; y++) { var r = data[((y * width + x) * 4) + 0]; var g = data[((y * width + x) * 4) + 1]; var b = data[((y * width + x) * 4) + 2]; greyscalePixels.set(x, y, 0.2126 * r + 0.7152 * g + 0.0722 * b); } } var horizontalRegionCount = Math.ceil(width / REGION_SIZE); var verticalRegionCount = Math.ceil(height / REGION_SIZE); var blackPoints = new Matrix(horizontalRegionCount, verticalRegionCount); for (var verticalRegion = 0; verticalRegion < verticalRegionCount; verticalRegion++) { for (var hortizontalRegion = 0; hortizontalRegion < horizontalRegionCount; hortizontalRegion++) { var sum = 0; var min = Infinity; var max = 0; for (var y = 0; y < REGION_SIZE; y++) { for (var x = 0; x < REGION_SIZE; x++) { var pixelLumosity = greyscalePixels.get(hortizontalRegion * REGION_SIZE + x, verticalRegion * REGION_SIZE + y); sum += pixelLumosity; min = Math.min(min, pixelLumosity); max = Math.max(max, pixelLumosity); } } var average = sum / (Math.pow(REGION_SIZE, 2)); if (max - min <= MIN_DYNAMIC_RANGE) { average = min / 2; if (verticalRegion > 0 && hortizontalRegion > 0) { var averageNeighborBlackPoint = (blackPoints.get(hortizontalRegion, verticalRegion - 1) + (2 * blackPoints.get(hortizontalRegion - 1, verticalRegion)) + blackPoints.get(hortizontalRegion - 1, verticalRegion - 1)) / 4; if (min < averageNeighborBlackPoint) { average = averageNeighborBlackPoint; } } } blackPoints.set(hortizontalRegion, verticalRegion, average); } } var binarized = BitMatrix_1.BitMatrix.createEmpty(width, height); var inverted = null; if (returnInverted) { inverted = BitMatrix_1.BitMatrix.createEmpty(width, height); } for (var verticalRegion = 0; verticalRegion < verticalRegionCount; verticalRegion++) { for (var hortizontalRegion = 0; hortizontalRegion < horizontalRegionCount; hortizontalRegion++) { var left = numBetween(hortizontalRegion, 2, horizontalRegionCount - 3); var top_1 = numBetween(verticalRegion, 2, verticalRegionCount - 3); var sum = 0; for (var xRegion = -2; xRegion <= 2; xRegion++) { for (var yRegion = -2; yRegion <= 2; yRegion++) { sum += blackPoints.get(left + xRegion, top_1 + yRegion); } } var threshold = sum / 25; for (var xRegion = 0; xRegion < REGION_SIZE; xRegion++) { for (var yRegion = 0; yRegion < REGION_SIZE; yRegion++) { var x = hortizontalRegion * REGION_SIZE + xRegion; var y = verticalRegion * REGION_SIZE + yRegion; var lum = greyscalePixels.get(x, y); binarized.set(x, y, lum <= threshold); if (returnInverted) { inverted.set(x, y, !(lum <= threshold)); } } } } } if (returnInverted) { return { binarized: binarized, inverted: inverted }; } return { binarized: binarized }; } exports.binarize = binarize; }), (function (module, exports, __webpack_require__) { "use strict"; Object.defineProperty(exports, "__esModule", { value: true }); var BitMatrix_1 = __webpack_require__(0); var decodeData_1 = __webpack_require__(6); var reedsolomon_1 = __webpack_require__(9); var version_1 = __webpack_require__(10); function numBitsDiffering(x, y) { var z = x ^ y; var bitCount = 0; while (z) { bitCount++; z &= z - 1; } return bitCount; } function pushBit(bit, byte) { return (byte << 1) | bit; } var FORMAT_INFO_TABLE = [{ bits: 0x5412, formatInfo: { errorCorrectionLevel: 1, dataMask: 0 } }, { bits: 0x5125, formatInfo: { errorCorrectionLevel: 1, dataMask: 1 } }, { bits: 0x5E7C, formatInfo: { errorCorrectionLevel: 1, dataMask: 2 } }, { bits: 0x5B4B, formatInfo: { errorCorrectionLevel: 1, dataMask: 3 } }, { bits: 0x45F9, formatInfo: { errorCorrectionLevel: 1, dataMask: 4 } }, { bits: 0x40CE, formatInfo: { errorCorrectionLevel: 1, dataMask: 5 } }, { bits: 0x4F97, formatInfo: { errorCorrectionLevel: 1, dataMask: 6 } }, { bits: 0x4AA0, formatInfo: { errorCorrectionLevel: 1, dataMask: 7 } }, { bits: 0x77C4, formatInfo: { errorCorrectionLevel: 0, dataMask: 0 } }, { bits: 0x72F3, formatInfo: { errorCorrectionLevel: 0, dataMask: 1 } }, { bits: 0x7DAA, formatInfo: { errorCorrectionLevel: 0, dataMask: 2 } }, { bits: 0x789D, formatInfo: { errorCorrectionLevel: 0, dataMask: 3 } }, { bits: 0x662F, formatInfo: { errorCorrectionLevel: 0, dataMask: 4 } }, { bits: 0x6318, formatInfo: { errorCorrectionLevel: 0, dataMask: 5 } }, { bits: 0x6C41, formatInfo: { errorCorrectionLevel: 0, dataMask: 6 } }, { bits: 0x6976, formatInfo: { errorCorrectionLevel: 0, dataMask: 7 } }, { bits: 0x1689, formatInfo: { errorCorrectionLevel: 3, dataMask: 0 } }, { bits: 0x13BE, formatInfo: { errorCorrectionLevel: 3, dataMask: 1 } }, { bits: 0x1CE7, formatInfo: { errorCorrectionLevel: 3, dataMask: 2 } }, { bits: 0x19D0, formatInfo: { errorCorrectionLevel: 3, dataMask: 3 } }, { bits: 0x0762, formatInfo: { errorCorrectionLevel: 3, dataMask: 4 } }, { bits: 0x0255, formatInfo: { errorCorrectionLevel: 3, dataMask: 5 } }, { bits: 0x0D0C, formatInfo: { errorCorrectionLevel: 3, dataMask: 6 } }, { bits: 0x083B, formatInfo: { errorCorrectionLevel: 3, dataMask: 7 } }, { bits: 0x355F, formatInfo: { errorCorrectionLevel: 2, dataMask: 0 } }, { bits: 0x3068, formatInfo: { errorCorrectionLevel: 2, dataMask: 1 } }, { bits: 0x3F31, formatInfo: { errorCorrectionLevel: 2, dataMask: 2 } }, { bits: 0x3A06, formatInfo: { errorCorrectionLevel: 2, dataMask: 3 } }, { bits: 0x24B4, formatInfo: { errorCorrectionLevel: 2, dataMask: 4 } }, { bits: 0x2183, formatInfo: { errorCorrectionLevel: 2, dataMask: 5 } }, { bits: 0x2EDA, formatInfo: { errorCorrectionLevel: 2, dataMask: 6 } }, { bits: 0x2BED, formatInfo: { errorCorrectionLevel: 2, dataMask: 7 } },]; var DATA_MASKS = [function (p) { return ((p.y + p.x) % 2) === 0; }, function (p) { return (p.y % 2) === 0; }, function (p) { return p.x % 3 === 0; }, function (p) { return (p.y + p.x) % 3 === 0; }, function (p) { return (Math.floor(p.y / 2) + Math.floor(p.x / 3)) % 2 === 0; }, function (p) { return ((p.x * p.y) % 2) + ((p.x * p.y) % 3) === 0; }, function (p) { return ((((p.y * p.x) % 2) + (p.y * p.x) % 3) % 2) === 0; }, function (p) { return ((((p.y + p.x) % 2) + (p.y * p.x) % 3) % 2) === 0; },]; function buildFunctionPatternMask(version) { var dimension = 17 + 4 * version.versionNumber; var matrix = BitMatrix_1.BitMatrix.createEmpty(dimension, dimension); matrix.setRegion(0, 0, 9, 9, true); matrix.setRegion(dimension - 8, 0, 8, 9, true); matrix.setRegion(0, dimension - 8, 9, 8, true); for (var _i = 0, _a = version.alignmentPatternCenters; _i < _a.length; _i++) { var x = _a[_i]; for (var _b = 0, _c = version.alignmentPatternCenters; _b < _c.length; _b++) { var y = _c[_b]; if (!(x === 6 && y === 6 || x === 6 && y === dimension - 7 || x === dimension - 7 && y === 6)) { matrix.setRegion(x - 2, y - 2, 5, 5, true); } } } matrix.setRegion(6, 9, 1, dimension - 17, true); matrix.setRegion(9, 6, dimension - 17, 1, true); if (version.versionNumber > 6) { matrix.setRegion(dimension - 11, 0, 3, 6, true); matrix.setRegion(0, dimension - 11, 6, 3, true); } return matrix; } function readCodewords(matrix, version, formatInfo) { var dataMask = DATA_MASKS[formatInfo.dataMask]; var dimension = matrix.height; var functionPatternMask = buildFunctionPatternMask(version); var codewords = []; var currentByte = 0; var bitsRead = 0; var readingUp = true; for (var columnIndex = dimension - 1; columnIndex > 0; columnIndex -= 2) { if (columnIndex === 6) { columnIndex--; } for (var i = 0; i < dimension; i++) { var y = readingUp ? dimension - 1 - i : i; for (var columnOffset = 0; columnOffset < 2; columnOffset++) { var x = columnIndex - columnOffset; if (!functionPatternMask.get(x, y)) { bitsRead++; var bit = matrix.get(x, y); if (dataMask({ y: y, x: x })) { bit = !bit; } currentByte = pushBit(bit, currentByte); if (bitsRead === 8) { codewords.push(currentByte); bitsRead = 0; currentByte = 0; } } } } readingUp = !readingUp; } return codewords; } function readVersion(matrix) { var dimension = matrix.height; var provisionalVersion = Math.floor((dimension - 17) / 4); if (provisionalVersion <= 6) { return version_1.VERSIONS[provisionalVersion - 1]; } var topRightVersionBits = 0; for (var y = 5; y >= 0; y--) { for (var x = dimension - 9; x >= dimension - 11; x--) { topRightVersionBits = pushBit(matrix.get(x, y), topRightVersionBits); } } var bottomLeftVersionBits = 0; for (var x = 5; x >= 0; x--) { for (var y = dimension - 9; y >= dimension - 11; y--) { bottomLeftVersionBits = pushBit(matrix.get(x, y), bottomLeftVersionBits); } } var bestDifference = Infinity; var bestVersion; for (var _i = 0, VERSIONS_1 = version_1.VERSIONS; _i < VERSIONS_1.length; _i++) { var version = VERSIONS_1[_i]; if (version.infoBits === topRightVersionBits || version.infoBits === bottomLeftVersionBits) { return version; } var difference = numBitsDiffering(topRightVersionBits, version.infoBits); if (difference < bestDifference) { bestVersion = version; bestDifference = difference; } difference = numBitsDiffering(bottomLeftVersionBits, version.infoBits); if (difference < bestDifference) { bestVersion = version; bestDifference = difference; } } if (bestDifference <= 3) { return bestVersion; } } function readFormatInformation(matrix) { var topLeftFormatInfoBits = 0; for (var x = 0; x <= 8; x++) { if (x !== 6) { topLeftFormatInfoBits = pushBit(matrix.get(x, 8), topLeftFormatInfoBits); } } for (var y = 7; y >= 0; y--) { if (y !== 6) { topLeftFormatInfoBits = pushBit(matrix.get(8, y), topLeftFormatInfoBits); } } var dimension = matrix.height; var topRightBottomRightFormatInfoBits = 0; for (var y = dimension - 1; y >= dimension - 7; y--) { topRightBottomRightFormatInfoBits = pushBit(matrix.get(8, y), topRightBottomRightFormatInfoBits); } for (var x = dimension - 8; x < dimension; x++) { topRightBottomRightFormatInfoBits = pushBit(matrix.get(x, 8), topRightBottomRightFormatInfoBits); } var bestDifference = Infinity; var bestFormatInfo = null; for (var _i = 0, FORMAT_INFO_TABLE_1 = FORMAT_INFO_TABLE; _i < FORMAT_INFO_TABLE_1.length; _i++) { var _a = FORMAT_INFO_TABLE_1[_i], bits = _a.bits, formatInfo = _a.formatInfo; if (bits === topLeftFormatInfoBits || bits === topRightBottomRightFormatInfoBits) { return formatInfo; } var difference = numBitsDiffering(topLeftFormatInfoBits, bits); if (difference < bestDifference) { bestFormatInfo = formatInfo; bestDifference = difference; } if (topLeftFormatInfoBits !== topRightBottomRightFormatInfoBits) { difference = numBitsDiffering(topRightBottomRightFormatInfoBits, bits); if (difference < bestDifference) { bestFormatInfo = formatInfo; bestDifference = difference; } } } if (bestDifference <= 3) { return bestFormatInfo; } return null; } function getDataBlocks(codewords, version, ecLevel) { var ecInfo = version.errorCorrectionLevels[ecLevel]; var dataBlocks = []; var totalCodewords = 0; ecInfo.ecBlocks.forEach(function (block) { for (var i = 0; i < block.numBlocks; i++) { dataBlocks.push({ numDataCodewords: block.dataCodewordsPerBlock, codewords: [] }); totalCodewords += block.dataCodewordsPerBlock + ecInfo.ecCodewordsPerBlock; } }); if (codewords.length < totalCodewords) { return null; } codewords = codewords.slice(0, totalCodewords); var shortBlockSize = ecInfo.ecBlocks[0].dataCodewordsPerBlock; for (var i = 0; i < shortBlockSize; i++) { for (var _i = 0, dataBlocks_1 = dataBlocks; _i < dataBlocks_1.length; _i++) { var dataBlock = dataBlocks_1[_i]; dataBlock.codewords.push(codewords.shift()); } } if (ecInfo.ecBlocks.length > 1) { var smallBlockCount = ecInfo.ecBlocks[0].numBlocks; var largeBlockCount = ecInfo.ecBlocks[1].numBlocks; for (var i = 0; i < largeBlockCount; i++) { dataBlocks[smallBlockCount + i].codewords.push(codewords.shift()); } } while (codewords.length > 0) { for (var _a = 0, dataBlocks_2 = dataBlocks; _a < dataBlocks_2.length; _a++) { var dataBlock = dataBlocks_2[_a]; dataBlock.codewords.push(codewords.shift()); } } return dataBlocks; } function decodeMatrix(matrix) { var version = readVersion(matrix); if (!version) { return null; } var formatInfo = readFormatInformation(matrix); if (!formatInfo) { return null; } var codewords = readCodewords(matrix, version, formatInfo); var dataBlocks = getDataBlocks(codewords, version, formatInfo.errorCorrectionLevel); if (!dataBlocks) { return null; } var totalBytes = dataBlocks.reduce(function (a, b) { return a + b.numDataCodewords; }, 0); var resultBytes = new Uint8ClampedArray(totalBytes); var resultIndex = 0; for (var _i = 0, dataBlocks_3 = dataBlocks; _i < dataBlocks_3.length; _i++) { var dataBlock = dataBlocks_3[_i]; var correctedBytes = reedsolomon_1.decode(dataBlock.codewords, dataBlock.codewords.length - dataBlock.numDataCodewords); if (!correctedBytes) { return null; } for (var i = 0; i < dataBlock.numDataCodewords; i++) { resultBytes[resultIndex++] = correctedBytes[i]; } } try { return decodeData_1.decode(resultBytes, version.versionNumber); } catch (_a) { return null; } } function decode(matrix) { if (matrix == null) { return null; } var result = decodeMatrix(matrix); if (result) { return result; } for (var x = 0; x < matrix.width; x++) { for (var y = x + 1; y < matrix.height; y++) { if (matrix.get(x, y) !== matrix.get(y, x)) { matrix.set(x, y, !matrix.get(x, y)); matrix.set(y, x, !matrix.get(y, x)); } } } return decodeMatrix(matrix); } exports.decode = decode; }), (function (module, exports, __webpack_require__) { "use strict"; Object.defineProperty(exports, "__esModule", { value: true }); var BitStream_1 = __webpack_require__(7); var Mode; (function (Mode) { Mode["Numeric"] = "numeric"; Mode["Alphanumeric"] = "alphanumeric"; Mode["Byte"] = "byte"; Mode["ECI"] = "eci"; })(Mode = exports.Mode || (exports.Mode = {})); var ModeByte; (function (ModeByte) { ModeByte[ModeByte["Terminator"] = 0] = "Terminator"; ModeByte[ModeByte["Numeric"] = 1] = "Numeric"; ModeByte[ModeByte["Alphanumeric"] = 2] = "Alphanumeric"; ModeByte[ModeByte["Byte"] = 4] = "Byte"; ModeByte[ModeByte["ECI"] = 7] = "ECI"; })(ModeByte || (ModeByte = {})); function decodeNumeric(stream, size) { var bytes = []; var text = ""; var characterCountSize = [10, 12, 14][size]; var length = stream.readBits(characterCountSize); while (length >= 3) { var num = stream.readBits(10); if (num >= 1000) { throw new Error("Invalid numeric value above 999"); } var a = Math.floor(num / 100); var b = Math.floor(num / 10) % 10; var c = num % 10; bytes.push(48 + a, 48 + b, 48 + c); text += a.toString() + b.toString() + c.toString(); length -= 3; } if (length === 2) { var num = stream.readBits(7); if (num >= 100) { throw new Error("Invalid numeric value above 99"); } var a = Math.floor(num / 10); var b = num % 10; bytes.push(48 + a, 48 + b); text += a.toString() + b.toString(); } else if (length === 1) { var num = stream.readBits(4); if (num >= 10) { throw new Error("Invalid numeric value above 9"); } bytes.push(48 + num); text += num.toString(); } return { bytes: bytes, text: text }; } var AlphanumericCharacterCodes = ["0", "1", "2", "3", "4", "5", "6", "7", "8", "9", "A", "B", "C", "D", "E", "F", "G", "H", "I", "J", "K", "L", "M", "N", "O", "P", "Q", "R", "S", "T", "U", "V", "W", "X", "Y", "Z", " ", "$", "%", "*", "+", "-", ".", "/", ":",]; function decodeAlphanumeric(stream, size) { var bytes = []; var text = ""; var characterCountSize = [9, 11, 13][size]; var length = stream.readBits(characterCountSize); while (length >= 2) { var v = stream.readBits(11); var a = Math.floor(v / 45); var b = v % 45; bytes.push(AlphanumericCharacterCodes[a].charCodeAt(0), AlphanumericCharacterCodes[b].charCodeAt(0)); text += AlphanumericCharacterCodes[a] + AlphanumericCharacterCodes[b]; length -= 2; } if (length === 1) { var a = stream.readBits(6); bytes.push(AlphanumericCharacterCodes[a].charCodeAt(0)); text += AlphanumericCharacterCodes[a]; } return { bytes: bytes, text: text }; } function decodeByte(stream, size) { var bytes = []; var text = ""; var characterCountSize = [8, 16, 16][size]; var length = stream.readBits(characterCountSize); for (var i = 0; i < length; i++) { var b = stream.readBits(8); bytes.push(b); } try { text += decodeURIComponent(bytes.map(function (b) { return "%" + ("0" + b.toString(16)).substr(-2); }).join("")); } catch (_a) { } return { bytes: bytes, text: text }; } function decode(data, version) { var _a, _b, _c; var stream = new BitStream_1.BitStream(data); var size = version <= 9 ? 0 : version <= 26 ? 1 : 2; var result = { text: "", bytes: [], chunks: [], version: version, }; while (stream.available() >= 4) { var mode = stream.readBits(4); if (mode === ModeByte.Terminator) { return result; } else if (mode === ModeByte.ECI) { if (stream.readBits(1) === 0) { result.chunks.push({ type: Mode.ECI, assignmentNumber: stream.readBits(7), }); } else if (stream.readBits(1) === 0) { result.chunks.push({ type: Mode.ECI, assignmentNumber: stream.readBits(14), }); } else if (stream.readBits(1) === 0) { result.chunks.push({ type: Mode.ECI, assignmentNumber: stream.readBits(21), }); } else { result.chunks.push({ type: Mode.ECI, assignmentNumber: -1, }); } } else if (mode === ModeByte.Numeric) { var numericResult = decodeNumeric(stream, size); result.text += numericResult.text; (_a = result.bytes).push.apply(_a, numericResult.bytes); result.chunks.push({ type: Mode.Numeric, text: numericResult.text, }); } else if (mode === ModeByte.Alphanumeric) { var alphanumericResult = decodeAlphanumeric(stream, size); result.text += alphanumericResult.text; (_b = result.bytes).push.apply(_b, alphanumericResult.bytes); result.chunks.push({ type: Mode.Alphanumeric, text: alphanumericResult.text, }); } else if (mode === ModeByte.Byte) { var byteResult = decodeByte(stream, size); result.text += byteResult.text; (_c = result.bytes).push.apply(_c, byteResult.bytes); result.chunks.push({ type: Mode.Byte, bytes: byteResult.bytes, text: byteResult.text, }); } } if (stream.available() === 0 || stream.readBits(stream.available()) === 0) { return result; } } exports.decode = decode; }), (function (module, exports, __webpack_require__) { "use strict"; Object.defineProperty(exports, "__esModule", { value: true }); var BitStream = (function () { function BitStream(bytes) { this.byteOffset = 0; this.bitOffset = 0; this.bytes = bytes; } BitStream.prototype.readBits = function (numBits) { if (numBits < 1 || numBits > 32 || numBits > this.available()) { throw new Error("Cannot read " + numBits.toString() + " bits"); } var result = 0; if (this.bitOffset > 0) { var bitsLeft = 8 - this.bitOffset; var toRead = numBits < bitsLeft ? numBits : bitsLeft; var bitsToNotRead = bitsLeft - toRead; var mask = (0xFF >> (8 - toRead)) << bitsToNotRead; result = (this.bytes[this.byteOffset] & mask) >> bitsToNotRead; numBits -= toRead; this.bitOffset += toRead; if (this.bitOffset === 8) { this.bitOffset = 0; this.byteOffset++; } } if (numBits > 0) { while (numBits >= 8) { result = (result << 8) | (this.bytes[this.byteOffset] & 0xFF); this.byteOffset++; numBits -= 8; } if (numBits > 0) { var bitsToNotRead = 8 - numBits; var mask = (0xFF >> bitsToNotRead) << bitsToNotRead; result = (result << numBits) | ((this.bytes[this.byteOffset] & mask) >> bitsToNotRead); this.bitOffset += numBits; } } return result; }; BitStream.prototype.available = function () { return 8 * (this.bytes.length - this.byteOffset) - this.bitOffset; }; return BitStream; }()); exports.BitStream = BitStream; }), (function (module, exports, __webpack_require__) { "use strict"; Object.defineProperty(exports, "__esModule", { value: true }); }), (function (module, exports, __webpack_require__) { "use strict"; Object.defineProperty(exports, "__esModule", { value: true }); var GenericGF_1 = __webpack_require__(1); var GenericGFPoly_1 = __webpack_require__(2); function runEuclideanAlgorithm(field, a, b, R) { var _a; if (a.degree() < b.degree()) { _a = [b, a], a = _a[0], b = _a[1]; } var rLast = a; var r = b; var tLast = field.zero; var t = field.one; while (r.degree() >= R / 2) { var rLastLast = rLast; var tLastLast = tLast; rLast = r; tLast = t; if (rLast.isZero()) { return null; } r = rLastLast; var q = field.zero; var denominatorLeadingTerm = rLast.getCoefficient(rLast.degree()); var dltInverse = field.inverse(denominatorLeadingTerm); while (r.degree() >= rLast.degree() && !r.isZero()) { var degreeDiff = r.degree() - rLast.degree(); var scale = field.multiply(r.getCoefficient(r.degree()), dltInverse); q = q.addOrSubtract(field.buildMonomial(degreeDiff, scale)); r = r.addOrSubtract(rLast.multiplyByMonomial(degreeDiff, scale)); } t = q.multiplyPoly(tLast).addOrSubtract(tLastLast); if (r.degree() >= rLast.degree()) { return null; } } var sigmaTildeAtZero = t.getCoefficient(0); if (sigmaTildeAtZero === 0) { return null; } var inverse = field.inverse(sigmaTildeAtZero); return [t.multiply(inverse), r.multiply(inverse)]; } function findErrorLocations(field, errorLocator) { var numErrors = errorLocator.degree(); if (numErrors === 1) { return [errorLocator.getCoefficient(1)]; } var result = new Array(numErrors); var errorCount = 0; for (var i = 1; i < field.size && errorCount < numErrors; i++) { if (errorLocator.evaluateAt(i) === 0) { result[errorCount] = field.inverse(i); errorCount++; } } if (errorCount !== numErrors) { return null; } return result; } function findErrorMagnitudes(field, errorEvaluator, errorLocations) { var s = errorLocations.length; var result = new Array(s); for (var i = 0; i < s; i++) { var xiInverse = field.inverse(errorLocations[i]); var denominator = 1; for (var j = 0; j < s; j++) { if (i !== j) { denominator = field.multiply(denominator, GenericGF_1.addOrSubtractGF(1, field.multiply(errorLocations[j], xiInverse))); } } result[i] = field.multiply(errorEvaluator.evaluateAt(xiInverse), field.inverse(denominator)); if (field.generatorBase !== 0) { result[i] = field.multiply(result[i], xiInverse); } } return result; } function decode(bytes, twoS) { var outputBytes = new Uint8ClampedArray(bytes.length); outputBytes.set(bytes); var field = new GenericGF_1.default(0x011D, 256, 0); var poly = new GenericGFPoly_1.default(field, outputBytes); var syndromeCoefficients = new Uint8ClampedArray(twoS); var error = false; for (var s = 0; s < twoS; s++) { var evaluation = poly.evaluateAt(field.exp(s + field.generatorBase)); syndromeCoefficients[syndromeCoefficients.length - 1 - s] = evaluation; if (evaluation !== 0) { error = true; } } if (!error) { return outputBytes; } var syndrome = new GenericGFPoly_1.default(field, syndromeCoefficients); var sigmaOmega = runEuclideanAlgorithm(field, field.buildMonomial(twoS, 1), syndrome, twoS); if (sigmaOmega === null) { return null; } var errorLocations = findErrorLocations(field, sigmaOmega[0]); if (errorLocations == null) { return null; } var errorMagnitudes = findErrorMagnitudes(field, sigmaOmega[1], errorLocations); for (var i = 0; i < errorLocations.length; i++) { var position = outputBytes.length - 1 - field.log(errorLocations[i]); if (position < 0) { return null; } outputBytes[position] = GenericGF_1.addOrSubtractGF(outputBytes[position], errorMagnitudes[i]); } return outputBytes; } exports.decode = decode; }), (function (module, exports, __webpack_require__) { "use strict"; Object.defineProperty(exports, "__esModule", { value: true }); exports.VERSIONS = [{ infoBits: null, versionNumber: 1, alignmentPatternCenters: [], errorCorrectionLevels: [{ ecCodewordsPerBlock: 7, ecBlocks: [{ numBlocks: 1, dataCodewordsPerBlock: 19 }], }, { ecCodewordsPerBlock: 10, ecBlocks: [{ numBlocks: 1, dataCodewordsPerBlock: 16 }], }, { ecCodewordsPerBlock: 13, ecBlocks: [{ numBlocks: 1, dataCodewordsPerBlock: 13 }], }, { ecCodewordsPerBlock: 17, ecBlocks: [{ numBlocks: 1, dataCodewordsPerBlock: 9 }], },], }, { infoBits: null, versionNumber: 2, alignmentPatternCenters: [6, 18], errorCorrectionLevels: [{ ecCodewordsPerBlock: 10, ecBlocks: [{ numBlocks: 1, dataCodewordsPerBlock: 34 }], }, { ecCodewordsPerBlock: 16, ecBlocks: [{ numBlocks: 1, dataCodewordsPerBlock: 28 }], }, { ecCodewordsPerBlock: 22, ecBlocks: [{ numBlocks: 1, dataCodewordsPerBlock: 22 }], }, { ecCodewordsPerBlock: 28, ecBlocks: [{ numBlocks: 1, dataCodewordsPerBlock: 16 }], },], }, { infoBits: null, versionNumber: 3, alignmentPatternCenters: [6, 22], errorCorrectionLevels: [{ ecCodewordsPerBlock: 15, ecBlocks: [{ numBlocks: 1, dataCodewordsPerBlock: 55 }], }, { ecCodewordsPerBlock: 26, ecBlocks: [{ numBlocks: 1, dataCodewordsPerBlock: 44 }], }, { ecCodewordsPerBlock: 18, ecBlocks: [{ numBlocks: 2, dataCodewordsPerBlock: 17 }], }, { ecCodewordsPerBlock: 22, ecBlocks: [{ numBlocks: 2, dataCodewordsPerBlock: 13 }], },], }, { infoBits: null, versionNumber: 4, alignmentPatternCenters: [6, 26], errorCorrectionLevels: [{ ecCodewordsPerBlock: 20, ecBlocks: [{ numBlocks: 1, dataCodewordsPerBlock: 80 }], }, { ecCodewordsPerBlock: 18, ecBlocks: [{ numBlocks: 2, dataCodewordsPerBlock: 32 }], }, { ecCodewordsPerBlock: 26, ecBlocks: [{ numBlocks: 2, dataCodewordsPerBlock: 24 }], }, { ecCodewordsPerBlock: 16, ecBlocks: [{ numBlocks: 4, dataCodewordsPerBlock: 9 }], },], }, { infoBits: null, versionNumber: 5, alignmentPatternCenters: [6, 30], errorCorrectionLevels: [{ ecCodewordsPerBlock: 26, ecBlocks: [{ numBlocks: 1, dataCodewordsPerBlock: 108 }], }, { ecCodewordsPerBlock: 24, ecBlocks: [{ numBlocks: 2, dataCodewordsPerBlock: 43 }], }, { ecCodewordsPerBlock: 18, ecBlocks: [{ numBlocks: 2, dataCodewordsPerBlock: 15 }, { numBlocks: 2, dataCodewordsPerBlock: 16 },], }, { ecCodewordsPerBlock: 22, ecBlocks: [{ numBlocks: 2, dataCodewordsPerBlock: 11 }, { numBlocks: 2, dataCodewordsPerBlock: 12 },], },], }, { infoBits: null, versionNumber: 6, alignmentPatternCenters: [6, 34], errorCorrectionLevels: [{ ecCodewordsPerBlock: 18, ecBlocks: [{ numBlocks: 2, dataCodewordsPerBlock: 68 }], }, { ecCodewordsPerBlock: 16, ecBlocks: [{ numBlocks: 4, dataCodewordsPerBlock: 27 }], }, { ecCodewordsPerBlock: 24, ecBlocks: [{ numBlocks: 4, dataCodewordsPerBlock: 19 }], }, { ecCodewordsPerBlock: 28, ecBlocks: [{ numBlocks: 4, dataCodewordsPerBlock: 15 }], },], }, { infoBits: 0x07C94, versionNumber: 7, alignmentPatternCenters: [6, 22, 38], errorCorrectionLevels: [{ ecCodewordsPerBlock: 20, ecBlocks: [{ numBlocks: 2, dataCodewordsPerBlock: 78 }], }, { ecCodewordsPerBlock: 18, ecBlocks: [{ numBlocks: 4, dataCodewordsPerBlock: 31 }], }, { ecCodewordsPerBlock: 18, ecBlocks: [{ numBlocks: 2, dataCodewordsPerBlock: 14 }, { numBlocks: 4, dataCodewordsPerBlock: 15 },], }, { ecCodewordsPerBlock: 26, ecBlocks: [{ numBlocks: 4, dataCodewordsPerBlock: 13 }, { numBlocks: 1, dataCodewordsPerBlock: 14 },], },], }, { infoBits: 0x085BC, versionNumber: 8, alignmentPatternCenters: [6, 24, 42], errorCorrectionLevels: [{ ecCodewordsPerBlock: 24, ecBlocks: [{ numBlocks: 2, dataCodewordsPerBlock: 97 }], }, { ecCodewordsPerBlock: 22, ecBlocks: [{ numBlocks: 2, dataCodewordsPerBlock: 38 }, { numBlocks: 2, dataCodewordsPerBlock: 39 },], }, { ecCodewordsPerBlock: 22, ecBlocks: [{ numBlocks: 4, dataCodewordsPerBlock: 18 }, { numBlocks: 2, dataCodewordsPerBlock: 19 },], }, { ecCodewordsPerBlock: 26, ecBlocks: [{ numBlocks: 4, dataCodewordsPerBlock: 14 }, { numBlocks: 2, dataCodewordsPerBlock: 15 },], },], }, { infoBits: 0x09A99, versionNumber: 9, alignmentPatternCenters: [6, 26, 46], errorCorrectionLevels: [{ ecCodewordsPerBlock: 30, ecBlocks: [{ numBlocks: 2, dataCodewordsPerBlock: 116 }], }, { ecCodewordsPerBlock: 22, ecBlocks: [{ numBlocks: 3, dataCodewordsPerBlock: 36 }, { numBlocks: 2, dataCodewordsPerBlock: 37 },], }, { ecCodewordsPerBlock: 20, ecBlocks: [{ numBlocks: 4, dataCodewordsPerBlock: 16 }, { numBlocks: 4, dataCodewordsPerBlock: 17 },], }, { ecCodewordsPerBlock: 24, ecBlocks: [{ numBlocks: 4, dataCodewordsPerBlock: 12 }, { numBlocks: 4, dataCodewordsPerBlock: 13 },], },], }, { infoBits: 0x0A4D3, versionNumber: 10, alignmentPatternCenters: [6, 28, 50], errorCorrectionLevels: [{ ecCodewordsPerBlock: 18, ecBlocks: [{ numBlocks: 2, dataCodewordsPerBlock: 68 }, { numBlocks: 2, dataCodewordsPerBlock: 69 },], }, { ecCodewordsPerBlock: 26, ecBlocks: [{ numBlocks: 4, dataCodewordsPerBlock: 43 }, { numBlocks: 1, dataCodewordsPerBlock: 44 },], }, { ecCodewordsPerBlock: 24, ecBlocks: [{ numBlocks: 6, dataCodewordsPerBlock: 19 }, { numBlocks: 2, dataCodewordsPerBlock: 20 },], }, { ecCodewordsPerBlock: 28, ecBlocks: [{ numBlocks: 6, dataCodewordsPerBlock: 15 }, { numBlocks: 2, dataCodewordsPerBlock: 16 },], },], }, { infoBits: 0x0BBF6, versionNumber: 11, alignmentPatternCenters: [6, 30, 54], errorCorrectionLevels: [{ ecCodewordsPerBlock: 20, ecBlocks: [{ numBlocks: 4, dataCodewordsPerBlock: 81 }], }, { ecCodewordsPerBlock: 30, ecBlocks: [{ numBlocks: 1, dataCodewordsPerBlock: 50 }, { numBlocks: 4, dataCodewordsPerBlock: 51 },], }, { ecCodewordsPerBlock: 28, ecBlocks: [{ numBlocks: 4, dataCodewordsPerBlock: 22 }, { numBlocks: 4, dataCodewordsPerBlock: 23 },], }, { ecCodewordsPerBlock: 24, ecBlocks: [{ numBlocks: 3, dataCodewordsPerBlock: 12 }, { numBlocks: 8, dataCodewordsPerBlock: 13 },], },], }, { infoBits: 0x0C762, versionNumber: 12, alignmentPatternCenters: [6, 32, 58], errorCorrectionLevels: [{ ecCodewordsPerBlock: 24, ecBlocks: [{ numBlocks: 2, dataCodewordsPerBlock: 92 }, { numBlocks: 2, dataCodewordsPerBlock: 93 },], }, { ecCodewordsPerBlock: 22, ecBlocks: [{ numBlocks: 6, dataCodewordsPerBlock: 36 }, { numBlocks: 2, dataCodewordsPerBlock: 37 },], }, { ecCodewordsPerBlock: 26, ecBlocks: [{ numBlocks: 4, dataCodewordsPerBlock: 20 }, { numBlocks: 6, dataCodewordsPerBlock: 21 },], }, { ecCodewordsPerBlock: 28, ecBlocks: [{ numBlocks: 7, dataCodewordsPerBlock: 14 }, { numBlocks: 4, dataCodewordsPerBlock: 15 },], },], }, { infoBits: 0x0D847, versionNumber: 13, alignmentPatternCenters: [6, 34, 62], errorCorrectionLevels: [{ ecCodewordsPerBlock: 26, ecBlocks: [{ numBlocks: 4, dataCodewordsPerBlock: 107 }], }, { ecCodewordsPerBlock: 22, ecBlocks: [{ numBlocks: 8, dataCodewordsPerBlock: 37 }, { numBlocks: 1, dataCodewordsPerBlock: 38 },], }, { ecCodewordsPerBlock: 24, ecBlocks: [{ numBlocks: 8, dataCodewordsPerBlock: 20 }, { numBlocks: 4, dataCodewordsPerBlock: 21 },], }, { ecCodewordsPerBlock: 22, ecBlocks: [{ numBlocks: 12, dataCodewordsPerBlock: 11 }, { numBlocks: 4, dataCodewordsPerBlock: 12 },], },], }, { infoBits: 0x0E60D, versionNumber: 14, alignmentPatternCenters: [6, 26, 46, 66], errorCorrectionLevels: [{ ecCodewordsPerBlock: 30, ecBlocks: [{ numBlocks: 3, dataCodewordsPerBlock: 115 }, { numBlocks: 1, dataCodewordsPerBlock: 116 },], }, { ecCodewordsPerBlock: 24, ecBlocks: [{ numBlocks: 4, dataCodewordsPerBlock: 40 }, { numBlocks: 5, dataCodewordsPerBlock: 41 },], }, { ecCodewordsPerBlock: 20, ecBlocks: [{ numBlocks: 11, dataCodewordsPerBlock: 16 }, { numBlocks: 5, dataCodewordsPerBlock: 17 },], }, { ecCodewordsPerBlock: 24, ecBlocks: [{ numBlocks: 11, dataCodewordsPerBlock: 12 }, { numBlocks: 5, dataCodewordsPerBlock: 13 },], },], }, { infoBits: 0x0F928, versionNumber: 15, alignmentPatternCenters: [6, 26, 48, 70], errorCorrectionLevels: [{ ecCodewordsPerBlock: 22, ecBlocks: [{ numBlocks: 5, dataCodewordsPerBlock: 87 }, { numBlocks: 1, dataCodewordsPerBlock: 88 },], }, { ecCodewordsPerBlock: 24, ecBlocks: [{ numBlocks: 5, dataCodewordsPerBlock: 41 }, { numBlocks: 5, dataCodewordsPerBlock: 42 },], }, { ecCodewordsPerBlock: 30, ecBlocks: [{ numBlocks: 5, dataCodewordsPerBlock: 24 }, { numBlocks: 7, dataCodewordsPerBlock: 25 },], }, { ecCodewordsPerBlock: 24, ecBlocks: [{ numBlocks: 11, dataCodewordsPerBlock: 12 }, { numBlocks: 7, dataCodewordsPerBlock: 13 },], },], }, { infoBits: 0x10B78, versionNumber: 16, alignmentPatternCenters: [6, 26, 50, 74], errorCorrectionLevels: [{ ecCodewordsPerBlock: 24, ecBlocks: [{ numBlocks: 5, dataCodewordsPerBlock: 98 }, { numBlocks: 1, dataCodewordsPerBlock: 99 },], }, { ecCodewordsPerBlock: 28, ecBlocks: [{ numBlocks: 7, dataCodewordsPerBlock: 45 }, { numBlocks: 3, dataCodewordsPerBlock: 46 },], }, { ecCodewordsPerBlock: 24, ecBlocks: [{ numBlocks: 15, dataCodewordsPerBlock: 19 }, { numBlocks: 2, dataCodewordsPerBlock: 20 },], }, { ecCodewordsPerBlock: 30, ecBlocks: [{ numBlocks: 3, dataCodewordsPerBlock: 15 }, { numBlocks: 13, dataCodewordsPerBlock: 16 },], },], }, { infoBits: 0x1145D, versionNumber: 17, alignmentPatternCenters: [6, 30, 54, 78], errorCorrectionLevels: [{ ecCodewordsPerBlock: 28, ecBlocks: [{ numBlocks: 1, dataCodewordsPerBlock: 107 }, { numBlocks: 5, dataCodewordsPerBlock: 108 },], }, { ecCodewordsPerBlock: 28, ecBlocks: [{ numBlocks: 10, dataCodewordsPerBlock: 46 }, { numBlocks: 1, dataCodewordsPerBlock: 47 },], }, { ecCodewordsPerBlock: 28, ecBlocks: [{ numBlocks: 1, dataCodewordsPerBlock: 22 }, { numBlocks: 15, dataCodewordsPerBlock: 23 },], }, { ecCodewordsPerBlock: 28, ecBlocks: [{ numBlocks: 2, dataCodewordsPerBlock: 14 }, { numBlocks: 17, dataCodewordsPerBlock: 15 },], },], }, { infoBits: 0x12A17, versionNumber: 18, alignmentPatternCenters: [6, 30, 56, 82], errorCorrectionLevels: [{ ecCodewordsPerBlock: 30, ecBlocks: [{ numBlocks: 5, dataCodewordsPerBlock: 120 }, { numBlocks: 1, dataCodewordsPerBlock: 121 },], }, { ecCodewordsPerBlock: 26, ecBlocks: [{ numBlocks: 9, dataCodewordsPerBlock: 43 }, { numBlocks: 4, dataCodewordsPerBlock: 44 },], }, { ecCodewordsPerBlock: 28, ecBlocks: [{ numBlocks: 17, dataCodewordsPerBlock: 22 }, { numBlocks: 1, dataCodewordsPerBlock: 23 },], }, { ecCodewordsPerBlock: 28, ecBlocks: [{ numBlocks: 2, dataCodewordsPerBlock: 14 }, { numBlocks: 19, dataCodewordsPerBlock: 15 },], },], }, { infoBits: 0x13532, versionNumber: 19, alignmentPatternCenters: [6, 30, 58, 86], errorCorrectionLevels: [{ ecCodewordsPerBlock: 28, ecBlocks: [{ numBlocks: 3, dataCodewordsPerBlock: 113 }, { numBlocks: 4, dataCodewordsPerBlock: 114 },], }, { ecCodewordsPerBlock: 26, ecBlocks: [{ numBlocks: 3, dataCodewordsPerBlock: 44 }, { numBlocks: 11, dataCodewordsPerBlock: 45 },], }, { ecCodewordsPerBlock: 26, ecBlocks: [{ numBlocks: 17, dataCodewordsPerBlock: 21 }, { numBlocks: 4, dataCodewordsPerBlock: 22 },], }, { ecCodewordsPerBlock: 26, ecBlocks: [{ numBlocks: 9, dataCodewordsPerBlock: 13 }, { numBlocks: 16, dataCodewordsPerBlock: 14 },], },], }, { infoBits: 0x149A6, versionNumber: 20, alignmentPatternCenters: [6, 34, 62, 90], errorCorrectionLevels: [{ ecCodewordsPerBlock: 28, ecBlocks: [{ numBlocks: 3, dataCodewordsPerBlock: 107 }, { numBlocks: 5, dataCodewordsPerBlock: 108 },], }, { ecCodewordsPerBlock: 26, ecBlocks: [{ numBlocks: 3, dataCodewordsPerBlock: 41 }, { numBlocks: 13, dataCodewordsPerBlock: 42 },], }, { ecCodewordsPerBlock: 30, ecBlocks: [{ numBlocks: 15, dataCodewordsPerBlock: 24 }, { numBlocks: 5, dataCodewordsPerBlock: 25 },], }, { ecCodewordsPerBlock: 28, ecBlocks: [{ numBlocks: 15, dataCodewordsPerBlock: 15 }, { numBlocks: 10, dataCodewordsPerBlock: 16 },], },], }, { infoBits: 0x15683, versionNumber: 21, alignmentPatternCenters: [6, 28, 50, 72, 94], errorCorrectionLevels: [{ ecCodewordsPerBlock: 28, ecBlocks: [{ numBlocks: 4, dataCodewordsPerBlock: 116 }, { numBlocks: 4, dataCodewordsPerBlock: 117 },], }, { ecCodewordsPerBlock: 26, ecBlocks: [{ numBlocks: 17, dataCodewordsPerBlock: 42 }], }, { ecCodewordsPerBlock: 28, ecBlocks: [{ numBlocks: 17, dataCodewordsPerBlock: 22 }, { numBlocks: 6, dataCodewordsPerBlock: 23 },], }, { ecCodewordsPerBlock: 30, ecBlocks: [{ numBlocks: 19, dataCodewordsPerBlock: 16 }, { numBlocks: 6, dataCodewordsPerBlock: 17 },], },], }, { infoBits: 0x168C9, versionNumber: 22, alignmentPatternCenters: [6, 26, 50, 74, 98], errorCorrectionLevels: [{ ecCodewordsPerBlock: 28, ecBlocks: [{ numBlocks: 2, dataCodewordsPerBlock: 111 }, { numBlocks: 7, dataCodewordsPerBlock: 112 },], }, { ecCodewordsPerBlock: 28, ecBlocks: [{ numBlocks: 17, dataCodewordsPerBlock: 46 }], }, { ecCodewordsPerBlock: 30, ecBlocks: [{ numBlocks: 7, dataCodewordsPerBlock: 24 }, { numBlocks: 16, dataCodewordsPerBlock: 25 },], }, { ecCodewordsPerBlock: 24, ecBlocks: [{ numBlocks: 34, dataCodewordsPerBlock: 13 }], },], }, { infoBits: 0x177EC, versionNumber: 23, alignmentPatternCenters: [6, 30, 54, 74, 102], errorCorrectionLevels: [{ ecCodewordsPerBlock: 30, ecBlocks: [{ numBlocks: 4, dataCodewordsPerBlock: 121 }, { numBlocks: 5, dataCodewordsPerBlock: 122 },], }, { ecCodewordsPerBlock: 28, ecBlocks: [{ numBlocks: 4, dataCodewordsPerBlock: 47 }, { numBlocks: 14, dataCodewordsPerBlock: 48 },], }, { ecCodewordsPerBlock: 30, ecBlocks: [{ numBlocks: 11, dataCodewordsPerBlock: 24 }, { numBlocks: 14, dataCodewordsPerBlock: 25 },], }, { ecCodewordsPerBlock: 30, ecBlocks: [{ numBlocks: 16, dataCodewordsPerBlock: 15 }, { numBlocks: 14, dataCodewordsPerBlock: 16 },], },], }, { infoBits: 0x18EC4, versionNumber: 24, alignmentPatternCenters: [6, 28, 54, 80, 106], errorCorrectionLevels: [{ ecCodewordsPerBlock: 30, ecBlocks: [{ numBlocks: 6, dataCodewordsPerBlock: 117 }, { numBlocks: 4, dataCodewordsPerBlock: 118 },], }, { ecCodewordsPerBlock: 28, ecBlocks: [{ numBlocks: 6, dataCodewordsPerBlock: 45 }, { numBlocks: 14, dataCodewordsPerBlock: 46 },], }, { ecCodewordsPerBlock: 30, ecBlocks: [{ numBlocks: 11, dataCodewordsPerBlock: 24 }, { numBlocks: 16, dataCodewordsPerBlock: 25 },], }, { ecCodewordsPerBlock: 30, ecBlocks: [{ numBlocks: 30, dataCodewordsPerBlock: 16 }, { numBlocks: 2, dataCodewordsPerBlock: 17 },], },], }, { infoBits: 0x191E1, versionNumber: 25, alignmentPatternCenters: [6, 32, 58, 84, 110], errorCorrectionLevels: [{ ecCodewordsPerBlock: 26, ecBlocks: [{ numBlocks: 8, dataCodewordsPerBlock: 106 }, { numBlocks: 4, dataCodewordsPerBlock: 107 },], }, { ecCodewordsPerBlock: 28, ecBlocks: [{ numBlocks: 8, dataCodewordsPerBlock: 47 }, { numBlocks: 13, dataCodewordsPerBlock: 48 },], }, { ecCodewordsPerBlock: 30, ecBlocks: [{ numBlocks: 7, dataCodewordsPerBlock: 24 }, { numBlocks: 22, dataCodewordsPerBlock: 25 },], }, { ecCodewordsPerBlock: 30, ecBlocks: [{ numBlocks: 22, dataCodewordsPerBlock: 15 }, { numBlocks: 13, dataCodewordsPerBlock: 16 },], },], }, { infoBits: 0x1AFAB, versionNumber: 26, alignmentPatternCenters: [6, 30, 58, 86, 114], errorCorrectionLevels: [{ ecCodewordsPerBlock: 28, ecBlocks: [{ numBlocks: 10, dataCodewordsPerBlock: 114 }, { numBlocks: 2, dataCodewordsPerBlock: 115 },], }, { ecCodewordsPerBlock: 28, ecBlocks: [{ numBlocks: 19, dataCodewordsPerBlock: 46 }, { numBlocks: 4, dataCodewordsPerBlock: 47 },], }, { ecCodewordsPerBlock: 28, ecBlocks: [{ numBlocks: 28, dataCodewordsPerBlock: 22 }, { numBlocks: 6, dataCodewordsPerBlock: 23 },], }, { ecCodewordsPerBlock: 30, ecBlocks: [{ numBlocks: 33, dataCodewordsPerBlock: 16 }, { numBlocks: 4, dataCodewordsPerBlock: 17 },], },], }, { infoBits: 0x1B08E, versionNumber: 27, alignmentPatternCenters: [6, 34, 62, 90, 118], errorCorrectionLevels: [{ ecCodewordsPerBlock: 30, ecBlocks: [{ numBlocks: 8, dataCodewordsPerBlock: 122 }, { numBlocks: 4, dataCodewordsPerBlock: 123 },], }, { ecCodewordsPerBlock: 28, ecBlocks: [{ numBlocks: 22, dataCodewordsPerBlock: 45 }, { numBlocks: 3, dataCodewordsPerBlock: 46 },], }, { ecCodewordsPerBlock: 30, ecBlocks: [{ numBlocks: 8, dataCodewordsPerBlock: 23 }, { numBlocks: 26, dataCodewordsPerBlock: 24 },], }, { ecCodewordsPerBlock: 30, ecBlocks: [{ numBlocks: 12, dataCodewordsPerBlock: 15 }, { numBlocks: 28, dataCodewordsPerBlock: 16 },], },], }, { infoBits: 0x1CC1A, versionNumber: 28, alignmentPatternCenters: [6, 26, 50, 74, 98, 122], errorCorrectionLevels: [{ ecCodewordsPerBlock: 30, ecBlocks: [{ numBlocks: 3, dataCodewordsPerBlock: 117 }, { numBlocks: 10, dataCodewordsPerBlock: 118 },], }, { ecCodewordsPerBlock: 28, ecBlocks: [{ numBlocks: 3, dataCodewordsPerBlock: 45 }, { numBlocks: 23, dataCodewordsPerBlock: 46 },], }, { ecCodewordsPerBlock: 30, ecBlocks: [{ numBlocks: 4, dataCodewordsPerBlock: 24 }, { numBlocks: 31, dataCodewordsPerBlock: 25 },], }, { ecCodewordsPerBlock: 30, ecBlocks: [{ numBlocks: 11, dataCodewordsPerBlock: 15 }, { numBlocks: 31, dataCodewordsPerBlock: 16 },], },], }, { infoBits: 0x1D33F, versionNumber: 29, alignmentPatternCenters: [6, 30, 54, 78, 102, 126], errorCorrectionLevels: [{ ecCodewordsPerBlock: 30, ecBlocks: [{ numBlocks: 7, dataCodewordsPerBlock: 116 }, { numBlocks: 7, dataCodewordsPerBlock: 117 },], }, { ecCodewordsPerBlock: 28, ecBlocks: [{ numBlocks: 21, dataCodewordsPerBlock: 45 }, { numBlocks: 7, dataCodewordsPerBlock: 46 },], }, { ecCodewordsPerBlock: 30, ecBlocks: [{ numBlocks: 1, dataCodewordsPerBlock: 23 }, { numBlocks: 37, dataCodewordsPerBlock: 24 },], }, { ecCodewordsPerBlock: 30, ecBlocks: [{ numBlocks: 19, dataCodewordsPerBlock: 15 }, { numBlocks: 26, dataCodewordsPerBlock: 16 },], },], }, { infoBits: 0x1ED75, versionNumber: 30, alignmentPatternCenters: [6, 26, 52, 78, 104, 130], errorCorrectionLevels: [{ ecCodewordsPerBlock: 30, ecBlocks: [{ numBlocks: 5, dataCodewordsPerBlock: 115 }, { numBlocks: 10, dataCodewordsPerBlock: 116 },], }, { ecCodewordsPerBlock: 28, ecBlocks: [{ numBlocks: 19, dataCodewordsPerBlock: 47 }, { numBlocks: 10, dataCodewordsPerBlock: 48 },], }, { ecCodewordsPerBlock: 30, ecBlocks: [{ numBlocks: 15, dataCodewordsPerBlock: 24 }, { numBlocks: 25, dataCodewordsPerBlock: 25 },], }, { ecCodewordsPerBlock: 30, ecBlocks: [{ numBlocks: 23, dataCodewordsPerBlock: 15 }, { numBlocks: 25, dataCodewordsPerBlock: 16 },], },], }, { infoBits: 0x1F250, versionNumber: 31, alignmentPatternCenters: [6, 30, 56, 82, 108, 134], errorCorrectionLevels: [{ ecCodewordsPerBlock: 30, ecBlocks: [{ numBlocks: 13, dataCodewordsPerBlock: 115 }, { numBlocks: 3, dataCodewordsPerBlock: 116 },], }, { ecCodewordsPerBlock: 28, ecBlocks: [{ numBlocks: 2, dataCodewordsPerBlock: 46 }, { numBlocks: 29, dataCodewordsPerBlock: 47 },], }, { ecCodewordsPerBlock: 30, ecBlocks: [{ numBlocks: 42, dataCodewordsPerBlock: 24 }, { numBlocks: 1, dataCodewordsPerBlock: 25 },], }, { ecCodewordsPerBlock: 30, ecBlocks: [{ numBlocks: 23, dataCodewordsPerBlock: 15 }, { numBlocks: 28, dataCodewordsPerBlock: 16 },], },], }, { infoBits: 0x209D5, versionNumber: 32, alignmentPatternCenters: [6, 34, 60, 86, 112, 138], errorCorrectionLevels: [{ ecCodewordsPerBlock: 30, ecBlocks: [{ numBlocks: 17, dataCodewordsPerBlock: 115 }], }, { ecCodewordsPerBlock: 28, ecBlocks: [{ numBlocks: 10, dataCodewordsPerBlock: 46 }, { numBlocks: 23, dataCodewordsPerBlock: 47 },], }, { ecCodewordsPerBlock: 30, ecBlocks: [{ numBlocks: 10, dataCodewordsPerBlock: 24 }, { numBlocks: 35, dataCodewordsPerBlock: 25 },], }, { ecCodewordsPerBlock: 30, ecBlocks: [{ numBlocks: 19, dataCodewordsPerBlock: 15 }, { numBlocks: 35, dataCodewordsPerBlock: 16 },], },], }, { infoBits: 0x216F0, versionNumber: 33, alignmentPatternCenters: [6, 30, 58, 86, 114, 142], errorCorrectionLevels: [{ ecCodewordsPerBlock: 30, ecBlocks: [{ numBlocks: 17, dataCodewordsPerBlock: 115 }, { numBlocks: 1, dataCodewordsPerBlock: 116 },], }, { ecCodewordsPerBlock: 28, ecBlocks: [{ numBlocks: 14, dataCodewordsPerBlock: 46 }, { numBlocks: 21, dataCodewordsPerBlock: 47 },], }, { ecCodewordsPerBlock: 30, ecBlocks: [{ numBlocks: 29, dataCodewordsPerBlock: 24 }, { numBlocks: 19, dataCodewordsPerBlock: 25 },], }, { ecCodewordsPerBlock: 30, ecBlocks: [{ numBlocks: 11, dataCodewordsPerBlock: 15 }, { numBlocks: 46, dataCodewordsPerBlock: 16 },], },], }, { infoBits: 0x228BA, versionNumber: 34, alignmentPatternCenters: [6, 34, 62, 90, 118, 146], errorCorrectionLevels: [{ ecCodewordsPerBlock: 30, ecBlocks: [{ numBlocks: 13, dataCodewordsPerBlock: 115 }, { numBlocks: 6, dataCodewordsPerBlock: 116 },], }, { ecCodewordsPerBlock: 28, ecBlocks: [{ numBlocks: 14, dataCodewordsPerBlock: 46 }, { numBlocks: 23, dataCodewordsPerBlock: 47 },], }, { ecCodewordsPerBlock: 30, ecBlocks: [{ numBlocks: 44, dataCodewordsPerBlock: 24 }, { numBlocks: 7, dataCodewordsPerBlock: 25 },], }, { ecCodewordsPerBlock: 30, ecBlocks: [{ numBlocks: 59, dataCodewordsPerBlock: 16 }, { numBlocks: 1, dataCodewordsPerBlock: 17 },], },], }, { infoBits: 0x2379F, versionNumber: 35, alignmentPatternCenters: [6, 30, 54, 78, 102, 126, 150], errorCorrectionLevels: [{ ecCodewordsPerBlock: 30, ecBlocks: [{ numBlocks: 12, dataCodewordsPerBlock: 121 }, { numBlocks: 7, dataCodewordsPerBlock: 122 },], }, { ecCodewordsPerBlock: 28, ecBlocks: [{ numBlocks: 12, dataCodewordsPerBlock: 47 }, { numBlocks: 26, dataCodewordsPerBlock: 48 },], }, { ecCodewordsPerBlock: 30, ecBlocks: [{ numBlocks: 39, dataCodewordsPerBlock: 24 }, { numBlocks: 14, dataCodewordsPerBlock: 25 },], }, { ecCodewordsPerBlock: 30, ecBlocks: [{ numBlocks: 22, dataCodewordsPerBlock: 15 }, { numBlocks: 41, dataCodewordsPerBlock: 16 },], },], }, { infoBits: 0x24B0B, versionNumber: 36, alignmentPatternCenters: [6, 24, 50, 76, 102, 128, 154], errorCorrectionLevels: [{ ecCodewordsPerBlock: 30, ecBlocks: [{ numBlocks: 6, dataCodewordsPerBlock: 121 }, { numBlocks: 14, dataCodewordsPerBlock: 122 },], }, { ecCodewordsPerBlock: 28, ecBlocks: [{ numBlocks: 6, dataCodewordsPerBlock: 47 }, { numBlocks: 34, dataCodewordsPerBlock: 48 },], }, { ecCodewordsPerBlock: 30, ecBlocks: [{ numBlocks: 46, dataCodewordsPerBlock: 24 }, { numBlocks: 10, dataCodewordsPerBlock: 25 },], }, { ecCodewordsPerBlock: 30, ecBlocks: [{ numBlocks: 2, dataCodewordsPerBlock: 15 }, { numBlocks: 64, dataCodewordsPerBlock: 16 },], },], }, { infoBits: 0x2542E, versionNumber: 37, alignmentPatternCenters: [6, 28, 54, 80, 106, 132, 158], errorCorrectionLevels: [{ ecCodewordsPerBlock: 30, ecBlocks: [{ numBlocks: 17, dataCodewordsPerBlock: 122 }, { numBlocks: 4, dataCodewordsPerBlock: 123 },], }, { ecCodewordsPerBlock: 28, ecBlocks: [{ numBlocks: 29, dataCodewordsPerBlock: 46 }, { numBlocks: 14, dataCodewordsPerBlock: 47 },], }, { ecCodewordsPerBlock: 30, ecBlocks: [{ numBlocks: 49, dataCodewordsPerBlock: 24 }, { numBlocks: 10, dataCodewordsPerBlock: 25 },], }, { ecCodewordsPerBlock: 30, ecBlocks: [{ numBlocks: 24, dataCodewordsPerBlock: 15 }, { numBlocks: 46, dataCodewordsPerBlock: 16 },], },], }, { infoBits: 0x26A64, versionNumber: 38, alignmentPatternCenters: [6, 32, 58, 84, 110, 136, 162], errorCorrectionLevels: [{ ecCodewordsPerBlock: 30, ecBlocks: [{ numBlocks: 4, dataCodewordsPerBlock: 122 }, { numBlocks: 18, dataCodewordsPerBlock: 123 },], }, { ecCodewordsPerBlock: 28, ecBlocks: [{ numBlocks: 13, dataCodewordsPerBlock: 46 }, { numBlocks: 32, dataCodewordsPerBlock: 47 },], }, { ecCodewordsPerBlock: 30, ecBlocks: [{ numBlocks: 48, dataCodewordsPerBlock: 24 }, { numBlocks: 14, dataCodewordsPerBlock: 25 },], }, { ecCodewordsPerBlock: 30, ecBlocks: [{ numBlocks: 42, dataCodewordsPerBlock: 15 }, { numBlocks: 32, dataCodewordsPerBlock: 16 },], },], }, { infoBits: 0x27541, versionNumber: 39, alignmentPatternCenters: [6, 26, 54, 82, 110, 138, 166], errorCorrectionLevels: [{ ecCodewordsPerBlock: 30, ecBlocks: [{ numBlocks: 20, dataCodewordsPerBlock: 117 }, { numBlocks: 4, dataCodewordsPerBlock: 118 },], }, { ecCodewordsPerBlock: 28, ecBlocks: [{ numBlocks: 40, dataCodewordsPerBlock: 47 }, { numBlocks: 7, dataCodewordsPerBlock: 48 },], }, { ecCodewordsPerBlock: 30, ecBlocks: [{ numBlocks: 43, dataCodewordsPerBlock: 24 }, { numBlocks: 22, dataCodewordsPerBlock: 25 },], }, { ecCodewordsPerBlock: 30, ecBlocks: [{ numBlocks: 10, dataCodewordsPerBlock: 15 }, { numBlocks: 67, dataCodewordsPerBlock: 16 },], },], }, { infoBits: 0x28C69, versionNumber: 40, alignmentPatternCenters: [6, 30, 58, 86, 114, 142, 170], errorCorrectionLevels: [{ ecCodewordsPerBlock: 30, ecBlocks: [{ numBlocks: 19, dataCodewordsPerBlock: 118 }, { numBlocks: 6, dataCodewordsPerBlock: 119 },], }, { ecCodewordsPerBlock: 28, ecBlocks: [{ numBlocks: 18, dataCodewordsPerBlock: 47 }, { numBlocks: 31, dataCodewordsPerBlock: 48 },], }, { ecCodewordsPerBlock: 30, ecBlocks: [{ numBlocks: 34, dataCodewordsPerBlock: 24 }, { numBlocks: 34, dataCodewordsPerBlock: 25 },], }, { ecCodewordsPerBlock: 30, ecBlocks: [{ numBlocks: 20, dataCodewordsPerBlock: 15 }, { numBlocks: 61, dataCodewordsPerBlock: 16 },], },], },]; }), (function (module, exports, __webpack_require__) { "use strict"; Object.defineProperty(exports, "__esModule", { value: true }); var BitMatrix_1 = __webpack_require__(0); function squareToQuadrilateral(p1, p2, p3, p4) { var dx3 = p1.x - p2.x + p3.x - p4.x; var dy3 = p1.y - p2.y + p3.y - p4.y; if (dx3 === 0 && dy3 === 0) { return { a11: p2.x - p1.x, a12: p2.y - p1.y, a13: 0, a21: p3.x - p2.x, a22: p3.y - p2.y, a23: 0, a31: p1.x, a32: p1.y, a33: 1, }; } else { var dx1 = p2.x - p3.x; var dx2 = p4.x - p3.x; var dy1 = p2.y - p3.y; var dy2 = p4.y - p3.y; var denominator = dx1 * dy2 - dx2 * dy1; var a13 = (dx3 * dy2 - dx2 * dy3) / denominator; var a23 = (dx1 * dy3 - dx3 * dy1) / denominator; return { a11: p2.x - p1.x + a13 * p2.x, a12: p2.y - p1.y + a13 * p2.y, a13: a13, a21: p4.x - p1.x + a23 * p4.x, a22: p4.y - p1.y + a23 * p4.y, a23: a23, a31: p1.x, a32: p1.y, a33: 1, }; } } function quadrilateralToSquare(p1, p2, p3, p4) { var sToQ = squareToQuadrilateral(p1, p2, p3, p4); return { a11: sToQ.a22 * sToQ.a33 - sToQ.a23 * sToQ.a32, a12: sToQ.a13 * sToQ.a32 - sToQ.a12 * sToQ.a33, a13: sToQ.a12 * sToQ.a23 - sToQ.a13 * sToQ.a22, a21: sToQ.a23 * sToQ.a31 - sToQ.a21 * sToQ.a33, a22: sToQ.a11 * sToQ.a33 - sToQ.a13 * sToQ.a31, a23: sToQ.a13 * sToQ.a21 - sToQ.a11 * sToQ.a23, a31: sToQ.a21 * sToQ.a32 - sToQ.a22 * sToQ.a31, a32: sToQ.a12 * sToQ.a31 - sToQ.a11 * sToQ.a32, a33: sToQ.a11 * sToQ.a22 - sToQ.a12 * sToQ.a21, }; } function times(a, b) { return { a11: a.a11 * b.a11 + a.a21 * b.a12 + a.a31 * b.a13, a12: a.a12 * b.a11 + a.a22 * b.a12 + a.a32 * b.a13, a13: a.a13 * b.a11 + a.a23 * b.a12 + a.a33 * b.a13, a21: a.a11 * b.a21 + a.a21 * b.a22 + a.a31 * b.a23, a22: a.a12 * b.a21 + a.a22 * b.a22 + a.a32 * b.a23, a23: a.a13 * b.a21 + a.a23 * b.a22 + a.a33 * b.a23, a31: a.a11 * b.a31 + a.a21 * b.a32 + a.a31 * b.a33, a32: a.a12 * b.a31 + a.a22 * b.a32 + a.a32 * b.a33, a33: a.a13 * b.a31 + a.a23 * b.a32 + a.a33 * b.a33, }; } function extract(image, location) { var qToS = quadrilateralToSquare({ x: 3.5, y: 3.5 }, { x: location.dimension - 3.5, y: 3.5 }, { x: location.dimension - 6.5, y: location.dimension - 6.5 }, { x: 3.5, y: location.dimension - 3.5 }); var sToQ = squareToQuadrilateral(location.topLeft, location.topRight, location.alignmentPattern, location.bottomLeft); var transform = times(sToQ, qToS); var matrix = BitMatrix_1.BitMatrix.createEmpty(location.dimension, location.dimension); var mappingFunction = function (x, y) { var denominator = transform.a13 * x + transform.a23 * y + transform.a33; return { x: (transform.a11 * x + transform.a21 * y + transform.a31) / denominator, y: (transform.a12 * x + transform.a22 * y + transform.a32) / denominator, }; }; for (var y = 0; y < location.dimension; y++) { for (var x = 0; x < location.dimension; x++) { var xValue = x + 0.5; var yValue = y + 0.5; var sourcePixel = mappingFunction(xValue, yValue); matrix.set(x, y, image.get(Math.floor(sourcePixel.x), Math.floor(sourcePixel.y))); } } return { matrix: matrix, mappingFunction: mappingFunction, }; } exports.extract = extract; }), (function (module, exports, __webpack_require__) { "use strict"; Object.defineProperty(exports, "__esModule", { value: true }); var MAX_FINDERPATTERNS_TO_SEARCH = 4; var MIN_QUAD_RATIO = 0.5; var MAX_QUAD_RATIO = 1.5; var distance = function (a, b) { return Math.sqrt(Math.pow((b.x - a.x), 2) + Math.pow((b.y - a.y), 2)); }; function sum(values) { return values.reduce(function (a, b) { return a + b; }); } function reorderFinderPatterns(pattern1, pattern2, pattern3) { var _a, _b, _c, _d; var oneTwoDistance = distance(pattern1, pattern2); var twoThreeDistance = distance(pattern2, pattern3); var oneThreeDistance = distance(pattern1, pattern3); var bottomLeft; var topLeft; var topRight; if (twoThreeDistance >= oneTwoDistance && twoThreeDistance >= oneThreeDistance) { _a = [pattern2, pattern1, pattern3], bottomLeft = _a[0], topLeft = _a[1], topRight = _a[2]; } else if (oneThreeDistance >= twoThreeDistance && oneThreeDistance >= oneTwoDistance) { _b = [pattern1, pattern2, pattern3], bottomLeft = _b[0], topLeft = _b[1], topRight = _b[2]; } else { _c = [pattern1, pattern3, pattern2], bottomLeft = _c[0], topLeft = _c[1], topRight = _c[2]; } if (((topRight.x - topLeft.x) * (bottomLeft.y - topLeft.y)) - ((topRight.y - topLeft.y) * (bottomLeft.x - topLeft.x)) < 0) { _d = [topRight, bottomLeft], bottomLeft = _d[0], topRight = _d[1]; } return { bottomLeft: bottomLeft, topLeft: topLeft, topRight: topRight }; } function computeDimension(topLeft, topRight, bottomLeft, matrix) { var moduleSize = (sum(countBlackWhiteRun(topLeft, bottomLeft, matrix, 5)) / 7 + sum(countBlackWhiteRun(topLeft, topRight, matrix, 5)) / 7 + sum(countBlackWhiteRun(bottomLeft, topLeft, matrix, 5)) / 7 + sum(countBlackWhiteRun(topRight, topLeft, matrix, 5)) / 7) / 4; if (moduleSize < 1) { throw new Error("Invalid module size"); } var topDimension = Math.round(distance(topLeft, topRight) / moduleSize); var sideDimension = Math.round(distance(topLeft, bottomLeft) / moduleSize); var dimension = Math.floor((topDimension + sideDimension) / 2) + 7; switch (dimension % 4) { case 0: dimension++; break; case 2: dimension--; break; }return { dimension: dimension, moduleSize: moduleSize }; } function countBlackWhiteRunTowardsPoint(origin, end, matrix, length) { var switchPoints = [{ x: Math.floor(origin.x), y: Math.floor(origin.y) }]; var steep = Math.abs(end.y - origin.y) > Math.abs(end.x - origin.x); var fromX; var fromY; var toX; var toY; if (steep) { fromX = Math.floor(origin.y); fromY = Math.floor(origin.x); toX = Math.floor(end.y); toY = Math.floor(end.x); } else { fromX = Math.floor(origin.x); fromY = Math.floor(origin.y); toX = Math.floor(end.x); toY = Math.floor(end.y); } var dx = Math.abs(toX - fromX); var dy = Math.abs(toY - fromY); var error = Math.floor(-dx / 2); var xStep = fromX < toX ? 1 : -1; var yStep = fromY < toY ? 1 : -1; var currentPixel = true; for (var x = fromX, y = fromY; x !== toX + xStep; x += xStep) { var realX = steep ? y : x; var realY = steep ? x : y; if (matrix.get(realX, realY) !== currentPixel) { currentPixel = !currentPixel; switchPoints.push({ x: realX, y: realY }); if (switchPoints.length === length + 1) { break; } } error += dy; if (error > 0) { if (y === toY) { break; } y += yStep; error -= dx; } } var distances = []; for (var i = 0; i < length; i++) { if (switchPoints[i] && switchPoints[i + 1]) { distances.push(distance(switchPoints[i], switchPoints[i + 1])); } else { distances.push(0); } } return distances; } function countBlackWhiteRun(origin, end, matrix, length) { var _a; var rise = end.y - origin.y; var run = end.x - origin.x; var towardsEnd = countBlackWhiteRunTowardsPoint(origin, end, matrix, Math.ceil(length / 2)); var awayFromEnd = countBlackWhiteRunTowardsPoint(origin, { x: origin.x - run, y: origin.y - rise }, matrix, Math.ceil(length / 2)); var middleValue = towardsEnd.shift() + awayFromEnd.shift() - 1; return (_a = awayFromEnd.concat(middleValue)).concat.apply(_a, towardsEnd); } function scoreBlackWhiteRun(sequence, ratios) { var averageSize = sum(sequence) / sum(ratios); var error = 0; ratios.forEach(function (ratio, i) { error += Math.pow((sequence[i] - ratio * averageSize), 2); }); return { averageSize: averageSize, error: error }; } function scorePattern(point, ratios, matrix) { try { var horizontalRun = countBlackWhiteRun(point, { x: -1, y: point.y }, matrix, ratios.length); var verticalRun = countBlackWhiteRun(point, { x: point.x, y: -1 }, matrix, ratios.length); var topLeftPoint = { x: Math.max(0, point.x - point.y) - 1, y: Math.max(0, point.y - point.x) - 1, }; var topLeftBottomRightRun = countBlackWhiteRun(point, topLeftPoint, matrix, ratios.length); var bottomLeftPoint = { x: Math.min(matrix.width, point.x + point.y) + 1, y: Math.min(matrix.height, point.y + point.x) + 1, }; var bottomLeftTopRightRun = countBlackWhiteRun(point, bottomLeftPoint, matrix, ratios.length); var horzError = scoreBlackWhiteRun(horizontalRun, ratios); var vertError = scoreBlackWhiteRun(verticalRun, ratios); var diagDownError = scoreBlackWhiteRun(topLeftBottomRightRun, ratios); var diagUpError = scoreBlackWhiteRun(bottomLeftTopRightRun, ratios); var ratioError = Math.sqrt(horzError.error * horzError.error + vertError.error * vertError.error + diagDownError.error * diagDownError.error + diagUpError.error * diagUpError.error); var avgSize = (horzError.averageSize + vertError.averageSize + diagDownError.averageSize + diagUpError.averageSize) / 4; var sizeError = (Math.pow((horzError.averageSize - avgSize), 2) + Math.pow((vertError.averageSize - avgSize), 2) + Math.pow((diagDownError.averageSize - avgSize), 2) + Math.pow((diagUpError.averageSize - avgSize), 2)) / avgSize; return ratioError + sizeError; } catch (_a) { return Infinity; } } function recenterLocation(matrix, p) { var leftX = Math.round(p.x); while (matrix.get(leftX, Math.round(p.y))) { leftX--; } var rightX = Math.round(p.x); while (matrix.get(rightX, Math.round(p.y))) { rightX++; } var x = (leftX + rightX) / 2; var topY = Math.round(p.y); while (matrix.get(Math.round(x), topY)) { topY--; } var bottomY = Math.round(p.y); while (matrix.get(Math.round(x), bottomY)) { bottomY++; } var y = (topY + bottomY) / 2; return { x: x, y: y }; } function locate(matrix) { var finderPatternQuads = []; var activeFinderPatternQuads = []; var alignmentPatternQuads = []; var activeAlignmentPatternQuads = []; var _loop_1 = function (y) { var length_1 = 0; var lastBit = false; var scans = [0, 0, 0, 0, 0]; var _loop_2 = function (x) { var v = matrix.get(x, y); if (v === lastBit) { length_1++; } else { scans = [scans[1], scans[2], scans[3], scans[4], length_1]; length_1 = 1; lastBit = v; var averageFinderPatternBlocksize = sum(scans) / 7; var validFinderPattern = Math.abs(scans[0] - averageFinderPatternBlocksize) < averageFinderPatternBlocksize && Math.abs(scans[1] - averageFinderPatternBlocksize) < averageFinderPatternBlocksize && Math.abs(scans[2] - 3 * averageFinderPatternBlocksize) < 3 * averageFinderPatternBlocksize && Math.abs(scans[3] - averageFinderPatternBlocksize) < averageFinderPatternBlocksize && Math.abs(scans[4] - averageFinderPatternBlocksize) < averageFinderPatternBlocksize && !v; var averageAlignmentPatternBlocksize = sum(scans.slice(-3)) / 3; var validAlignmentPattern = Math.abs(scans[2] - averageAlignmentPatternBlocksize) < averageAlignmentPatternBlocksize && Math.abs(scans[3] - averageAlignmentPatternBlocksize) < averageAlignmentPatternBlocksize && Math.abs(scans[4] - averageAlignmentPatternBlocksize) < averageAlignmentPatternBlocksize && v; if (validFinderPattern) { var endX_1 = x - scans[3] - scans[4]; var startX_1 = endX_1 - scans[2]; var line = { startX: startX_1, endX: endX_1, y: y }; var matchingQuads = activeFinderPatternQuads.filter(function (q) { return (startX_1 >= q.bottom.startX && startX_1 <= q.bottom.endX) || (endX_1 >= q.bottom.startX && startX_1 <= q.bottom.endX) || (startX_1 <= q.bottom.startX && endX_1 >= q.bottom.endX && ((scans[2] / (q.bottom.endX - q.bottom.startX)) < MAX_QUAD_RATIO && (scans[2] / (q.bottom.endX - q.bottom.startX)) > MIN_QUAD_RATIO)); }); if (matchingQuads.length > 0) { matchingQuads[0].bottom = line; } else { activeFinderPatternQuads.push({ top: line, bottom: line }); } } if (validAlignmentPattern) { var endX_2 = x - scans[4]; var startX_2 = endX_2 - scans[3]; var line = { startX: startX_2, y: y, endX: endX_2 }; var matchingQuads = activeAlignmentPatternQuads.filter(function (q) { return (startX_2 >= q.bottom.startX && startX_2 <= q.bottom.endX) || (endX_2 >= q.bottom.startX && startX_2 <= q.bottom.endX) || (startX_2 <= q.bottom.startX && endX_2 >= q.bottom.endX && ((scans[2] / (q.bottom.endX - q.bottom.startX)) < MAX_QUAD_RATIO && (scans[2] / (q.bottom.endX - q.bottom.startX)) > MIN_QUAD_RATIO)); }); if (matchingQuads.length > 0) { matchingQuads[0].bottom = line; } else { activeAlignmentPatternQuads.push({ top: line, bottom: line }); } } } }; for (var x = -1; x <= matrix.width; x++) { _loop_2(x); } finderPatternQuads.push.apply(finderPatternQuads, activeFinderPatternQuads.filter(function (q) { return q.bottom.y !== y && q.bottom.y - q.top.y >= 2; })); activeFinderPatternQuads = activeFinderPatternQuads.filter(function (q) { return q.bottom.y === y; }); alignmentPatternQuads.push.apply(alignmentPatternQuads, activeAlignmentPatternQuads.filter(function (q) { return q.bottom.y !== y; })); activeAlignmentPatternQuads = activeAlignmentPatternQuads.filter(function (q) { return q.bottom.y === y; }); }; for (var y = 0; y <= matrix.height; y++) { _loop_1(y); } finderPatternQuads.push.apply(finderPatternQuads, activeFinderPatternQuads.filter(function (q) { return q.bottom.y - q.top.y >= 2; })); alignmentPatternQuads.push.apply(alignmentPatternQuads, activeAlignmentPatternQuads); var finderPatternGroups = finderPatternQuads.filter(function (q) { return q.bottom.y - q.top.y >= 2; }).map(function (q) { var x = (q.top.startX + q.top.endX + q.bottom.startX + q.bottom.endX) / 4; var y = (q.top.y + q.bottom.y + 1) / 2; if (!matrix.get(Math.round(x), Math.round(y))) { return; } var lengths = [q.top.endX - q.top.startX, q.bottom.endX - q.bottom.startX, q.bottom.y - q.top.y + 1]; var size = sum(lengths) / lengths.length; var score = scorePattern({ x: Math.round(x), y: Math.round(y) }, [1, 1, 3, 1, 1], matrix); return { score: score, x: x, y: y, size: size }; }).filter(function (q) { return !!q; }).sort(function (a, b) { return a.score - b.score; }).map(function (point, i, finderPatterns) { if (i > MAX_FINDERPATTERNS_TO_SEARCH) { return null; } var otherPoints = finderPatterns.filter(function (p, ii) { return i !== ii; }).map(function (p) { return ({ x: p.x, y: p.y, score: p.score + (Math.pow((p.size - point.size), 2)) / point.size, size: p.size }); }).sort(function (a, b) { return a.score - b.score; }); if (otherPoints.length < 2) { return null; } var score = point.score + otherPoints[0].score + otherPoints[1].score; return { points: [point].concat(otherPoints.slice(0, 2)), score: score }; }).filter(function (q) { return !!q; }).sort(function (a, b) { return a.score - b.score; }); if (finderPatternGroups.length === 0) { return null; } var _a = reorderFinderPatterns(finderPatternGroups[0].points[0], finderPatternGroups[0].points[1], finderPatternGroups[0].points[2]), topRight = _a.topRight, topLeft = _a.topLeft, bottomLeft = _a.bottomLeft; var alignment = findAlignmentPattern(matrix, alignmentPatternQuads, topRight, topLeft, bottomLeft); var result = []; if (alignment) { result.push({ alignmentPattern: { x: alignment.alignmentPattern.x, y: alignment.alignmentPattern.y }, bottomLeft: { x: bottomLeft.x, y: bottomLeft.y }, dimension: alignment.dimension, topLeft: { x: topLeft.x, y: topLeft.y }, topRight: { x: topRight.x, y: topRight.y }, }); } var midTopRight = recenterLocation(matrix, topRight); var midTopLeft = recenterLocation(matrix, topLeft); var midBottomLeft = recenterLocation(matrix, bottomLeft); var centeredAlignment = findAlignmentPattern(matrix, alignmentPatternQuads, midTopRight, midTopLeft, midBottomLeft); if (centeredAlignment) { result.push({ alignmentPattern: { x: centeredAlignment.alignmentPattern.x, y: centeredAlignment.alignmentPattern.y }, bottomLeft: { x: midBottomLeft.x, y: midBottomLeft.y }, topLeft: { x: midTopLeft.x, y: midTopLeft.y }, topRight: { x: midTopRight.x, y: midTopRight.y }, dimension: centeredAlignment.dimension, }); } if (result.length === 0) { return null; } return result; } exports.locate = locate; function findAlignmentPattern(matrix, alignmentPatternQuads, topRight, topLeft, bottomLeft) { var _a; var dimension; var moduleSize; try { (_a = computeDimension(topLeft, topRight, bottomLeft, matrix), dimension = _a.dimension, moduleSize = _a.moduleSize); } catch (e) { return null; } var bottomRightFinderPattern = { x: topRight.x - topLeft.x + bottomLeft.x, y: topRight.y - topLeft.y + bottomLeft.y, }; var modulesBetweenFinderPatterns = ((distance(topLeft, bottomLeft) + distance(topLeft, topRight)) / 2 / moduleSize); var correctionToTopLeft = 1 - (3 / modulesBetweenFinderPatterns); var expectedAlignmentPattern = { x: topLeft.x + correctionToTopLeft * (bottomRightFinderPattern.x - topLeft.x), y: topLeft.y + correctionToTopLeft * (bottomRightFinderPattern.y - topLeft.y), }; var alignmentPatterns = alignmentPatternQuads.map(function (q) { var x = (q.top.startX + q.top.endX + q.bottom.startX + q.bottom.endX) / 4; var y = (q.top.y + q.bottom.y + 1) / 2; if (!matrix.get(Math.floor(x), Math.floor(y))) { return; } var sizeScore = scorePattern({ x: Math.floor(x), y: Math.floor(y) }, [1, 1, 1], matrix); var score = sizeScore + distance({ x: x, y: y }, expectedAlignmentPattern); return { x: x, y: y, score: score }; }).filter(function (v) { return !!v; }).sort(function (a, b) { return a.score - b.score; }); var alignmentPattern = modulesBetweenFinderPatterns >= 15 && alignmentPatterns.length ? alignmentPatterns[0] : expectedAlignmentPattern; return { alignmentPattern: alignmentPattern, dimension: dimension }; } })])["default"]; });
    </script>
    <style>
        :root {
            --primary-color: #0085ff;
            --primary-dark: #0066cc;
            --secondary-color: #2c2c2c;
            --background-color: #121212;
            --surface-color: #1e1e1e;
            --text-color: #e0e0e0;
            --text-secondary: #a0a0a0;
            --border-color: #333;
            --success-color: #28a745;
            --error-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            --container-padding: 15px;
            --border-radius: 10px
        }

        .light-theme {
            --primary-color: #0066cc;
            --primary-dark: #004999;
            --secondary-color: #f8f9fa;
            --background-color: #ffffff;
            --surface-color: #f5f5f5;
            --text-color: #212529;
            --text-secondary: #6c757d;
            --border-color: #dee2e6;
            --success-color: #28a745;
            --error-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.08)
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            -webkit-tap-highlight-color: transparent
        }

        body {
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
            padding: 10px;
            font-size: 14px;
            min-height: 100vh;
            direction: rtl;
            transition: background-color 0.3s, color 0.3s
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            background: var(--surface-color);
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            padding: var(--container-padding);
            transition: background-color 0.3s, box-shadow 0.3s;
            border: 1px solid var(--border-color);
            position: relative
        }

        .theme-toggle-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            height: 36px;
            width: 36px;
            padding: 0;
            position: absolute;
            left: 15px;
            top: -5px;
            z-index: 1000;
            outline: none !important;
            box-shadow: none !important;
            -webkit-tap-highlight-color: transparent !important;
            -webkit-tap-highlight-color: rgba(0, 0, 0, 0) !important;
            -webkit-user-select: none;
            -moz-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
            transition: transform 0.3s ease
        }

        .theme-toggle-btn:focus,
        .theme-toggle-btn:active,
        .theme-toggle-btn:hover,
        .theme-toggle-btn:focus-visible,
        .theme-toggle-btn:focus-within {
            outline: none !important;
            box-shadow: none !important;
            background-color: transparent !important;
            border: none !important
        }

        .theme-toggle-btn::-moz-focus-inner {
            border: 0 !important;
            padding: 0 !important
        }

        .theme-toggle-btn:hover {
            transform: scale(1.1)
        }

        .theme-toggle-btn .sun-icon {
            font-size: 18px;
            opacity: 1;
            transition: opacity 0.3s ease;
            position: absolute
        }

        .theme-toggle-btn .moon-icon {
            font-size: 16px;
            opacity: 0;
            transition: opacity 0.3s ease;
            position: absolute
        }

        .light-theme .theme-toggle-btn .sun-icon {
            opacity: 0
        }

        .light-theme .theme-toggle-btn .moon-icon {
            opacity: 1
        }

        .theme-toggle-btn::after {
            content: attr(data-tooltip);
            position: absolute;
            left: 100%;
            top: 50%;
            transform: translateY(-50%);
            margin-left: 8px;
            background: var(--secondary-color);
            color: var(--text-color);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            pointer-events: none
        }

        .theme-toggle-btn:hover::after {
            opacity: 1;
            visibility: visible
        }

        .connection-status {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            font-size: .9rem;
            justify-content: flex-start
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            transition: background-color 0.3s
        }

        #amount::placeholder {
            text-align: left !important;
            direction: ltr !important
        }

        .connected {
            background-color: var(--success-color)
        }

        .disconnected {
            background-color: var(--error-color)
        }

        .connecting {
            background-color: var(--warning-color)
        }

        .server-info {
            display: none !important;
            font-size: .8rem;
            color: var(--text-secondary);
            margin-top: 5px
        }

        .tab {
            overflow: hidden;
            border: 1px solid var(--border-color);
            background-color: var(--secondary-color);
            border-radius: 4px;
            display: flex;
            flex-wrap: wrap;
            transition: background-color 0.3s, border-color 0.3s
        }

        .tab button {
            background-color: inherit;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 12px 14px;
            transition: .3s;
            color: var(--text-color);
            margin: 0;
            flex: 1;
            min-width: 80px;
            font-size: .85rem;
            min-height: 44px
        }

        .tab button:hover {
            background-color: var(--primary-color);
            color: #fff
        }

        .tab button.active {
            background-color: var(--primary-color);
            color: #fff
        }

        .tabcontent {
            display: none;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-top: none;
            border-radius: 0 0 4px 4px;
            animation: fadeEffect 1s
        }

        .wallet-info {
            margin-bottom: 15px;
            padding: 12px;
            background-color: var(--secondary-color);
            border-radius: 8px;
            position: relative;
            transition: background-color 0.3s;
            border: 1px solid var(--border-color)
        }

        .balance-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 15px 0;
            padding: 15px;
            background: linear-gradient(135deg, var(--secondary-color)0%, var(--surface-color)100%);
            border-radius: var(--border-radius);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-color)
        }

        .light-theme .balance-container {
            background: linear-gradient(135deg, #e9ecef 0%, #f8f9fa 100%)
        }

        .balance-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color)
        }

        .light-theme .balance-row {
            border-bottom: 1px solid rgba(0, 0, 0, 0.1)
        }

        .balance-row:last-child {
            border-bottom: none
        }

        .balance-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px
        }

        .balance-title {
            font-size: .9rem;
            color: var(--text-secondary);
            font-weight: 500
        }

        .balance-value {
            font-weight: bold;
            direction: ltr;
            display: flex;
            align-items: center;
            gap: 5px
        }

        #showDecryptionKeyboardBtn,
        #showKeyboardBtn {
            display: none !important
        }

        .xrp-balance {
            font-size: 1.4rem;
            color: var(--primary-color)
        }

        .xrp-usd-balance {
            font-size: 1.1rem;
            color: var(--text-secondary);
            margin-top: 5px;
            direction: ltr;
            text-align: center;
            word-break: break-word;
            overflow-wrap: break-word
        }

        .balance-label {
            font-size: .9rem;
            color: var(--text-secondary);
            font-weight: 500
        }

        .balance-loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0, 133, 255, .3);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
            margin-left: 10px;
            vertical-align: middle
        }

        .balance-footer {
            display: flex;
            justify-content: flex-end;
            margin-top: 10px;
            width: 100%
        }

        .balance-footer .balance-toggle-btn {
            margin: 0;
            min-height: auto;
            padding: 6px 12px;
            font-size: 12px
        }

        .balance-toggle-btn {
            background: none;
            border: 1px solid var(--warning-color);
            color: var(--warning-color);
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all .2s ease;
            min-height: auto;
            width: auto;
            margin: 0
        }

        .balance-toggle-btn:hover {
            background-color: var(--warning-color);
            color: #fff
        }

        .address-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin: 8px 0;
            width: 100%
        }

        .address {
            flex: 1;
            padding-left: 40px !important;
            text-align: left;
            direction: ltr;
            unicode-bidi: embed;
            word-break: break-all;
            font-family: monospace;
            padding: 12px;
            background: var(--secondary-color);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: .95rem;
            min-height: 60px;
            transition: all 0.3s
        }

        .light-theme .address {
            background: #ffffff
        }

        .form-group {
            margin-bottom: 12px
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            font-size: .9rem;
            color: var(--text-color)
        }

        input[type="text"],
        input[type="number"],
        input[type="password"],
        textarea {
            width: 100%;
            padding: 12px;
            background-color: var(--secondary-color);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 16px;
            min-height: 44px;
            transition: background-color 0.3s, border-color 0.3s, color 0.3s;
            text-align: left;
            direction: ltr;
            unicode-bidi: embed
        }

        .light-theme input[type="text"],
        .light-theme input[type="number"],
        .light-theme input[type="password"],
        .light-theme textarea {
            background: #ffffff
        }

        .ltr-direction {
            direction: ltr;
            text-align: left;
            unicode-bidi: embed
        }

        .en-input {
            text-align: left;
            direction: ltr
        }

        .fa-input {
            text-align: right;
            direction: rtl
        }

        button {
            background-color: var(--primary-color);
            color: #fff;
            border: none;
            padding: 14px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
            transition: background-color .3s;
            min-height: 44px;
            min-width: 44px;
            width: 100%
        }

        button:hover {
            opacity: .9;
            background-color: var(--primary-dark)
        }

        button:disabled {
            background-color: #555;
            cursor: not-allowed
        }

        .light-theme button:disabled {
            background-color: #adb5bd
        }

        .copy-btn {
            background: none;
            border: 1px solid var(--success-color);
            cursor: pointer;
            color: var(--success-color);
            font-size: 14px;
            padding: 8px 12px;
            border-radius: 4px;
            transition: all .2s ease;
            min-height: 44px;
            min-width: 44px;
            width: auto;
            align-self: flex-end
        }

        .copy-btn:hover {
            background-color: var(--success-color);
            color: #fff
        }

        .copy-btn.copied {
            background-color: var(--success-color);
            color: #fff
        }

        .private-key-group {
            position: relative;
            display: flex;
            flex-direction: column;
            gap: 8px
        }

        .private-key-input {
            flex: 1;
            padding-left: 40px !important;
            text-align: left;
            direction: ltr;
            unicode-bidi: embed
        }

        .private-key-actions {
            display: flex;
            gap: 8px;
            align-self: flex-end;
            flex-wrap: wrap;
            justify-content: center
        }

        .private-key-btn {
            background: none;
            border: 1px solid var(--primary-color);
            cursor: pointer;
            color: var(--primary-color);
            font-size: 14px;
            padding: 8px 12px;
            border-radius: 4px;
            transition: all .2s ease;
            min-height: 44px;
            min-width: 44px;
            white-space: nowrap;
            flex: 1;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center
        }

        .private-key-btn.copy {
            border-color: var(--success-color);
            color: var(--success-color)
        }

        .private-key-btn.toggle {
            border-color: var(--warning-color);
            color: var(--warning-color)
        }

        .private-key-btn.qr-scanner {
            border-color: var(--info-color);
            color: var(--info-color)
        }

        .private-key-btn.upload {
            border-color: var(--success-color);
            color: var(--success-color)
        }

        .private-key-btn:hover {
            background-color: var(--primary-color);
            color: #fff
        }

        .private-key-btn.copy:hover {
            background-color: var(--success-color);
            color: #fff
        }

        .private-key-btn.toggle:hover {
            background-color: var(--warning-color);
            color: #fff
        }

        .private-key-btn.qr-scanner:hover {
            background-color: var(--info-color);
            color: #fff
        }

        .private-key-btn.upload:hover {
            background-color: var(--success-color);
            color: #fff
        }

        .wallet-actions {
            display: flex;
            flex-direction: column;
            gap: 10px
        }

        .wallet-actions button {
            flex: 1
        }

        input::placeholder,
        textarea::placeholder {
            text-align: right;
            direction: rtl
        }

        input:focus::placeholder,
        textarea:focus::placeholder {
            opacity: 0
        }

        .amount-input-group {
            position: relative;
            display: flex;
            flex-direction: column;
            gap: 8px
        }

        .amount-actions {
            display: flex;
            gap: 8px;
            align-self: flex-end
        }

        .amount-btn {
            background: none;
            border: 1px solid var(--info-color);
            cursor: pointer;
            color: var(--info-color);
            font-size: 12px;
            padding: 8px 12px;
            border-radius: 4px;
            transition: all .2s ease;
            min-height: 44px;
            min-width: 44px
        }

        .amount-btn:hover {
            background-color: var(--info-color);
            color: #fff
        }

        .input-with-scanner {
            display: flex;
            gap: 10px;
            align-items: stretch
        }

        .input-with-scanner input {
            flex: 1;
            text-align: left;
            direction: ltr;
            unicode-bidi: embed
        }

        .input-with-scanner button {
            width: auto;
            min-width: 44px;
            margin: 0
        }

        #encryptionPassword {
            text-align: left !important;
            direction: ltr !important;
            unicode-bidi: embed !important
        }

        #encryptionPassword::placeholder {
            text-align: right !important;
            direction: rtl !important
        }

        .disable-tag-container {
            display: flex;
            align-items: center;
            margin-bottom: 10px
        }

        .disable-tag-container input[type="checkbox"] {
            margin-right: 8px;
            width: 18px;
            height: 18px
        }

        .destination-tag-group {
            transition: opacity .3s ease
        }

        .destination-tag-group.disabled {
            opacity: .6;
            pointer-events: none
        }

        .fee-info {
            background-color: rgba(23, 162, 184, .1);
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            border: 1px solid rgba(23, 162, 184, .2);
            font-size: .9rem;
            color: var(--info-color)
        }

        .transaction-history {
            margin-top: 20px
        }

        .transaction {
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 8px;
            border-radius: 5px;
            background-color: var(--secondary-color);
            font-size: .85rem;
            transition: background-color 0.3s, border-color 0.3s
        }

        .light-theme .transaction {
            background: #f8f9fa
        }

        .transaction-header {
            display: flex;
            justify-content: space-between;
            align-items: center
        }

        .transaction-details {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px
        }

        .transaction-detail {
            display: flex;
            justify-content: space-between;
            align-items: center
        }

        .transaction-type {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            display: inline-block;
            margin-bottom: 5px
        }

        .transaction-type.payment {
            background-color: rgba(40, 167, 69, .2);
            color: var(--success-color)
        }

        .transaction-type.other {
            background-color: rgba(0, 122, 255, .2);
            color: var(--primary-color)
        }

        .transaction-status {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            display: inline-block;
            margin-bottom: 5px
        }

        .transaction-status.success {
            background-color: rgba(40, 167, 69, .2);
            color: var(--success-color)
        }

        .transaction-status.failed {
            background-color: rgba(220, 53, 69, .2);
            color: var(--error-color)
        }

        .transaction-status.pending {
            background-color: rgba(255, 193, 7, .2);
            color: var(--warning-color)
        }

        .transaction-hash {
            font-family: monospace;
            font-size: .8rem;
            word-break: break-all;
            direction: ltr;
            text-align: left;
            unicode-bidi: embed;
            color: var(--text-secondary);
            margin-top: 5px;
            padding: 5px;
            background-color: var(--secondary-color);
            border-radius: 3px
        }

        .light-theme .transaction-hash {
            background: #f8f9fa
        }

        .transaction-hash-label {
            font-weight: bold;
            color: var(--text-color)
        }

        .transaction-hash-value {
            color: var(--primary-color)
        }

        .transaction-hash-value a {
            color: var(--primary-color);
            text-decoration: none
        }

        .transaction-hash-value a:hover {
            text-decoration: underline
        }

        .search-container {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            align-items: stretch
        }

        .search-input {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--secondary-color);
            color: var(--text-color);
            font-size: 14px;
            min-height: 44px;
            transition: background-color 0.3s, border-color 0.3s, color 0.3s;
            text-align: left;
            direction: ltr;
            unicode-bidi: embed
        }

        .light-theme .search-input {
            background: #ffffff
        }

        .search-clear {
            padding: 10px 15px;
            background: var(--error-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            white-space: nowrap;
            min-height: 44px;
            min-width: 44px;
            transition: background-color 0.3s
        }

        .search-clear:hover {
            background-color: #c82333;
            opacity: 0.9
        }

        .search-info {
            display: none;
            font-size: .9rem;
            color: var(--text-secondary);
            margin-bottom: 10px
        }

        .alert {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            display: none;
            font-size: .9rem
        }

        .alert-success {
            background-color: rgba(40, 167, 69, .2);
            color: var(--success-color);
            border: 1px solid rgba(40, 167, 69, .3)
        }

        .alert-error {
            background-color: rgba(220, 53, 69, .2);
            color: var(--error-color);
            border: 1px solid rgba(220, 53, 69, .3)
        }

        .alert-warning {
            background-color: rgba(255, 193, 7, .2);
            color: var(--warning-color);
            border: 1px solid rgba(255, 193, 7, .3)
        }

        .alert-info {
            background-color: rgba(23, 162, 184, .2);
            color: var(--info-color);
            border: 1px solid rgba(23, 162, 184, .3)
        }

        .account-status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            background-color: rgba(255, 193, 7, .2);
            border: 1px solid rgba(255, 193, 7, .3);
            font-size: .9rem;
            color: var(--warning-color)
        }

        .loader {
            border: 4px solid var(--secondary-color);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 2s linear infinite;
            margin: 0 auto;
            display: none
        }

        .copy-notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--success-color);
            color: #fff;
            padding: 10px 20px;
            border-radius: 4px;
            z-index: 1000;
            display: none;
            animation: fadeInOut 2s ease-in-out
        }

        .confirmation-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, .7);
            z-index: 1000;
            justify-content: center;
            align-items: center
        }

        .confirmation-content {
            background-color: var(--surface-color);
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            box-shadow: var(--card-shadow);
            border: 1px solid var(--border-color)
        }

        .confirmation-header {
            text-align: center;
            margin-bottom: 20px;
            color: var(--primary-color);
            font-size: 1.2rem
        }

        .confirmation-details {
            margin-bottom: 20px;
            padding: 15px;
            background-color: var(--secondary-color);
            border-radius: 8px;
            border: 1px solid var(--border-color)
        }

        .confirmation-detail {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color)
        }

        .confirmation-detail:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0
        }

        .confirmation-label {
            font-weight: bold;
            color: var(--text-secondary)
        }

        .confirmation-value {
            direction: ltr;
            text-align: right;
            unicode-bidi: embed
        }

        .confirmation-actions {
            display: flex;
            gap: 10px
        }

        .confirmation-actions button {
            flex: 1;
            margin: 0
        }

        .btn-cancel {
            background-color: var(--error-color)
        }

        .btn-confirm {
            background-color: var(--success-color)
        }

        .tx-hash-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin: 15px 0
        }

        .tx-hash {
            word-break: break-all;
            font-family: monospace;
            padding: 12px;
            background: var(--secondary-color);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: .95rem;
            direction: ltr;
            text-align: left;
            unicode-bidi: embed;
            min-height: 60px;
            flex: 1
        }

        .light-theme .tx-hash {
            background: #ffffff
        }

        .qr-section {
            margin: 15px 0;
            text-align: center;
            display: none
        }

        .qr-toggle {
            background-color: var(--info-color);
            margin-bottom: 10px
        }

        .qr-container {
            padding: 15px;
            background: var(--surface-color);
            border-radius: var(--border-radius);
            box-shadow: 0 2px 5px rgba(0, 0, 0, .1);
            border: 1px solid var(--border-color)
        }

        #qrcode {
            margin: 0 auto;
            max-width: 200px
        }

        #qrcode canvas {
            max-width: 100%;
            height: auto;
            border: 1px solid var(--border-color);
            image-rendering: crisp-edges;
            image-rendering: pixelated;
            filter: contrast(1.2)brightness(1.1)
        }

        .qr-frame {
            border: 5px solid #2c3e50;
            border-radius: 8px;
            padding: 5px;
            background: #fff;
            box-shadow: 0 5px 15px #0003;
            display: inline-block;
            margin: 10px 0;
            position: relative
        }

        .qr-frame canvas {
            display: block;
            margin: 0 auto;
            border: 1px solid #ddd;
            padding: 10px;
            background-color: #fff;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            image-rendering: crisp-edges;
            image-rendering: pixelated;
            filter: contrast(1.2)brightness(1.1)
        }

        .qr-scanner-container {
            margin: 10px 0
        }

        .qr-scanner-btn {
            background-color: var(--info-color);
            margin-bottom: 10px
        }

        #recipient::placeholder {
            text-align: left !important;
            direction: ltr !important
        }

        .scanner-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, .9);
            z-index: 2000;
            justify-content: center;
            align-items: center
        }

        .scanner-content {
            background-color: var(--surface-color);
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            box-shadow: var(--card-shadow);
            border: 1px solid var(--border-color)
        }

        .scanner-header {
            text-align: center;
            margin-bottom: 20px;
            color: var(--primary-color);
            font-size: 1.2rem
        }

        .scanner-container {
            position: relative;
            width: 100%;
            max-width: 400px;
            margin: 20px auto;
            overflow: hidden;
            border-radius: 8px;
            box-shadow: 0 0 5px rgba(0, 0, 0, .2)
        }

        #qr-video {
            width: 100%;
            display: block
        }

        .scan-region {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 200px;
            border: 2px solid #3498db;
            border-radius: 5px;
            box-shadow: 0 0 0 4000px rgba(0, 0, 0, .3)
        }

        .scan-line {
            position: absolute;
            height: 2px;
            width: 100%;
            background-color: #3498db;
            animation: scan 2s linear infinite
        }

        .scanner-status {
            text-align: center;
            margin: 10px 0;
            font-weight: bold
        }

        .scanner-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px
        }

        .scanner-actions button {
            flex: 1;
            margin: 0
        }

        .camera-permission {
            text-align: center;
            padding: 20px;
            background: var(--secondary-color);
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid var(--border-color)
        }

        .hidden {
            display: none !important
        }

        .no-results {
            text-align: center;
            padding: 20px;
            color: var(--text-secondary)
        }

        .retrying {
            background-color: var(--warning-color)
        }

        @keyframes fadeEffect {
            from {
                opacity: 0
            }

            to {
                opacity: 1
            }
        }

        @keyframes fadeInOut {

            0%,
            100% {
                opacity: 0;
                transform: translateX(-50%)translateY(-20px)
            }

            10%,
            90% {
                opacity: 1;
                transform: translateX(-50%)translateY(0)
            }
        }

        @keyframes scan {
            0% {
                top: 0
            }

            50% {
                top: calc(100% - 2px)
            }

            100% {
                top: 0
            }
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg)
            }

            100% {
                transform: rotate(360deg)
            }
        }

        input:focus,
        textarea:focus {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px
        }

        .theme-toggle-btn:focus {
            outline: none !important;
            box-shadow: none !important
        }

        .virtual-keyboard-section {
            margin-top: 15px;
            padding: 15px;
            background-color: var(--secondary-color);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            overflow-x: auto
        }

        .virtual-keyboard-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 10px;
            min-width: min-content
        }

        .keyboard-row {
            display: flex;
            justify-content: center;
            gap: 5px;
            flex-wrap: nowrap
        }

        .keyboard-key {
            flex: 1;
            min-height: 40px;
            min-width: 30px;
            background-color: var(--surface-color);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 5px;
            white-space: nowrap;
            text-transform: lowercase
        }

        .keyboard-key:hover {
            background-color: var(--primary-color);
            color: #fff
        }

        .keyboard-key.special-key[data-key]:not([data-action]) {
            background-color: var(--surface-color);
            color: var(--text-color);
            flex: 1
        }

        .keyboard-key.special-key[data-key]:not([data-action]):hover {
            background-color: var(--primary-color);
            color: #fff
        }

        .keyboard-key.special-key[data-action] {
            background-color: var(--info-color);
            color: #fff;
            flex: 1.5
        }

        .keyboard-key.special-key[data-action]:hover {
            opacity: 0.9
        }

        .keyboard-key.shift-active {
            background-color: var(--info-color) !important;
            color: #fff !important;
            text-transform: uppercase
        }

        .keyboard-actions {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap
        }

        .keyboard-toggle-btn {
            background-color: var(--info-color);
            color: #fff;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
            min-height: 44px;
            min-width: 44px;
            width: auto
        }

        .keyboard-toggle-btn:hover {
            opacity: 0.9
        }

        #showDecryptionKeyboardBtn {
            background-color: var(--info-color);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
            min-height: 44px;
            min-width: 44px;
            width: auto;
            margin-top: 10px
        }

        #showDecryptionKeyboardBtn:hover {
            opacity: 0.9
        }

        @media (max-width: 480px) {
            .address-container {
                flex-direction: column;
            }

            .address-container input {
                font-size: .85rem;
                min-height: 50px;
                padding: 10px;
                width: 100%;
            }

            .copy-btn {
                width: 100%;
                font-size: 12px;
                padding: 10px;
                min-height: 44px;
                align-self: stretch;
            }

            .private-key-actions {
                flex-direction: column;
                width: 100%;
                gap: 10px;
            }

            .private-key-btn {
                width: 100%;
                font-size: 12px;
                padding: 10px;
                min-height: 44px;
            }

            .private-key-group {
                flex-direction: column;
                gap: 10px;
            }
        }

        @media (min-width: 481px) and (max-width: 767px) {
            .address-container {
                flex-direction: row;
                align-items: center;
            }

            .address-container input {
                font-size: .9rem;
                flex: 1;
            }

            .copy-btn {
                font-size: 12px;
                padding: 8px 12px;
                min-width: 120px;
                align-self: center;
                white-space: nowrap;
            }

            .private-key-actions {
                gap: 6px;
            }

            .private-key-btn {
                font-size: 12px;
                padding: 8px 10px;
                min-width: 100px;
            }
        }

        @media (min-width: 768px) {
            .address-container {
                flex-direction: row;
                align-items: center;
                gap: 10px;
            }

            .address-container input {
                font-size: 1rem;
                min-height: 70px;
                flex: 1;
            }

            .copy-btn {
                font-size: 13px;
                padding: 8px 12px;
                min-height: 44px;
                min-width: 44px;
                align-self: center;
                white-space: nowrap;
            }

            .private-key-actions {
                gap: 8px;
            }

            .private-key-btn {
                font-size: 14px;
                padding: 8px 12px;
                min-width: 120px;
            }
        }

        @media (max-width: 360px) {
            .address-container input {
                font-size: .8rem;
                padding: 8px;
                min-height: 45px;
            }

            .copy-btn {
                font-size: 10px;
                padding: 8px;
                min-height: 40px;
            }

            .private-key-btn {
                font-size: 11px;
                padding: 8px;
                min-height: 40px;
            }
        }

        @media (max-height: 480px) and (orientation: landscape) {
            .address-container input {
                min-height: 40px;
                padding: 8px;
                font-size: .8rem;
            }

            .copy-btn {
                min-height: 36px;
                font-size: 11px;
                padding: 6px 8px;
            }

            .private-key-btn {
                min-height: 36px;
                font-size: 11px;
                padding: 6px 8px;
            }
        }

        #GenerateTab .address-container {
            margin: 10px 0;
        }

        #GenerateTab .address-container input {
            background: var(--secondary-color);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 12px;
            font-family: monospace;
            direction: ltr;
            text-align: left;
            unicode-bidi: embed;
            word-break: break-all;
        }

        .light-theme #GenerateTab .address-container input {
            background: #ffffff;
        }

        #copyNewAddressBtn {
            background: none;
            border: 1px solid var(--success-color);
            cursor: pointer;
            color: var(--success-color);
            font-size: 14px;
            padding: 8px 12px;
            border-radius: 4px;
            transition: all .2s ease;
            min-height: 44px;
            min-width: 44px;
            white-space: nowrap;
        }

        #copyNewAddressBtn:hover {
            background-color: var(--success-color);
            color: #fff;
        }

        #copyNewAddressBtn.copied {
            background-color: var(--success-color);
            color: #fff;
        }

        #address {
            font-size: 0.85rem !important;
            padding: 9px 11px !important;
            min-height: 52px !important;
            line-height: 1.4 !important;
        }

        @media (max-width: 480px) {
            #address {
                font-size: 0.75rem !important;
                padding: 7px 9px !important;
                min-height: 47px !important;
            }
        }

        @media (max-height: 480px) and (orientation: landscape) {
            #address {
                font-size: 0.7rem !important;
                padding: 5px 7px !important;
                min-height: 42px !important;
            }
        }

        @media (min-width: 481px) and (max-width: 767px) {
            #address {
                font-size: 0.8rem !important;
            }
        }

        @media (min-width: 768px) {
            #address {
                font-size: 0.9rem !important;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 5px;
                font-size: 13px
            }

            .container {
                padding: 10px
            }

            .xrp-balance {
                font-size: 1.1rem
            }

            .xrp-usd-balance {
                font-size: 0.9rem;
                margin-top: 3px
            }

            .tab button {
                padding: 10px 8px;
                font-size: .8rem
            }

            button {
                padding: 12px 16px;
                font-size: 14px
            }

            .transaction {
                padding: 10px
            }

            .amount-btn {
                font-size: 10px;
                padding: 6px 8px
            }

            .search-container {
                flex-direction: column;
                gap: 10px
            }

            .search-clear {
                width: 100%;
                margin-top: 0
            }

            .theme-toggle-btn {
                height: 32px;
                width: 32px;
                left: 10px;
                top: -5px
            }

            .theme-toggle-btn .sun-icon,
            .theme-toggle-btn .moon-icon {
                font-size: 14px
            }

            .virtual-keyboard-section {
                padding: 10px
            }

            .keyboard-key {
                min-height: 35px;
                min-width: 25px;
                font-size: 12px;
                padding: 3px
            }

            .keyboard-toggle-btn {
                font-size: 12px;
                padding: 8px 12px
            }

            .keyboard-row {
                gap: 3px
            }

            .keyboard-key.special-key {
                font-size: 10px
            }

            #showDecryptionKeyboardBtn {
                font-size: 12px;
                padding: 8px 12px
            }
        }

        @media (min-width:768px) {
            body {
                padding: 20px;
                font-size: 16px
            }

            .container {
                max-width: 800px;
                padding: 25px
            }

            .address-container {
                flex-direction: row;
                align-items: stretch;
                gap: 10px
            }

            .address {
                font-size: 1rem;
                min-height: 70px
            }

            .copy-btn {
                font-size: 13px;
                padding: 10px 12px;
                min-height: 44px;
                min-width: 44px
            }

            .wallet-actions {
                flex-direction: row
            }

            .transaction-header {
                flex-direction: row;
                justify-content: space-between
            }

            .transaction-details {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 10px
            }

            .transaction-detail {
                flex-direction: row;
                justify-content: space-between
            }

            .tab {
                flex-wrap: nowrap
            }

            .private-key-group {
                flex-direction: row;
                align-items: center
            }

            .private-key-actions {
                align-self: center
            }

            .tx-hash-container {
                flex-direction: row;
                align-items: stretch;
                gap: 10px
            }

            .amount-input-group {
                flex-direction: row;
                align-items: center
            }

            .amount-actions {
                align-self: center
            }

            .search-container {
                flex-direction: row;
                align-items: center
            }

            .search-input {
                flex: 3;
                font-size: 16px
            }

            .search-clear {
                flex: 1;
                max-width: 120px;
                font-size: 14px;
                padding: 10px 12px
            }

            .theme-toggle-btn {
                height: 40px;
                width: 40px;
                left: 20px;
                top: -5px
            }

            .theme-toggle-btn .sun-icon,
            .theme-toggle-btn .moon-icon {
                font-size: 20px
            }
        }

        @media (min-width:481px) and (max-width:767px) {
            .xrp-usd-balance {
                font-size: 1rem
            }

            .theme-toggle-btn {
                height: 36px;
                width: 36px;
                left: 15px;
                top: -5px
            }

            .theme-toggle-btn .sun-icon,
            .theme-toggle-btn .moon-icon {
                font-size: 18px
            }

            .keyboard-key {
                min-height: 38px;
                font-size: 13px
            }
        }

        @media (max-height:480px) and (orientation:landscape) {
            .xrp-usd-balance {
                font-size: 0.85rem;
                margin-top: 2px
            }

            .container {
                padding: 10px
            }

            .theme-toggle-btn {
                height: 32px;
                width: 32px;
                left: 10px;
                top: -5px
            }

            .theme-toggle-btn .sun-icon,
            .theme-toggle-btn .moon-icon {
                font-size: 14px
            }

            .virtual-keyboard-section {
                padding: 8px
            }

            .keyboard-key {
                min-height: 30px;
                font-size: 11px
            }

            .keyboard-toggle-btn {
                min-height: 36px;
                font-size: 12px;
                padding: 6px 10px
            }
        }

        @media (max-width:360px) {
            .keyboard-key {
                min-height: 30px;
                min-width: 20px;
                font-size: 10px;
                padding: 2px
            }

            .virtual-keyboard-section {
                padding: 8px
            }

            .keyboard-key.special-key {
                font-size: 9px
            }
        }

        @media print {

            .tab,
            .wallet-actions,
            .scanner-modal,
            .confirmation-modal {
                display: none !important
            }

            .tabcontent {
                display: block !important;
                border: none
            }

            .container {
                box-shadow: none
            }
        }

        #importWalletBtn {
            background-color: var(--success-color) !important;
        }

        #importWalletBtn:hover {
            background-color: #218838 !important;
            opacity: 0.9 !important;
        }

        #useNewWalletBtn {
            background-color: var(--success-color) !important;
        }

        #useNewWalletBtn:hover {
            background-color: #218838 !important;
            opacity: 0.9 !important;
        }
    </style>
</head>

<body>
    <div class="container">
        <form autocomplete="off" onsubmit="return false;">
            <button class="theme-toggle-btn" id="themeToggle"></button>
            <div class="connection-status">
                <span>وضعیت اتصال:</span>
                <div class="status-indicator disconnected" id="connectionStatus"></div>
                <span id="connectionText">قطع ارتباط</span>
            </div>
            <div class="server-info" id="serverInfo"></div>
            <div class="tab">
                <button class="tablinks active" onclick="openTab(event, 'WalletTab')">کیف پول</button>
                <button class="tablinks" onclick="openTab(event, 'SendTab')">ارسال</button>
                <button class="tablinks" onclick="openTab(event, 'TransactionsTab')">تراکنش‌ها</button>
                <button class="tablinks" onclick="openTab(event, 'GenerateTab')">ایجاد کیف پول جدید</button>
            </div>
            <div class="tabcontent" id="WalletTab" style="display: block;">
                <div class="form-group">
                    <label for="privateKeyInput">کلید خصوصی (Seed) رمزگذاری شده:</label>
                    <div class="private-key-group">
                        <input class="private-key-input" id="privateKeyInput" placeholder="...متن رمزگذاری شده"
                            type="text" />
                        <div class="private-key-actions">
                            <button class="private-key-btn qr-scanner" id="scanPrivateKeyBtn"
                                title="اسکن QR کلید خصوصی">اسکن QR</button>
                            <button class="private-key-btn upload" id="uploadPrivateKeyBtn"
                                title="بارگذاری از حافظه">بارگذاری از حافظه</button>
                        </div>
                        <input type="file" id="privateKeyFileInput" accept=".png,image/png" style="display: none;" />
                    </div>
                    <div class="input-group" style="margin-top: 10px;">
                        <label for="encryptionPassword">رمز عبور برای رمزگشایی:</label>
                        <input class="ltr-direction" id="encryptionPassword"
                            placeholder="...رمز عبور رمزگذاری را وارد کنید" type="password" autocomplete="new-password"
                            readonly onfocus="this.blur()" />
                        <button type="button" class="keyboard-toggle-btn" id="showDecryptionKeyboardBtn"
                            style="margin-top: 10px; width: auto;">کیبورد مجازی</button>
                    </div>
                    <button id="importWalletBtn">وارد کردن کلید</button>
                </div>

                <div class="virtual-keyboard-section" id="decryptionKeyboardSection" style="display: none;">
                    <div class="virtual-keyboard-container">
                        <div class="keyboard-row">
                            <button class="keyboard-key" data-key="0">0</button>
                            <button class="keyboard-key" data-key="9">9</button>
                            <button class="keyboard-key" data-key="8">8</button>
                            <button class="keyboard-key" data-key="7">7</button>
                            <button class="keyboard-key" data-key="6">6</button>
                            <button class="keyboard-key" data-key="5">5</button>
                            <button class="keyboard-key" data-key="4">4</button>
                            <button class="keyboard-key" data-key="3">3</button>
                            <button class="keyboard-key" data-key="2">2</button>
                            <button class="keyboard-key" data-key="1">1</button>
                        </div>
                        <div class="keyboard-row">
                            <button class="keyboard-key" data-key="p">P</button>
                            <button class="keyboard-key" data-key="o">O</button>
                            <button class="keyboard-key" data-key="i">I</button>
                            <button class="keyboard-key" data-key="u">U</button>
                            <button class="keyboard-key" data-key="y">Y</button>
                            <button class="keyboard-key" data-key="t">T</button>
                            <button class="keyboard-key" data-key="r">R</button>
                            <button class="keyboard-key" data-key="e">E</button>
                            <button class="keyboard-key" data-key="w">W</button>
                            <button class="keyboard-key" data-key="q">Q</button>
                        </div>
                        <div class="keyboard-row">
                            <button class="keyboard-key" data-key="l">L</button>
                            <button class="keyboard-key" data-key="k">K</button>
                            <button class="keyboard-key" data-key="j">J</button>
                            <button class="keyboard-key" data-key="h">H</button>
                            <button class="keyboard-key" data-key="g">G</button>
                            <button class="keyboard-key" data-key="f">F</button>
                            <button class="keyboard-key" data-key="d">D</button>
                            <button class="keyboard-key" data-key="s">S</button>
                            <button class="keyboard-key" data-key="a">A</button>
                            <button class="keyboard-key special-key" data-action="backspace">⌫</button>
                        </div>
                        <div class="keyboard-row">
                            <button class="keyboard-key" data-key="m">M</button>
                            <button class="keyboard-key" data-key="n">N</button>
                            <button class="keyboard-key" data-key="b">B</button>
                            <button class="keyboard-key" data-key="v">V</button>
                            <button class="keyboard-key" data-key="c">C</button>
                            <button class="keyboard-key" data-key="x">X</button>
                            <button class="keyboard-key" data-key="z">Z</button>
                            <button class="keyboard-key special-key" data-action="clear">پاک کردن</button>
                        </div>
                        <div class="keyboard-row">
                            <button class="keyboard-key special-key" data-action="shift">⇧</button>
                            <button class="keyboard-key special-key" data-key="*">*</button>
                            <button class="keyboard-key special-key" data-key="&">&</button>
                            <button class="keyboard-key special-key" data-key="^">^</button>
                            <button class="keyboard-key special-key" data-key="%">%</button>
                            <button class="keyboard-key special-key" data-key="$">$</button>
                            <button class="keyboard-key special-key" data-key="#">#</button>
                            <button class="keyboard-key special-key" data-key="@">@</button>
                            <button class="keyboard-key special-key" data-key="!">!</button>
                            <button class="keyboard-key special-key" data-action="enter">تأیید</button>
                        </div>
                    </div>
                    <div class="keyboard-actions">
                        <button class="keyboard-toggle-btn" id="hideDecryptionKeyboardBtn">بستن کیبورد</button>
                    </div>
                </div>

                <div class="wallet-info" id="walletInfoDiv" style="display: none;">
                    <div class="balance-container">
                        <div class="balance-row">
                            <div class="balance-header">
                                <span class="balance-title">کل موجودی XRP:</span>
                            </div>
                            <div class="balance-value xrp-balance" id="xrpBalance">
                                <span class="balance-loading" id="balanceLoading"></span>
                                <span id="balanceText">0.000000</span>
                            </div>
                        </div>
                        <div class="balance-value xrp-usd-balance" id="usdBalance">$0.00</div>
                        <div class="balance-footer">
                            <button class="balance-toggle-btn" id="toggleBalanceBtn" title="مخفی/نمایش موجودی">مخفی کردن
                                موجودی</button>
                        </div>
                    </div>
                    <div>آدرس کیف پول:</div>
                    <div class="address-container">
                        <div class="address" id="address">r...</div>
                        <button class="copy-btn" disabled="" id="copyAddressBtn">کپی آدرس کیف پول</button>
                    </div>
                    <div class="qr-section" id="qrSection">
                        <button class="qr-toggle" id="toggleQR">نمایش بارکد آدرس</button>
                        <div class="qr-container" id="qrContainer" style="display: none;">
                            <div id="qrcode"></div>
                            <p style="margin-top: 10px; font-size: 0.8rem;">اسکن کنید برای ارسال XRP</p>
                        </div>
                    </div>
                </div>
                <div class="account-status" id="accountStatus" style="display: none;">
                    <strong>وضعیت حساب:</strong>
                    <span id="statusMessage">در حال بررسی...</span>
                </div>
                <div class="wallet-actions">
                    <button id="refreshBtn">بروزرسانی موجودی</button>
                    <button id="disconnectBtn" style="background-color: var(--error-color); display: none;">قطع
                        اتصال</button>
                </div>
            </div>
            <div class="tabcontent" id="SendTab">
                <div class="alert alert-info" id="sendInfoAlert">برای ارسال تراکنش، ابتدا باید حساب ریپل شما با واریز
                    حداقل 1 XRP فعال شود</div>
                <div class="form-group">
                    <label for="recipient">آدرس گیرنده:</label>
                    <div class="input-with-scanner">
                        <input id="recipient" oninput="validateRecipientAddress()" placeholder="r..." type="text"
                            class="recipient-input" />
                        <button class="qr-scanner-btn" id="scanRecipientBtn" title="اسکن QR آدرس گیرنده">اسکن
                            QR</button>
                    </div>
                </div>
                <div class="form-group">
                    <label for="amount">مبلغ (XRP):</label>
                    <div class="amount-input-group">
                        <input id="amount" min="0" oninput="validateAmount()" placeholder="0.0" step="0.1"
                            type="number" />
                        <div class="amount-actions">
                            <button class="amount-btn" id="useMaxAmountBtn"
                                title="استفاده از کل موجودی قابل استفاده">انتخاب کل موجودی قابل استفاده</button>
                        </div>
                    </div>
                </div>
                <div class="disable-tag-container">
                    <input id="disableDestinationTag" onchange="toggleDestinationTag()" type="checkbox" />
                    <label for="disableDestinationTag">عدم استفاده از تگ مقصد</label>
                </div>
                <div class="form-group destination-tag-group" id="destinationTagGroup">
                    <label for="destinationTag">تگ مقصد (اختیاری):</label>
                    <div class="input-with-scanner">
                        <input id="destinationTag" min="0"
                            placeholder="در صورتیکه می‌خواهید به صرافی واریز کنید حتماً تگ مقصد را به درستی وارد کنید"
                            type="number" />
                        <button class="qr-scanner-btn" id="scanDestinationTagBtn" title="اسکن QR تگ مقصد">اسکن
                            QR</button>
                    </div>
                </div>
                <div>مبلغ کل: <span id="totalAmount">0 XRP</span></div>
                <div class="fee-info">
                    <div>کارمزد شبکه: <span id="networkFee">0.00001 XRP</span></div>
                </div>
                <button disabled="" id="sendButton">ارسال</button>
                <div class="loader" id="sendLoader"></div>
                <div id="txSuccess" style="display: none;">
                    <div class="alert alert-success">تراکنش با موفقیت انجام شد!</div>
                    <div class="tx-hash-container">
                        <div class="tx-hash" id="txHash"></div>
                        <button class="copy-btn" id="copyTxHashBtn">کپی کد پیگیری</button>
                    </div>
                </div>
            </div>
            <div class="tabcontent" id="TransactionsTab">
                <h3>تاریخچه تراکنش‌ها</h3>
                <div class="search-container">
                    <input class="search-input" id="searchTransactions"
                        placeholder="جستجو در تراکنش‌ها (مبلغ، آدرس، هش، تاریخ)" type="text" />
                    <button class="search-clear" id="clearSearch">پاک کردن</button>
                </div>
                <div class="search-info" id="searchInfo" style="display: none;"></div>
                <div id="transactions">
                    <p>لطفاً ابتدا کلید خصوصی را وارد کنید...</p>
                </div>
                <button id="loadMoreBtn" style="display: none; margin-top: 15px;">بارگذاری تراکنش‌های بیشتر</button>
            </div>
            <div class="tabcontent" id="GenerateTab">
                <div class="form-group">
                    <label for="newPrivateKey">کلید خصوصی جدید:</label>
                    <div class="private-key-group">
                        <input class="private-key-input" id="newPrivateKey" readonly="" type="password" />
                        <div class="private-key-actions">
                            <button class="private-key-btn toggle" id="toggleNewKeyBtn">نمایش</button>
                            <button class="private-key-btn copy" id="copyNewPrivateKeyBtn">کپی</button>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="encryptedKeyDisplay">کلید خصوصی رمزگذاری شده:</label>
                    <div class="private-key-group">
                        <input class="private-key-input" id="encryptedKeyDisplay" readonly="" type="text" />
                        <div class="private-key-actions">
                            <button class="private-key-btn copy" id="copyEncryptedKeyBtn">کپی</button>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="newAddress">آدرس عمومی جدید:</label>
                    <div class="address-container">
                        <input id="newAddress" readonly="" type="text" />
                        <button class="copy-btn" id="copyNewAddressBtn">کپی</button>
                    </div>
                </div>
                <div class="form-group">
                    <label for="customPasswordInput">رمز عبور دلخواه:</label>
                    <div class="private-key-group">
                        <input id="customPasswordInput" placeholder="رمز عبور دلخواه خود را وارد کنید" type="password"
                            autocomplete="new-password" readonly onfocus="this.blur()" />
                    </div>
                </div>
                <div class="form-group">
                    <label for="confirmPasswordInput">تایید رمز عبور:</label>
                    <div class="private-key-group">
                        <input id="confirmPasswordInput" placeholder="رمز عبور خود را مجدداً وارد کنید" type="password"
                            autocomplete="new-password" readonly onfocus="this.blur()" />
                    </div>
                </div>

                <div class="form-group">
                    <button type="button" class="keyboard-toggle-btn" id="showKeyboardBtn">کیبورد مجازی</button>
                </div>

                <div class="virtual-keyboard-section" id="virtualKeyboardSection" style="display: none;">
                    <div class="virtual-keyboard-container">
                        <div class="keyboard-row">
                            <button class="keyboard-key" data-key="0">0</button>
                            <button class="keyboard-key" data-key="9">9</button>
                            <button class="keyboard-key" data-key="8">8</button>
                            <button class="keyboard-key" data-key="7">7</button>
                            <button class="keyboard-key" data-key="6">6</button>
                            <button class="keyboard-key" data-key="5">5</button>
                            <button class="keyboard-key" data-key="4">4</button>
                            <button class="keyboard-key" data-key="3">3</button>
                            <button class="keyboard-key" data-key="2">2</button>
                            <button class="keyboard-key" data-key="1">1</button>
                        </div>
                        <div class="keyboard-row">
                            <button class="keyboard-key" data-key="p">P</button>
                            <button class="keyboard-key" data-key="o">O</button>
                            <button class="keyboard-key" data-key="i">I</button>
                            <button class="keyboard-key" data-key="u">U</button>
                            <button class="keyboard-key" data-key="y">Y</button>
                            <button class="keyboard-key" data-key="t">T</button>
                            <button class="keyboard-key" data-key="r">R</button>
                            <button class="keyboard-key" data-key="e">E</button>
                            <button class="keyboard-key" data-key="w">W</button>
                            <button class="keyboard-key" data-key="q">Q</button>
                        </div>
                        <div class="keyboard-row">
                            <button class="keyboard-key" data-key="l">L</button>
                            <button class="keyboard-key" data-key="k">K</button>
                            <button class="keyboard-key" data-key="j">J</button>
                            <button class="keyboard-key" data-key="h">H</button>
                            <button class="keyboard-key" data-key="g">G</button>
                            <button class="keyboard-key" data-key="f">F</button>
                            <button class="keyboard-key" data-key="d">D</button>
                            <button class="keyboard-key" data-key="s">S</button>
                            <button class="keyboard-key" data-key="a">A</button>
                            <button class="keyboard-key special-key" data-action="backspace">⌫</button>
                        </div>
                        <div class="keyboard-row">
                            <button class="keyboard-key" data-key="m">M</button>
                            <button class="keyboard-key" data-key="n">N</button>
                            <button class="keyboard-key" data-key="b">B</button>
                            <button class="keyboard-key" data-key="v">V</button>
                            <button class="keyboard-key" data-key="c">C</button>
                            <button class="keyboard-key" data-key="x">X</button>
                            <button class="keyboard-key" data-key="z">Z</button>
                            <button class="keyboard-key special-key" data-action="clear">پاک کردن</button>
                        </div>
                        <div class="keyboard-row">
                            <button class="keyboard-key special-key" data-action="shift">⇧</button>
                            <button class="keyboard-key special-key" data-key="*">*</button>
                            <button class="keyboard-key special-key" data-key="&">&</button>
                            <button class="keyboard-key special-key" data-key="^">^</button>
                            <button class="keyboard-key special-key" data-key="%">%</button>
                            <button class="keyboard-key special-key" data-key="$">$</button>
                            <button class="keyboard-key special-key" data-key="#">#</button>
                            <button class="keyboard-key special-key" data-key="@">@</button>
                            <button class="keyboard-key special-key" data-key="!">!</button>
                            <button class="keyboard-key special-key" data-action="enter">تأیید</button>
                        </div>
                    </div>
                    <div class="keyboard-actions">
                        <button class="keyboard-toggle-btn" id="hideKeyboardBtn">بستن کیبورد</button>
                    </div>
                </div>

                <button id="generateWalletBtn">ایجاد کیف پول جدید</button>
                <button id="useNewWalletBtn" style="display: none;">استفاده از این کیف پول</button>
            </div>
            <div class="alert" id="alert"></div>
            <div class="copy-notification" id="copyNotification">آدرس با موفقیت کپی شد!</div>
            <div class="copy-notification" id="privateKeyCopyNotification">کلید خصوصی با موفقیت کپی شد!</div>
            <div class="copy-notification" id="txHashCopyNotification">کد پیگیری با موفقیت کپی شد!</div>
            <div class="copy-notification" id="encryptedKeyCopyNotification">کلید خصوصی رمزگذاری شده کپی شد!</div>
            <div class="confirmation-modal" id="confirmationModal">
                <div class="confirmation-content">
                    <div class="confirmation-header">
                        <h3>تأیید تراکنش</h3>
                    </div>
                    <div class="confirmation-details">
                        <div class="confirmation-detail">
                            <span class="confirmation-label">گیرنده:</span>
                            <span class="confirmation-value" id="confirmRecipient"></span>
                        </div>
                        <div class="confirmation-detail">
                            <span class="confirmation-label">مبلغ:</span>
                            <span class="confirmation-value" id="confirmAmount"></span>
                        </div>
                        <div class="confirmation-detail">
                            <span class="confirmation-label">تگ مقصد:</span>
                            <span class="confirmation-value" id="confirmDestinationTag"></span>
                        </div>
                        <div class="confirmation-detail">
                            <span class="confirmation-label">کارمزد شبکه:</span>
                            <span class="confirmation-value" id="confirmFee"></span>
                        </div>
                        <div class="confirmation-detail">
                            <span class="confirmation-label">کل مبلغ:</span>
                            <span class="confirmation-value" id="confirmTotal"></span>
                        </div>
                    </div>
                    <div class="confirmation-actions">
                        <button class="btn-cancel" id="cancelTransaction">لغو</button>
                        <button class="btn-confirm" id="confirmTransaction">تأیید و ارسال</button>
                    </div>
                </div>
            </div>
            <div class="scanner-modal" id="scannerModal">
                <div class="scanner-content">
                    <div class="scanner-header">
                        <h3>اسکنر بارکد QR</h3>
                    </div>
                    <div class="camera-permission" id="cameraPermission">برای استفاده از اسکنر، لطفاً اجازه دسترسی به
                        دوربین را بدهید.</div>
                    <div class="scanner-container hidden" id="scannerContainer">
                        <video id="qr-video" playsinline=""></video>
                        <div class="scan-region">
                            <div class="scan-line"></div>
                        </div>
                    </div>
                    <div class="scanner-status" id="scannerStatus">در حال آماده‌سازی اسکنر...</div>
                    <div class="scanner-actions">
                        <button class="btn-cancel" id="closeScanner">بستن</button>
                    </div>
                </div>
            </div>
        </form>
    </div>
    <script>
        const DROPS_PER_XRP = 1000000;
        const RESERVE_AMOUNT = 1;

        const PBKDF2_ITERATIONS = 310000;
        const PBKDF2_KEY_LENGTH = 256;
        const SALT_LENGTH = 16;
        const IV_LENGTH = 12;
        const AUTH_TAG_LENGTH = 16;

        function checkXrplAvailability() {
            if (typeof xrpl === 'undefined' && typeof window.xrpl === 'undefined') {
                showAlert('خطا: کتابخانه XRPL بارگذاری نشده است', false);
                return false;
            }
            return true;
        }

        function getXrpl() {
            const xrplLib = window.xrpl || (typeof xrpl !== 'undefined' ? xrpl : null);
            if (!xrplLib) {
                throw new Error('XRPL library is not loaded');
            }
            return xrplLib;
        }

        const CONNECTION_SETTINGS = {
            servers: [
                'wss://s1.ripple.com/',
                'wss://s2.ripple.com/',
                'wss://xrplcluster.com/',
                'wss://xrpl.ws/'
            ],
            connectionTimeout: 10000,
            maxRetries: 3,
            retryDelay: 3000,
            currentServerIndex: 0
        };

        let api = null;
        let currentAddress = '';
        let currentBalance = 0;
        let usableBalance = 0;
        let wallet = null;
        let isAccountActivated = false;
        let connectionRetries = 0;
        let networkFee = 0.00001;
        let isConnected = false;
        let currentServerUrl = '';
        let connectionCheckInterval = null;
        let pendingTransaction = null;
        let lastTransactionHash = null;
        let allTransactions = [];
        let filteredTransactions = [];
        let isBalanceHidden = localStorage.getItem('balanceHidden') === 'true';
        let toggleBalanceBtn = null;
        let currentScannerTarget = null;
        let scannerStream = null;
        let scanning = false;

        const themeToggleBtn = document.getElementById('themeToggle');
        themeToggleBtn.setAttribute('tabindex', '-1');
        const sunIcon = document.createElement('span');
        sunIcon.className = 'sun-icon';
        sunIcon.innerHTML = '☀️';
        const moonIcon = document.createElement('span');
        moonIcon.className = 'moon-icon';
        moonIcon.innerHTML = '🌙';
        themeToggleBtn.appendChild(sunIcon);
        themeToggleBtn.appendChild(moonIcon);
        const currentTheme = localStorage.getItem('theme') || 'dark';
        if (currentTheme === 'light') {
            document.body.classList.add('light-theme');
            themeToggleBtn.setAttribute('data-tooltip', 'تغییر به حالت شب');
        } else {
            themeToggleBtn.setAttribute('data-tooltip', 'تغییر به حالت روز');
        }
        themeToggleBtn.addEventListener('click', function () {
            this.classList.add('pulse');
            this.classList.add('loading');
            setTimeout(() => {
                document.body.classList.toggle('light-theme');
                if (document.body.classList.contains('light-theme')) {
                    localStorage.setItem('theme', 'light');
                    this.setAttribute('data-tooltip', 'تغییر به حالت شب');
                } else {
                    localStorage.setItem('theme', 'dark');
                    this.setAttribute('data-tooltip', 'تغییر به حالت روز');
                }
                this.classList.remove('pulse');
                this.classList.remove('loading');
            }, 300);
        });
        themeToggleBtn.addEventListener('animationend', function () {
            this.classList.remove('pulse');
        });

        const balanceElement = document.getElementById('balanceText');
        const xrpBalanceElement = document.getElementById('xrpBalance');
        const balanceLoadingElement = document.getElementById('balanceLoading');
        const addressElement = document.getElementById('address');
        const copyAddressBtn = document.getElementById('copyAddressBtn');
        const connectionStatusElement = document.getElementById('connectionStatus');
        const connectionTextElement = document.getElementById('connectionText');
        const refreshBtn = document.getElementById('refreshBtn');
        const sendButton = document.getElementById('sendButton');
        const sendLoader = document.getElementById('sendLoader');
        const alertElement = document.getElementById('alert');
        const transactionsContainer = document.getElementById('transactions');
        const accountStatus = document.getElementById('accountStatus');
        const statusMessage = document.getElementById('statusMessage');
        const copyNotification = document.getElementById('copyNotification');
        const privateKeyCopyNotification = document.getElementById('privateKeyCopyNotification');
        const txHashCopyNotification = document.getElementById('txHashCopyNotification');
        const networkFeeElement = document.getElementById('networkFee');
        const totalAmountElement = document.getElementById('totalAmount');
        const loadMoreBtn = document.getElementById('loadMoreBtn');
        const sendInfoAlert = document.getElementById('sendInfoAlert');
        const privateKeyInput = document.getElementById('privateKeyInput');
        const importWalletBtn = document.getElementById('importWalletBtn');
        const walletInfoDiv = document.getElementById('walletInfoDiv');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const generateWalletBtn = document.getElementById('generateWalletBtn');
        const newPrivateKey = document.getElementById('newPrivateKey');
        const newAddress = document.getElementById('newAddress');
        const copyNewAddressBtn = document.getElementById('copyNewAddressBtn');
        const useNewWalletBtn = document.getElementById('useNewWalletBtn');
        const copyNewPrivateKeyBtn = document.getElementById('copyNewPrivateKeyBtn');
        const serverInfoElement = document.getElementById('serverInfo');
        const confirmationModal = document.getElementById('confirmationModal');
        const confirmRecipient = document.getElementById('confirmRecipient');
        const confirmAmount = document.getElementById('confirmAmount');
        const confirmDestinationTag = document.getElementById('confirmDestinationTag');
        const confirmFee = document.getElementById('confirmFee');
        const confirmTotal = document.getElementById('confirmTotal');
        const cancelTransactionBtn = document.getElementById('cancelTransaction');
        const confirmTransactionBtn = document.getElementById('confirmTransaction');
        const txSuccess = document.getElementById('txSuccess');
        const txHashElement = document.getElementById('txHash');
        const copyTxHashBtn = document.getElementById('copyTxHashBtn');
        const recipientInput = document.getElementById('recipient');
        const amountInput = document.getElementById('amount');
        const destinationTagInput = document.getElementById('destinationTag');
        const disableDestinationTagCheckbox = document.getElementById('disableDestinationTag');
        const destinationTagGroup = document.getElementById('destinationTagGroup');
        const useMaxAmountBtn = document.getElementById('useMaxAmountBtn');
        const qrSection = document.getElementById('qrSection');
        const toggleQRBtn = document.getElementById('toggleQR');
        const qrContainer = document.getElementById('qrContainer');
        const qrcodeElement = document.getElementById('qrcode');
        const searchInput = document.getElementById('searchTransactions');
        const clearSearchBtn = document.getElementById('clearSearch');
        const searchInfo = document.getElementById('searchInfo');
        const scanRecipientBtn = document.getElementById('scanRecipientBtn');
        const scanDestinationTagBtn = document.getElementById('scanDestinationTagBtn');
        const scannerModal = document.getElementById('scannerModal');
        const qrVideo = document.getElementById('qr-video');
        const scannerStatus = document.getElementById('scannerStatus');
        const closeScanner = document.getElementById('closeScanner');
        const cameraPermission = document.querySelector('.camera-permission');
        const scannerContainer = document.querySelector('.scanner-container');

        const showKeyboardBtn = document.getElementById('showKeyboardBtn');
        const hideKeyboardBtn = document.getElementById('hideKeyboardBtn');
        const virtualKeyboardSection = document.getElementById('virtualKeyboardSection');
        const keyboardKeys = document.querySelectorAll('.keyboard-key');
        let currentInputField = null;
        let isShiftActive = false;

        const showDecryptionKeyboardBtn = document.getElementById('showDecryptionKeyboardBtn');
        const hideDecryptionKeyboardBtn = document.getElementById('hideDecryptionKeyboardBtn');
        const decryptionKeyboardSection = document.getElementById('decryptionKeyboardSection');
        const encryptionPasswordInput = document.getElementById('encryptionPassword');

        document.addEventListener('DOMContentLoaded', function () {
            try {
                if (!checkXrplAvailability()) {
                    return;
                }

                setupEventListeners();

                connectionCheckInterval = setInterval(checkConnectionStatus, 30000);

                scanRecipientBtn.addEventListener('click', () => openQRScanner('recipient'));
                scanDestinationTagBtn.addEventListener('click', () => openQRScanner('destinationTag'));
                closeScanner.addEventListener('click', closeQRScanner);
            } catch (error) {
                console.error('Error initializing application:', error);
                showAlert('خطا در راه‌اندازی برنامه', false);
            }
        });

        function preventRealKeyboard() {
            const inputFields = document.querySelectorAll('input[type="text"], input[type="password"], input[type="number"]');
            inputFields.forEach(input => {
                input.addEventListener('focus', function (e) {
                    if (virtualKeyboardSection.style.display === 'block' ||
                        decryptionKeyboardSection.style.display === 'block') {
                        e.preventDefault();
                        this.blur();
                    }
                });
            });
        }

        function setupEventListeners() {
            importWalletBtn.addEventListener('click', importWallet);
            refreshBtn.addEventListener('click', refreshBalance);
            sendButton.addEventListener('click', prepareTransaction);
            copyAddressBtn.addEventListener('click', copyAddressToClipboard);
            disconnectBtn.addEventListener('click', disconnectWallet);
            generateWalletBtn.addEventListener('click', generateNewWallet);
            copyNewAddressBtn.addEventListener('click', copyNewAddressToClipboard);
            useNewWalletBtn.addEventListener('click', useNewWallet);
            copyNewPrivateKeyBtn.addEventListener('click', copyNewPrivateKeyToClipboard);
            cancelTransactionBtn.addEventListener('click', closeConfirmationModal);
            confirmTransactionBtn.addEventListener('click', sendTransaction);
            copyTxHashBtn.addEventListener('click', copyTxHashToClipboard);
            useMaxAmountBtn.addEventListener('click', useMaxAmount);
            loadMoreBtn.addEventListener('click', loadMoreTransactions);
            toggleQRBtn.addEventListener('click', toggleQRCode);
            document.getElementById('copyEncryptedKeyBtn').addEventListener('click', copyEncryptedKeyToClipboard);
            document.getElementById('toggleNewKeyBtn').addEventListener('click', toggleNewKeyVisibility);
            document.getElementById('uploadPrivateKeyBtn').addEventListener('click', function () {
                document.getElementById('privateKeyFileInput').click();
            });

            document.getElementById('scanPrivateKeyBtn').addEventListener('click', function () {
                openQRScanner('privateKey');
            });

            document.getElementById('scanRecipientBtn').addEventListener('click', function () {
                openQRScanner('recipient');
            });

            document.getElementById('scanDestinationTagBtn').addEventListener('click', function () {
                openQRScanner('destinationTag');
            });

            closeScanner.addEventListener('click', closeQRScanner);

            document.getElementById('privateKeyFileInput').addEventListener('change', handlePrivateKeyFileUpload);
            toggleBalanceBtn = document.getElementById('toggleBalanceBtn');
            if (toggleBalanceBtn) {
                toggleBalanceBtn.addEventListener('click', toggleBalance);
            }

            amountInput.addEventListener('input', updateTotalAmount);
            destinationTagInput.addEventListener('input', validateDestinationTag);

            privateKeyInput.addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    importWallet();
                }
            });

            searchInput.addEventListener('input', debounce(function () {
                filterTransactions();
            }, 300));

            clearSearchBtn.addEventListener('click', function () {
                searchInput.value = '';
                filterTransactions();
            });

            document.querySelectorAll('.tablinks').forEach(tab => {
                tab.addEventListener('click', function () {
                    const onclickAttr = this.getAttribute('onclick');
                    if (onclickAttr && onclickAttr.includes('TransactionsTab')) {
                        loadTransactions();
                    }
                });
            });

            document.addEventListener('keydown', function (e) {
                if (e.key === 'Enter') {
                    const activeElement = document.activeElement;
                    if (activeElement.tagName === 'INPUT' || activeElement.tagName === 'TEXTAREA') {
                        e.preventDefault();
                        return false;
                    }
                }
            });

            showKeyboardBtn.addEventListener('click', function () {
                virtualKeyboardSection.style.display = 'block';
                showKeyboardBtn.style.display = 'none';
                if (!currentInputField) {
                    currentInputField = document.getElementById('customPasswordInput');
                }
                currentInputField.setAttribute('readonly', 'true');
                currentInputField.style.caretColor = 'transparent';
                setTimeout(() => { currentInputField.blur(); }, 10);
            });

            hideKeyboardBtn.addEventListener('click', function () {
                virtualKeyboardSection.style.display = 'none';
                showKeyboardBtn.style.display = 'block';
                if (currentInputField) {
                    currentInputField.removeAttribute('readonly');
                    currentInputField.style.caretColor = '';
                }
                currentInputField = null;
            });

            keyboardKeys.forEach(key => {
                key.addEventListener('click', function () {
                    if (!currentInputField) return;

                    const keyValue = this.getAttribute('data-key');
                    const action = this.getAttribute('data-action');

                    handleKeyboardInput(keyValue, action);
                });
            });

            document.getElementById('customPasswordInput').addEventListener('focus', function () {
                currentInputField = this;
            });

            document.getElementById('confirmPasswordInput').addEventListener('focus', function () {
                currentInputField = this;
                if (virtualKeyboardSection.style.display === 'none') {
                    showKeyboardBtn.click();
                }
            });

            showDecryptionKeyboardBtn.addEventListener('click', function () {
                decryptionKeyboardSection.style.display = 'block';
                showDecryptionKeyboardBtn.style.display = 'none';
                currentInputField = encryptionPasswordInput;
                currentInputField.setAttribute('readonly', 'true');
                currentInputField.style.caretColor = 'transparent';
                setTimeout(() => { currentInputField.blur(); }, 10);
            });

            hideDecryptionKeyboardBtn.addEventListener('click', function () {
                decryptionKeyboardSection.style.display = 'none';
                showDecryptionKeyboardBtn.style.display = 'block';
                if (currentInputField) {
                    currentInputField.removeAttribute('readonly');
                    currentInputField.style.caretColor = '';
                }
                currentInputField = null;
            });

            encryptionPasswordInput.addEventListener('focus', function () {
                currentInputField = this;
            });

            document.getElementById('encryptionPassword').addEventListener('click', function (e) {
                e.preventDefault();
                showDecryptionKeyboardBtn.click();
            });

            document.getElementById('customPasswordInput').addEventListener('click', function (e) {
                e.preventDefault();
                currentInputField = this;
                showKeyboardBtn.click();
            });

            document.getElementById('confirmPasswordInput').addEventListener('click', function (e) {
                e.preventDefault();
                currentInputField = this;
                showKeyboardBtn.click();
            });

            document.addEventListener('click', function (event) {
                const isKeyboardClick = event.target.closest('.virtual-keyboard-section') ||
                    event.target.closest('.keyboard-toggle-btn') ||
                    event.target.closest('#showDecryptionKeyboardBtn') ||
                    event.target.closest('#hideDecryptionKeyboardBtn') ||
                    event.target.closest('#showKeyboardBtn') ||
                    event.target.closest('#hideKeyboardBtn');

                const isPasswordFieldClick = event.target.id === 'encryptionPassword' ||
                    event.target.id === 'customPasswordInput' ||
                    event.target.id === 'confirmPasswordInput';

                if (!isKeyboardClick && !isPasswordFieldClick) {
                    if (decryptionKeyboardSection.style.display === 'block') {
                        hideDecryptionKeyboardBtn.click();
                    }

                    if (virtualKeyboardSection.style.display === 'block') {
                        hideKeyboardBtn.click();
                    }
                }
            });

            document.getElementById('encryptionPassword').addEventListener('click', function (e) {
                e.stopPropagation();
            });

            document.getElementById('customPasswordInput').addEventListener('click', function (e) {
                e.stopPropagation();
            });

            document.getElementById('confirmPasswordInput').addEventListener('click', function (e) {
                e.stopPropagation();
            });

            preventRealKeyboard();

            setTimeout(() => {
                toggleShiftKeys();
            }, 100);
        }

        function debounce(func, wait) {
            let timeout;
            return function () {
                const context = this;
                const args = arguments;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), wait);
            };
        }

        function handlePrivateKeyFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            try {
                showAlert('در حال پردازش تصویر...', true);

                const image = new Image();
                const imageUrl = URL.createObjectURL(file);

                image.onload = function () {
                    try {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        canvas.width = image.width;
                        canvas.height = image.height;
                        ctx.drawImage(image, 0, 0);

                        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);

                        const code = jsQR(imageData.data, imageData.width, imageData.height);

                        if (code) {
                            privateKeyInput.value = code.data;
                            showAlert('کلید خصوصی از تصویر خوانده شد', true);
                            highlightScannedField('privateKey');
                        } else {
                            showAlert('بارکد شناسایی نشد', false);
                        }

                    } catch (error) {
                        console.error('Processing error:', error);
                        showAlert('خطا در پردازش QR کد', false);
                    } finally {
                        URL.revokeObjectURL(imageUrl);
                        document.getElementById('privateKeyFileInput').value = '';
                    }
                };

                image.onerror = function () {
                    showAlert('خطا در بارگذاری تصویر', false);
                    URL.revokeObjectURL(imageUrl);
                    document.getElementById('privateKeyFileInput').value = '';
                };

                image.src = imageUrl;

            } catch (error) {
                console.error('File processing error:', error);
                showAlert('خطا در پردازش فایل', false);
                document.getElementById('privateKeyFileInput').value = '';
            }
        }

        async function connectToXrpl() {
            if (isConnected && api && api.isConnected()) {
                return true;
            }

            updateConnectionStatus('connecting');

            try {
                const xrpl = getXrpl();
                if (!xrpl) {
                    throw new Error('کتابخانه XRPL در دسترس نیست');
                }

                if (api) {
                    try {
                        await api.disconnect();
                    } catch (e) { }
                }

                const serverUrl = CONNECTION_SETTINGS.servers[CONNECTION_SETTINGS.currentServerIndex];
                currentServerUrl = serverUrl;

                api = new xrpl.Client(serverUrl);

                const connectionPromise = api.connect();
                const timeoutPromise = new Promise((_, reject) => {
                    setTimeout(() => reject(new Error('اتصال timeout شد')), CONNECTION_SETTINGS.connectionTimeout);
                });

                await Promise.race([connectionPromise, timeoutPromise]);

                connectionRetries = 0;
                isConnected = true;
                updateConnectionStatus('connected');

                serverInfoElement.textContent = `متصل به: ${serverUrl.replace('wss://', '')}`;
                serverInfoElement.style.display = 'block';

                return true;
            } catch (error) {
                CONNECTION_SETTINGS.currentServerIndex =
                    (CONNECTION_SETTINGS.currentServerIndex + 1) % CONNECTION_SETTINGS.servers.length;

                connectionRetries++;

                if (connectionRetries < CONNECTION_SETTINGS.maxRetries) {
                    updateConnectionStatus('retrying');

                    await new Promise(resolve => setTimeout(resolve, CONNECTION_SETTINGS.retryDelay));
                    return connectToXrpl();
                } else {
                    updateConnectionStatus('disconnected');
                    showAlert('خطا در اتصال به شبکه XRPL. لطفاً دوباره تلاش کنید.', false);
                    return false;
                }
            }
        }

        function updateConnectionStatus(status) {
            connectionStatusElement.className = 'status-indicator';

            switch (status) {
                case 'connected':
                    connectionStatusElement.classList.add('connected');
                    connectionTextElement.textContent = 'متصل';
                    break;
                case 'connecting':
                    connectionStatusElement.classList.add('connecting');
                    connectionTextElement.textContent = 'در حال اتصال...';
                    break;
                case 'disconnected':
                    connectionStatusElement.classList.add('disconnected');
                    connectionTextElement.textContent = 'قطع ارتباط';
                    break;
                case 'retrying':
                    connectionStatusElement.classList.add('connecting');
                    connectionTextElement.textContent = 'تلاش مجدد...';
                    break;
            }
        }

        async function checkConnectionStatus() {
            if (!api) {
                updateConnectionStatus('disconnected');
                return;
            }

            try {
                if (await api.isConnected()) {
                    updateConnectionStatus('connected');
                } else {
                    updateConnectionStatus('disconnected');
                    isConnected = false;

                    if (currentAddress) {
                        await connectToXrpl();
                        await getAccountInfo();
                        await updateNetworkFee();
                    }
                }
            } catch (error) {
                console.error('خطا در بررسی وضعیت اتصال:', error);
                updateConnectionStatus('disconnected');
                isConnected = false;
            }
        }

        async function importWallet() {
            const encryptedPrivateKey = privateKeyInput.value.trim();
            const password = document.getElementById('encryptionPassword').value;

            if (!encryptedPrivateKey) {
                showAlert('لطفاً کلید خصوصی رمزگذاری شده را وارد کنید', false);
                return;
            }

            if (!password) {
                showAlert('لطفاً رمز عبور رمزگشایی را وارد کنید', false);
                return;
            }

            try {
                if (decryptionKeyboardSection.style.display === 'block') {
                    decryptionKeyboardSection.style.display = 'none';
                    showDecryptionKeyboardBtn.style.display = 'block';
                    if (currentInputField === encryptionPasswordInput) {
                        currentInputField.removeAttribute('readonly');
                        currentInputField.style.caretColor = '';
                        currentInputField = null;
                    }
                }

                const privateKey = await decryptText(encryptedPrivateKey, password);

                const xrpl = getXrpl();
                if (!xrpl) {
                    throw new Error('کتابخانه XRPL در دسترس نیست');
                }

                if (!privateKey.startsWith('sEd')) {
                    showAlert('فرمت کلید خصوصی نامعتبر است. کلید باید با "sEd" شروع شود.', false);
                    await disconnectWallet();
                    return;
                }

                wallet = xrpl.Wallet.fromSeed(privateKey);
                currentAddress = wallet.address;

                addressElement.textContent = currentAddress;
                copyAddressBtn.disabled = false;

                const connected = await connectToXrpl();
                if (!connected) {
                    return;
                }

                await getAccountInfo();
                await updateNetworkFee();

                walletInfoDiv.style.display = 'block';
                disconnectBtn.style.display = 'block';
                qrSection.style.display = 'block';

                document.querySelector('.form-group:first-child').style.display = 'none';

                const generateTabButtons = document.querySelectorAll('.tablinks');
                generateTabButtons.forEach(tab => {
                    if (tab.textContent.includes('ایجاد کیف پول جدید') ||
                        tab.getAttribute('onclick')?.includes('GenerateTab')) {
                        tab.style.display = 'none';
                    }
                });

                generateQRCode(currentAddress);

                showAlert('کیف پول با موفقیت وارد شد', true);

            } catch (error) {
                console.error('خطا در وارد کردن کیف پول:', error);

                const errorMessage = error.message || 'کلید خصوصی نامعتبر است یا خطایی رخ داده است';

                privateKeyInput.value = '';
                document.getElementById('encryptionPassword').value = '';

                if (decryptionKeyboardSection.style.display === 'block') {
                    decryptionKeyboardSection.style.display = 'none';
                    showDecryptionKeyboardBtn.style.display = 'block';
                }

                showAlert(errorMessage, false);

                await disconnectWallet();
            }
        }

        function validatePassword(password) {
            if (password.length < 8) {
                return { isValid: false, message: 'رمز عبور باید حداقل 8 کاراکتر باشد' };
            }

            const hasUpperCase = /[A-Z]/.test(password);
            const hasLowerCase = /[a-z]/.test(password);
            const hasNumbers = /\d/.test(password);
            const hasSpecialChars = /[!@#$%^&*]/.test(password);

            if (!hasUpperCase) {
                return { isValid: false, message: 'رمز عبور باید شامل حداقل یک حرف بزرگ باشد' };
            }

            if (!hasLowerCase) {
                return { isValid: false, message: 'رمز عبور باید شامل حداقل یک حرف کوچک باشد' };
            }

            if (!hasNumbers) {
                return { isValid: false, message: 'رمز عبور باید شامل حداقل یک عدد باشد' };
            }

            if (!hasSpecialChars) {
                return { isValid: false, message: 'رمز عبور باید شامل حداقل یک علامت ویژه باشد' };
            }

            return { isValid: true, message: 'رمز عبور معتبر است' };
        }

        function resetDecryptionForm() {
            privateKeyInput.value = '';
            document.getElementById('encryptionPassword').value = '';

            if (decryptionKeyboardSection.style.display === 'block') {
                decryptionKeyboardSection.style.display = 'none';
                showDecryptionKeyboardBtn.style.display = 'block';
                if (currentInputField === encryptionPasswordInput) {
                    currentInputField.removeAttribute('readonly');
                    currentInputField.style.caretColor = '';
                    currentInputField = null;
                }
            }

            setTimeout(() => {
                privateKeyInput.focus();
            }, 100);

            const generateTab = document.querySelector('button[onclick="openTab(event, \'GenerateTab\')"]');
            if (generateTab && generateTab.style.display === 'none') {
                generateTab.style.display = 'block';
            }
        }

        async function getAccountInfo() {
            if (!api || !api.isConnected() || !currentAddress) {
                return;
            }

            try {
                balanceLoadingElement.style.display = 'inline-block';

                const accountInfo = await api.request({
                    command: 'account_info',
                    account: currentAddress,
                    ledger_index: 'validated'
                });

                const xrpl = getXrpl();
                const balanceXrp = xrpl.dropsToXrp(accountInfo.result.account_data.Balance);
                currentBalance = parseFloat(balanceXrp);

                await updateUsdBalance();

                isAccountActivated = currentBalance >= RESERVE_AMOUNT;
                usableBalance = isAccountActivated ? currentBalance - RESERVE_AMOUNT : 0;

                updateBalanceDisplay();
                xrpBalanceElement.classList.add('xrp-balance');

                updateAccountStatus();

                if (isAccountActivated) {
                    sendInfoAlert.style.display = 'none';
                } else {
                    sendInfoAlert.style.display = 'block';
                }

                sendButton.disabled = !isAccountActivated;

            } catch (error) {
                console.error('خطا در دریافت اطلاعات حساب:', error);

                if (error.data && error.data.error === 'actNotFound') {
                    currentBalance = 0;
                    usableBalance = 0;
                    isAccountActivated = false;

                    balanceElement.textContent = '0.000000';
                    document.getElementById('usdBalance').textContent = '$0.00';
                    updateAccountStatus();

                    sendInfoAlert.style.display = 'block';
                    sendButton.disabled = true;
                } else {
                    showAlert('خطا در دریافت اطلاعات حساب', false);
                }
            } finally {
                balanceLoadingElement.style.display = 'none';
            }
        }

        async function updateUsdBalance() {
            try {
                const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=ripple&vs_currencies=usd');

                if (!response.ok) {
                    throw new Error('خطا در دریافت نرخ ارز');
                }

                const data = await response.json();

                if (data?.ripple?.usd) {
                    const xrpPrice = data.ripple.usd;
                    const usdBalance = currentBalance * xrpPrice;

                    document.getElementById('usdBalance').textContent = `$${usdBalance.toFixed(2)}`;
                }
            } catch (error) {
                console.error('خطا در دریافت نرخ XRP:', error);
                document.getElementById('usdBalance').textContent = 'قیمت نامعلوم';
            }
        }

        function updateAccountStatus() {
            if (!currentAddress) {
                accountStatus.style.display = 'none';
                return;
            }

            accountStatus.style.display = 'block';

            if (isAccountActivated) {
                statusMessage.textContent = `حساب فعال است. موجودی قابل استفاده: ${usableBalance.toFixed(6)} XRP`;
                accountStatus.className = 'account-status';
                accountStatus.style.backgroundColor = 'rgba(40,167,69,.2)';
                accountStatus.style.borderColor = 'rgba(40,167,69,.3)';
                accountStatus.style.color = '#4cd964';
            } else {
                statusMessage.textContent = 'حساب غیرفعال است. برای فعال کردن حساب، حداقل 1 XRP واریز کنید.';
                accountStatus.className = 'account-status';
                accountStatus.style.backgroundColor = 'rgba(255,193,7,.2)';
                accountStatus.style.borderColor = 'rgba(255,193,7,.3)';
                accountStatus.style.color = '#ffcc00';
            }
        }

        async function refreshBalance() {
            if (!currentAddress) {
                showAlert('لطفاً ابتدا کیف پول را وارد کنید', false);
                return;
            }

            const connected = await connectToXrpl();
            if (!connected) {
                return;
            }

            await getAccountInfo();
            await updateNetworkFee();
            showAlert('موجودی با موفقیت بروزرسانی شد', true);
        }

        function showAlert(message, isSuccess) {
            alertElement.textContent = message;
            alertElement.className = isSuccess ? 'alert alert-success' : 'alert alert-error';
            alertElement.style.display = 'block';

            setTimeout(() => {
                alertElement.style.display = 'none';
            }, 5000);
        }

        function copyAddressToClipboard() {
            if (!currentAddress) return;

            navigator.clipboard.writeText(currentAddress).then(() => {
                copyNotification.textContent = 'آدرس با موفقیت کپی شد!';
                copyNotification.style.display = 'block';

                setTimeout(() => {
                    copyNotification.style.display = 'none';
                }, 2000);
            }).catch(err => {
                console.error('خطا در کپی آدرس:', err);
                const tempTextArea = document.createElement('textarea');
                tempTextArea.value = currentAddress;
                document.body.appendChild(tempTextArea);
                tempTextArea.select();
                document.execCommand('copy');
                document.body.removeChild(tempTextArea);

                copyNotification.textContent = 'آدرس با موفقیت کپی شد!';
                copyNotification.style.display = 'block';

                setTimeout(() => {
                    copyNotification.style.display = 'none';
                }, 2000);
            });
        }

        function disconnectWallet() {
            const form = document.querySelector('form');
            form.setAttribute('autocomplete', 'off');

            const passwordFields = document.querySelectorAll('input[type="password"]');
            passwordFields.forEach(field => {
                field.setAttribute('autocomplete', 'new-password');
                field.setAttribute('readonly', 'true');
                field.style.position = 'absolute';
                field.style.left = '-9999px';
            });

            setTimeout(() => {
                document.querySelector('form').reset();

                setTimeout(() => {
                    passwordFields.forEach(field => {
                        field.removeAttribute('readonly');
                        field.style.position = '';
                        field.style.left = '';
                        field.value = '';
                    });

                    resetDecryptionForm();
                    performDisconnect();
                }, 100);
            }, 100);
        }

        async function performDisconnect() {
            try {
                if (connectionCheckInterval) {
                    clearInterval(connectionCheckInterval);
                    connectionCheckInterval = null;
                }

                if (api) {
                    await api.disconnect();
                    api = null;
                }

                currentAddress = '';
                wallet = null;
                isAccountActivated = false;
                currentBalance = 0;
                usableBalance = 0;
                allTransactions = [];
                filteredTransactions = [];
                lastTransactionHash = null;
                isConnected = false;
                networkFee = 0.00001;
                connectionRetries = 0;
                CONNECTION_SETTINGS.currentServerIndex = 0;
                scanning = false;

                document.getElementById('address').textContent = 'r...';
                document.getElementById('balanceText').textContent = '0.000000';
                document.getElementById('usdBalance').textContent = '$0.00';

                document.getElementById('walletInfoDiv').style.display = 'none';
                document.getElementById('disconnectBtn').style.display = 'none';
                document.getElementById('accountStatus').style.display = 'none';
                document.getElementById('qrSection').style.display = 'none';
                document.getElementById('txSuccess').style.display = 'none';

                document.querySelector('.form-group:first-child').style.display = 'block';

                document.querySelectorAll('.tablinks').forEach(tab => {
                    tab.style.display = 'block';
                });

                document.getElementById('copyAddressBtn').disabled = true;
                document.getElementById('sendButton').disabled = true;

                document.getElementById('transactions').innerHTML = '<p>لطفاً ابتدا کلید خصوصی را وارد کنید...</p>';
                document.getElementById('searchInfo').style.display = 'none';
                document.getElementById('loadMoreBtn').style.display = 'none';

                updateConnectionStatus('disconnected');
                document.getElementById('serverInfo').textContent = '';
                document.getElementById('serverInfo').style.display = 'none';

                document.getElementById('qrContainer').style.display = 'none';
                document.getElementById('toggleQR').textContent = 'نمایش بارکد آدرس';
                document.getElementById('qrcode').innerHTML = '';

                document.getElementById('toggleNewKeyBtn').textContent = 'نمایش';
                document.getElementById('newPrivateKey').type = 'password';
                document.getElementById('newPrivateKey').setAttribute('readonly', 'true');

                document.getElementById('useNewWalletBtn').style.display = 'none';

                document.getElementById('disableDestinationTag').checked = false;
                document.getElementById('destinationTagGroup').classList.remove('disabled');

                document.getElementById('sendInfoAlert').style.display = 'block';

                openTab(null, 'WalletTab');

            } catch (error) {
                showAlert('خطا در قطع اتصال کیف پول', false);
            }
        }

        function copyEncryptedKeyToClipboard() {
            const encryptedKey = document.getElementById('encryptedKeyDisplay').value;
            if (!encryptedKey) return;

            navigator.clipboard.writeText(encryptedKey).then(() => {
                document.getElementById('encryptedKeyCopyNotification').textContent = 'کلید خصوصی رمزگذاری شده کپی شد!';
                document.getElementById('encryptedKeyCopyNotification').style.display = 'block';

                setTimeout(() => {
                    document.getElementById('encryptedKeyCopyNotification').style.display = 'none';
                }, 2000);
            }).catch(err => {
                console.error('خطا در کپی کلید خصوصی:', err);
            });
        }

        async function generateNewWallet() {
            try {
                const customPassword = document.getElementById('customPasswordInput').value.trim();
                const confirmPassword = document.getElementById('confirmPasswordInput').value.trim();

                if (!customPassword) {
                    showAlert('لطفاً رمز عبور دلخواه خود را وارد کنید', false);
                    return;
                }

                if (!confirmPassword) {
                    showAlert('لطفاً رمز عبور خود را مجدداً وارد کنید', false);
                    return;
                }

                if (customPassword !== confirmPassword) {
                    showAlert('رمز عبور و تایید آن مطابقت ندارند', false);
                    return;
                }

                const validation = validatePassword(customPassword);
                if (!validation.isValid) {
                    showAlert(validation.message, false);
                    return;
                }

                const xrpl = getXrpl();
                if (!xrpl) {
                    throw new Error('کتابخانه XRPL در دسترس نیست');
                }

                const newWallet = xrpl.Wallet.generate();

                if (!newWallet || !newWallet.seed || !newWallet.address) {
                    throw new Error('خطا در تولید کیف پول');
                }

                if (!validateGeneratedWallet(newWallet)) {
                    throw new Error('کیف پول تولید شده نامعتبر است');
                }

                newPrivateKey.value = newWallet.seed;
                const encryptedKey = await encryptText(newWallet.seed, customPassword);
                document.getElementById('newAddress').value = newWallet.address;
                document.getElementById('encryptedKeyDisplay').value = encryptedKey;

                useNewWalletBtn.style.display = 'block';
                await generateQRCodeForEncryptedKey(encryptedKey);

                showAlert('کیف پول جدید با موفقیت تولید شد', true);

            } catch (error) {
                console.error('خطا در ایجاد کیف پول جدید:', error);
                showAlert('خطا در ایجاد کیف پول جدید: ' + error.message, false);
            }
        }

        function validateGeneratedWallet(wallet) {
            if (!wallet) return false;

            const xrpl = getXrpl();

            if (!wallet.seed || !wallet.address || !wallet.publicKey) {
                return false;
            }

            if (!wallet.seed.startsWith('sEd')) {
                return false;
            }

            if (!xrpl.isValidAddress(wallet.address)) {
                return false;
            }

            return true;
        }

        function generateQRCodeForEncryptedKey(encryptedKey) {
            return new Promise(async (resolve, reject) => {
                try {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');

                    const qrSize = 1000;
                    canvas.width = qrSize;
                    canvas.height = qrSize;

                    const tempDiv = document.createElement('div');
                    tempDiv.style.width = `${qrSize}px`;
                    tempDiv.style.height = `${qrSize}px`;
                    tempDiv.style.position = 'absolute';
                    tempDiv.style.left = '-9999px';
                    document.body.appendChild(tempDiv);

                    const qrCode = new QRCode(tempDiv, {
                        text: encryptedKey,
                        width: qrSize,
                        height: qrSize,
                        colorDark: "#000000",
                        colorLight: "#FFFFFF",
                        correctLevel: QRCode.CorrectLevel.H,
                        useSVG: false
                    });

                    await new Promise(resolve => setTimeout(resolve, 200));

                    const qrCanvas = tempDiv.querySelector('canvas');
                    if (!qrCanvas) {
                        document.body.removeChild(tempDiv);
                        reject(new Error('QR Code render نشد'));
                        return;
                    }

                    ctx.imageSmoothingEnabled = false;
                    ctx.webkitImageSmoothingEnabled = false;
                    ctx.mozImageSmoothingEnabled = false;
                    ctx.msImageSmoothingEnabled = false;
                    ctx.oImageSmoothingEnabled = false;

                    ctx.drawImage(qrCanvas, 0, 0, qrSize, qrSize);

                    const framePadding = 40;
                    const borderWidth = 10;

                    const frameWidth = qrSize + (framePadding * 2);
                    const frameHeight = qrSize + (framePadding * 2);

                    const finalCanvas = document.createElement('canvas');
                    finalCanvas.width = frameWidth;
                    finalCanvas.height = frameHeight;
                    const finalCtx = finalCanvas.getContext('2d');

                    finalCtx.fillStyle = '#FFFFFF';
                    finalCtx.fillRect(0, 0, frameWidth, frameHeight);

                    finalCtx.strokeStyle = '#000000';
                    finalCtx.lineWidth = borderWidth;
                    finalCtx.strokeRect(
                        borderWidth / 2,
                        borderWidth / 2,
                        frameWidth - borderWidth,
                        frameHeight - borderWidth
                    );

                    finalCtx.imageSmoothingEnabled = false;
                    finalCtx.webkitImageSmoothingEnabled = false;
                    finalCtx.mozImageSmoothingEnabled = false;
                    finalCtx.msImageSmoothingEnabled = false;
                    finalCtx.oImageSmoothingEnabled = false;

                    finalCtx.drawImage(canvas, framePadding, framePadding, qrSize, qrSize);

                    document.body.removeChild(tempDiv);

                    finalCanvas.toBlob(function (blob) {
                        const url = URL.createObjectURL(blob);
                        const downloadLink = document.createElement('a');
                        downloadLink.href = url;
                        downloadLink.download = 'xrp-wallet-encrypted-key-high-quality.png';
                        downloadLink.style.display = 'none';

                        document.body.appendChild(downloadLink);
                        downloadLink.click();

                        setTimeout(() => {
                            document.body.removeChild(downloadLink);
                            URL.revokeObjectURL(url);
                            resolve();
                        }, 100);
                    }, 'image/png', 1.0);
                } catch (error) {
                    reject(error);
                }
            });
        }

        function useNewWallet() {
            const encryptedKey = document.getElementById('encryptedKeyDisplay').value;

            if (!encryptedKey) {
                showAlert('لطفاً ابتدا یک کیف پول جدید ایجاد کنید', false);
                return;
            }

            privateKeyInput.value = encryptedKey;

            openTab(null, 'WalletTab');

            setTimeout(() => {
                document.getElementById('encryptionPassword').focus();
            }, 100);

            showAlert('کلید خصوصی رمزگذاری شده وارد شد. لطفاً رمز عبور را برای رمزگشایی وارد کنید.', true);

            useNewWalletBtn.style.display = 'none';

            const generateTab = document.querySelector('button[onclick="openTab(event, \'GenerateTab\')"]');
            if (generateTab) {
                generateTab.style.display = 'none';
            }
        }

        function copyNewAddressToClipboard() {
            if (!newAddress.value) return;

            navigator.clipboard.writeText(newAddress.value).then(() => {
                copyNotification.textContent = 'آدرس با موفقیت کپی شد!';
                copyNotification.style.display = 'block';

                setTimeout(() => {
                    copyNotification.style.display = 'none';
                }, 2000);
            }).catch(err => {
                console.error('خطا در کپی آدرس:', err);
            });
        }

        function toggleNewKeyVisibility() {
            const newPrivateKeyInput = document.getElementById('newPrivateKey');
            const toggleBtn = document.getElementById('toggleNewKeyBtn');

            if (newPrivateKeyInput.type === 'password') {
                newPrivateKeyInput.type = 'text';
                toggleBtn.textContent = 'مخفی';
            } else {
                newPrivateKeyInput.type = 'password';
                toggleBtn.textContent = 'نمایش';
            }
        }

        function copyNewPrivateKeyToClipboard() {
            if (!newPrivateKey.value) return;

            navigator.clipboard.writeText(newPrivateKey.value).then(() => {
                privateKeyCopyNotification.textContent = 'کلید خصوصی با موفقیت کپی شد!';
                privateKeyCopyNotification.style.display = 'block';

                setTimeout(() => {
                    privateKeyCopyNotification.style.display = 'none';
                }, 2000);
            }).catch(err => {
                console.error('خطا در کپی کلید خصوصی:', err);
            });
        }

        function toggleBalance() {
            isBalanceHidden = !isBalanceHidden;
            updateBalanceDisplay();
        }

        function updateBalanceDisplay() {
            if (!balanceElement) return;

            const usdBalanceElement = document.getElementById('usdBalance');

            if (isBalanceHidden) {
                balanceElement.textContent = '******';
                usdBalanceElement.textContent = '****';
                if (toggleBalanceBtn) {
                    toggleBalanceBtn.textContent = 'نمایش موجودی';
                }
            } else {
                balanceElement.textContent = currentBalance.toFixed(6);
                updateUsdBalance();
                if (toggleBalanceBtn) {
                    toggleBalanceBtn.textContent = 'مخفی کردن موجودی';
                }
            }

            localStorage.setItem('balanceHidden', isBalanceHidden.toString());
        }

        function openTab(evt, tabName) {
            const tabs = document.querySelectorAll('.tabcontent');
            tabs.forEach(tab => tab.style.display = 'none');

            const buttons = document.querySelectorAll('.tablinks');
            buttons.forEach(btn => btn.classList.remove('active'));

            const targetTab = document.getElementById(tabName);
            if (targetTab) {
                targetTab.style.display = 'block';
            }

            if (evt && evt.currentTarget) {
                evt.currentTarget.classList.add('active');
            } else {
                const targetBtn = document.querySelector(`[onclick*="${tabName}"]`);
                if (targetBtn) {
                    targetBtn.classList.add('active');
                }
            }

            if (tabName === 'TransactionsTab' && currentAddress) {
                setTimeout(() => loadTransactions(), 100);
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            const fakeEvent = { currentTarget: document.querySelector('[onclick*="WalletTab"]') };
            openTab(fakeEvent, 'WalletTab');
        });

        async function prepareTransaction() {
            const recipient = recipientInput.value.trim();
            let amount = parseFloat(amountInput.value);
            const destinationTag = disableDestinationTagCheckbox.checked ? undefined : parseInt(destinationTagInput.value);

            if (!recipient) {
                showAlert('لطفاً آدرس گیرنده را وارد کنید', false);
                return;
            }

            try {
                const xrpl = getXrpl();
                if (!xrpl) {
                    throw new Error('کتابخانه XRPL در دسترس نیست');
                }

                if (!xrpl.isValidAddress(recipient)) {
                    showAlert('آدرس گیرنده نامعتبر است', false);
                    return;
                }

                if (isNaN(amount) || amount <= 0) {
                    showAlert('لطفاً مبلغ معتبر وارد کنید', false);
                    return;
                }

                const totalAmount = amount + networkFee;
                if (totalAmount > currentBalance) {
                    showAlert(`موجودی کافی نیست. کل مبلغ مورد نیاز: ${totalAmount.toFixed(6)} XRP`, false);
                    return;
                }

                if (amount > usableBalance) {
                    showAlert(`مبلغ وارد شده بیشتر از موجودی قابل استفاده (${usableBalance.toFixed(6)} XRP) است`, false);
                    return;
                }

                updateNetworkFee();
                showConfirmationModal(recipient, amount, destinationTag, networkFee, totalAmount);

            } catch (error) {
                console.error('خطا در آماده‌سازی تراکنش:', error);
                showAlert('خطا در آماده‌سازی تراکنش', false);
            }
        }

        function showConfirmationModal(recipient, amount, destinationTag, fee, total) {
            confirmRecipient.textContent = recipient;
            confirmAmount.textContent = `${amount.toFixed(6)} XRP`;
            confirmDestinationTag.textContent = destinationTag || 'ندارد';
            confirmFee.textContent = `${fee.toFixed(6)} XRP`;
            confirmTotal.textContent = `${total.toFixed(6)} XRP`;

            confirmationModal.style.display = 'flex';
        }

        function closeConfirmationModal() {
            confirmationModal.style.display = 'none';
        }

        async function sendTransaction() {
            closeConfirmationModal();

            const recipient = recipientInput.value.trim();
            const amount = parseFloat(amountInput.value);
            const destinationTag = disableDestinationTagCheckbox.checked ? undefined : parseInt(destinationTagInput.value);

            sendLoader.style.display = 'block';
            sendButton.disabled = true;

            try {
                const xrpl = getXrpl();
                if (!xrpl) {
                    throw new Error('کتابخانه XRPL در دسترس نیست');
                }

                const connected = await connectToXrpl();
                if (!connected) {
                    throw new Error('اتصال به شبکه برقرار نیست');
                }

                const prepared = await api.autofill({
                    "TransactionType": "Payment",
                    "Account": currentAddress,
                    "Amount": xrpl.xrpToDrops(amount),
                    "Destination": recipient,
                    "DestinationTag": destinationTag
                });

                const signed = wallet.sign(prepared);

                const tx = await api.submitAndWait(signed.tx_blob);

                if (tx.result.meta.TransactionResult === 'tesSUCCESS') {
                    lastTransactionHash = signed.hash;

                    txHashElement.textContent = lastTransactionHash;
                    txSuccess.style.display = 'block';

                    await getAccountInfo();
                    await updateNetworkFee();

                    showAlert('تراکنش با موفقیت انجام شد!', true);

                    recipientInput.value = '';
                    amountInput.value = '';
                    destinationTagInput.value = '';

                } else {
                    throw new Error(`تراکنش ناموفق بود: ${tx.result.meta.TransactionResult}`);
                }

            } catch (error) {
                console.error('خطا در ارسال تراکنش:', error);
                showAlert(`خطا در ارسال تراکنش: ${error.message}`, false);
            } finally {
                sendLoader.style.display = 'none';
                sendButton.disabled = !isAccountActivated;
            }
        }

        function copyTxHashToClipboard() {
            if (!lastTransactionHash) return;

            navigator.clipboard.writeText(lastTransactionHash).then(() => {
                txHashCopyNotification.textContent = 'کد پیگیری با موفقیت کپی شد!';
                txHashCopyNotification.style.display = 'block';

                setTimeout(() => {
                    txHashCopyNotification.style.display = 'none';
                }, 2000);
            }).catch(err => {
                console.error('خطا در کپی کد پیگیری:', err);
            });
        }

        async function useMaxAmount() {
            if (usableBalance > 0) {
                amountInput.value = (usableBalance - networkFee).toFixed(6);
                updateTotalAmount();
            } else {
                showAlert('موجودی قابل استفاده وجود ندارد', false);
            }
        }

        function updateTotalAmount() {
            const amount = parseFloat(amountInput.value) || 0;
            const total = amount + networkFee;
            totalAmountElement.textContent = `${total.toFixed(6)} XRP`;
        }

        async function validateRecipientAddress() {
            try {
                const xrpl = getXrpl();
                const recipient = recipientInput.value.trim();

                if (recipient && !xrpl.isValidAddress(recipient)) {
                    recipientInput.style.borderColor = 'red';
                } else {
                    recipientInput.style.borderColor = '';
                }
            } catch (error) {
                console.error('خطا در اعتبارسنجی آدرس:', error);
            }
        }

        async function validateAmount() {
            const amount = parseFloat(amountInput.value) || 0;
            const total = amount + networkFee;

            if (amount > usableBalance) {
                amountInput.style.borderColor = 'red';
            } else if (total > currentBalance) {
                amountInput.style.borderColor = 'orange';
            } else {
                amountInput.style.borderColor = '';
            }

            updateTotalAmount();
        }

        async function validateDestinationTag() {
            const destinationTag = parseInt(destinationTagInput.value);

            if (destinationTagInput.value && (isNaN(destinationTag) || destinationTag < 0 || destinationTag > 4294967295)) {
                destinationTagInput.style.borderColor = 'red';
            } else {
                destinationTagInput.style.borderColor = '';
            }
        }

        async function toggleDestinationTag() {
            if (disableDestinationTagCheckbox.checked) {
                destinationTagGroup.classList.add('disabled');
            } else {
                destinationTagGroup.classList.remove('disabled');
            }
        }

        async function loadTransactions() {
            if (!currentAddress) {
                transactionsContainer.innerHTML = '<p>لطفاً ابتدا کیف پول را وارد کنید</p>';
                return;
            }

            try {
                transactionsContainer.innerHTML = '<p>در حال دریافت تراکنش‌ها...</p>';

                const response = await fetch(`https://api.xrpscan.com/api/v1/account/${currentAddress}/transactions`);

                if (!response.ok) {
                    throw new Error('خطا در دریافت تراکنش‌ها');
                }

                const data = await response.json();
                const transactions = data.transactions || [];

                allTransactions = transactions;
                filteredTransactions = [...transactions];

                if (transactions.length === 0) {
                    transactionsContainer.innerHTML = '<p>تراکنشی یافت نشد</p>';
                    return;
                }

                displayTransactions(transactions);

            } catch (error) {
                console.error('خطا:', error);
                transactionsContainer.innerHTML = '<p>تراکنشی وجود ندارد.</p>';
            }
        }

        function filterTransactions() {
            const searchText = searchInput.value.trim().toLowerCase();

            if (searchText === '') {
                filteredTransactions = [...allTransactions];
                searchInfo.style.display = 'none';
            } else {
                filteredTransactions = allTransactions.filter(tx => {
                    const txData = tx.tx || tx.transaction || tx;

                    const amount = extractAmount(txData);
                    const amountText = amount.toFixed(6);
                    if (amountText.includes(searchText)) return true;

                    const counterparty = txData.Account === currentAddress ?
                        (txData.Destination || '') :
                        (txData.Account || '');
                    if (counterparty.toLowerCase().includes(searchText)) return true;

                    const hash = txData.hash || txData.id || '';
                    if (hash.toLowerCase().includes(searchText)) return true;

                    const date = txData.date ? new Date(txData.date * 1000 || txData.date).toLocaleString('fa-IR') : '';
                    if (date.toLowerCase().includes(searchText)) return true;

                    const type = txData.Account === currentAddress ? 'ارسال' : 'دریافت';
                    if (type.includes(searchText)) return true;

                    const status = getTransactionStatus(txData);
                    if (status.toLowerCase().includes(searchText)) return true;

                    return false;
                });

                if (filteredTransactions.length === 0) {
                    searchInfo.textContent = `هیچ تراکنشی با عبارت "${searchText}" یافت نشد.`;
                    searchInfo.style.display = 'block';
                } else {
                    searchInfo.textContent = `${filteredTransactions.length} تراکنش با عبارت "${searchText}" یافت شد.`;
                    searchInfo.style.display = 'block';
                }
            }

            displayTransactions(filteredTransactions);
        }

        function displayTransactions(transactions) {
            if (transactions.length === 0) {
                transactionsContainer.innerHTML = '<p class="no-results">هیچ تراکنشی یافت نشد.</p>';
                return;
            }

            let html = '';

            transactions.forEach(tx => {
                const txData = tx.tx || tx.transaction || tx;
                const isOutgoing = txData.Account === currentAddress;
                const amount = extractAmount(txData);
                const counterparty = isOutgoing ? (txData.Destination || '') : (txData.Account || '');
                const date = txData.date ? new Date(txData.date * 1000 || txData.date).toLocaleString('fa-IR') : 'تاریخ نامعلوم';
                const hash = txData.hash || txData.id || '';
                const shortHash = hash.substring(0, 8) + '...' + hash.substring(hash.length - 8);

                const status = getTransactionStatus(txData);
                const isSuccess = status === 'موفق';
                const isFailed = status === 'ناموفق';
                const isPending = status === 'در انتظار';

                html += `
            <div class="transaction ${isFailed ? 'failed' : ''}">
                <div class="transaction-header">
                    <span>${isOutgoing ? 'ارسال' : 'دریافت'} ${amount.toFixed(6)} XRP</span>
                    <span>${date}</span>
                </div>
                
                <div class="transaction-details">
                    <div class="transaction-detail">
                        <span class="transaction-detail-label">وضعیت:</span>
                        <span class="transaction-status ${isSuccess ? 'success' : isFailed ? 'failed' : 'pending'}">${status}</span>
                    </div>
                    
                    <div class="transaction-detail">
                        <span class="transaction-detail-label">${isOutgoing ? 'به:' : 'از:'}</span>
                        <span>${counterparty}</span>
                    </div>
                    
                    <div class="transaction-hash">
                        <span class="transaction-hash-label">شناسه تراکنش:</span>
                        <span class="transaction-hash-value">
                            <a href="https://xrpscan.com/tx/${hash}" target="_blank" rel="noopener">${hash}</a>
                        </span>
                    </div>
                </div>
            </div>
        `;
            });

            transactionsContainer.innerHTML = html;
        }

        function getTransactionStatus(txData) {
            if (txData.validated === false) {
                return 'در انتظار';
            }

            if (txData.meta && txData.meta.TransactionResult) {
                return txData.meta.TransactionResult === 'tesSUCCESS' ? 'موفق' : 'ناموفق';
            }

            if (txData.outcome && txData.outcome.result) {
                return txData.outcome.result === 'tesSUCCESS' ? 'موفق' : 'ناموفق';
            }

            return 'نامعلوم';
        }

        function extractAmount(txData) {
            const amountValue = txData.Amount || txData.amount;

            if (!amountValue) return 0;

            if (typeof amountValue === 'string' || typeof amountValue === 'number') {
                return parseFloat(amountValue) / DROPS_PER_XRP;
            }

            if (typeof amountValue === 'object' && amountValue.value) {
                return parseFloat(amountValue.value) / DROPS_PER_XRP;
            }

            return 0;
        }

        function loadMoreTransactions() {
            loadMoreBtn.style.display = 'none';
        }

        async function updateNetworkFee() {
            try {
                if (!api || !api.isConnected()) return;

                const feeResponse = await api.request({ command: "fee" });
                networkFee = parseFloat(getXrpl().dropsToXrp(feeResponse.result.drops.open_ledger_fee));

                networkFeeElement.textContent = networkFee.toFixed(6) + " XRP";
                updateTotalAmount();
            } catch (error) {
                console.error("خطا در دریافت کارمزد شبکه:", error);
                networkFee = 0.00001;
                networkFeeElement.textContent = networkFee.toFixed(6) + " XRP";
                updateTotalAmount();
            }
        }

        function generateQRCode(address) {
            if (!address) return;

            try {
                qrcodeElement.innerHTML = '';

                const frameDiv = document.createElement('div');
                frameDiv.className = 'qr-frame';
                qrcodeElement.appendChild(frameDiv);

                const qrcode = new QRCode(frameDiv, {
                    text: address,
                    width: 300,
                    height: 300,
                    colorDark: "#000000",
                    colorLight: "#FFFFFF",
                    correctLevel: QRCode.CorrectLevel.H,
                    useSVG: false
                });

                setTimeout(() => {
                    const canvas = frameDiv.querySelector('canvas');
                    if (canvas) {
                        canvas.style.imageRendering = 'crisp-edges';
                        canvas.style.imageRendering = 'pixelated';
                        canvas.style.webkitImageRendering = 'pixelated';
                        canvas.style.msInterpolationMode = 'nearest-neighbor';
                    }
                }, 150);
            } catch (error) {
                console.error('خطا در تولید QR Code:', error);
                qrcodeElement.innerHTML = '<p>خطا در تولید QR Code</p>';
            }
        }

        function handleKeyboardInput(keyValue, action) {
            if (!currentInputField) return;

            if (action) {
                switch (action) {
                    case 'backspace':
                        if (currentInputField.value.length > 0) {
                            currentInputField.value = currentInputField.value.slice(0, -1);
                        }
                        break;
                    case 'clear':
                        currentInputField.value = '';
                        break;
                    case 'shift':
                        isShiftActive = !isShiftActive;
                        toggleShiftKeys();
                        break;
                    case 'enter':
                        if (currentInputField.id === 'encryptionPassword') {
                            hideDecryptionKeyboardBtn.click();
                            importWalletBtn.click();
                        } else {
                            hideKeyboardBtn.click();
                        }
                        break;
                }
            } else if (keyValue) {
                currentInputField.value += isShiftActive ? keyValue.toUpperCase() : keyValue;

                if (isShiftActive && keyValue.match(/[a-z]/i)) {
                    isShiftActive = false;
                    toggleShiftKeys();
                }
            }

            currentInputField.dispatchEvent(new Event('input'));
        }

        function toggleShiftKeys() {
            const letterKeys = document.querySelectorAll('.keyboard-key[data-key]:not(.special-key)');

            letterKeys.forEach(key => {
                const keyValue = key.getAttribute('data-key');
                if (keyValue && keyValue.match(/[a-z]/)) {
                    key.textContent = isShiftActive ? keyValue.toUpperCase() : keyValue.toLowerCase();

                    key.style.backgroundColor = '';
                    key.style.color = '';

                    if (isShiftActive) {
                        key.classList.add('shift-active');
                    } else {
                        key.classList.remove('shift-active');
                    }
                }
            });

            const shiftKey = document.querySelector('.keyboard-key[data-action="shift"]');
            if (shiftKey) {
                if (isShiftActive) {
                    shiftKey.style.backgroundColor = 'var(--primary-color)';
                    shiftKey.style.color = '#fff';
                } else {
                    shiftKey.style.backgroundColor = 'var(--info-color)';
                    shiftKey.style.color = '#fff';
                }
            }
        }

        function toggleQRCode() {
            if (qrContainer.style.display === 'none') {
                qrContainer.style.display = 'block';
                toggleQRBtn.textContent = 'پنهان کردن بارکد';
            } else {
                qrContainer.style.display = 'none';
                toggleQRBtn.textContent = 'نمایش بارکد آدرس';
            }
        }

        function openQRScanner(target) {
            currentScannerTarget = target;
            scannerModal.style.display = 'flex';
            startQRScanner();
        }

        async function startQRScanner() {
            const constraints = {
                video: {
                    facingMode: 'environment',
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                }
            };

            try {
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('مرورگر شما از دسترسی به دوربین پشتیبانی نمی‌کند');
                }

                scannerStream = await navigator.mediaDevices.getUserMedia(constraints);
                qrVideo.srcObject = scannerStream;
                qrVideo.setAttribute('playsinline', true);

                await new Promise((resolve, reject) => {
                    qrVideo.onloadedmetadata = () => {
                        qrVideo.play().then(resolve).catch(reject);
                    };
                    qrVideo.onerror = reject;
                    setTimeout(() => reject(new Error('زمان لود شدن ویدیو به پایان رسید')), 10000);
                });

                cameraPermission.style.display = 'none';
                scannerContainer.classList.remove('hidden');
                scannerStatus.textContent = 'دوربین فعال شد. در حال اسکن...';
                scanning = true;

                detectBarcode();

            } catch (error) {
                console.error('Error accessing camera:', error);
                let errorMessage = 'خطا در دسترسی به دوربین: ';

                if (error.name === 'NotAllowedError') {
                    errorMessage = 'دسترسی به دوربین رد شد. لطفاً مجوز دسترسی را در مرورگر خود فعال کنید.';
                } else if (error.name === 'NotFoundError') {
                    errorMessage = 'دوربینی یافت نشد.';
                } else if (error.name === 'NotSupportedError') {
                    errorMessage = 'مرورگر شما از دسترسی به دوربین پشتیبانی نمی‌کند.';
                } else if (error.message.includes('زمان لود')) {
                    errorMessage = 'دوربین پاسخ نمی‌دهد. لطفاً دوباره تلاش کنید.';
                } else {
                    errorMessage += error.message;
                }

                scannerStatus.textContent = errorMessage;
                scanning = false;
            }
        }

        function detectBarcode() {
            if (!scanning) return;

            requestAnimationFrame(detectBarcode);

            try {
                if (qrVideo.readyState !== qrVideo.HAVE_ENOUGH_DATA ||
                    qrVideo.videoWidth === 0 ||
                    qrVideo.videoHeight === 0) {
                    return;
                }

                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d', { willReadFrequently: true });

                const maxDimension = 400;
                const scale = Math.min(maxDimension / qrVideo.videoWidth, maxDimension / qrVideo.videoHeight);
                canvas.width = Math.floor(qrVideo.videoWidth * scale);
                canvas.height = Math.floor(qrVideo.videoHeight * scale);

                context.imageSmoothingEnabled = false;
                context.drawImage(qrVideo, 0, 0, canvas.width, canvas.height);

                const imageData = context.getImageData(0, 0, canvas.width, canvas.height);

                const code = jsQR(
                    imageData.data,
                    imageData.width,
                    imageData.height,
                    {
                        inversionAttempts: "attemptBoth",
                    }
                );

                if (code) {
                    scanning = false;
                    scannerStatus.textContent = '✅ کد QR شناسایی شد!';
                    scannerStatus.style.color = '#28a745';

                    setTimeout(() => {
                        handleScannedQR(code.data);
                    }, 300);
                    return;
                }

            } catch (error) {
            }
        }

        function handleScannedQR(data) {
            if (!currentScannerTarget) {
                showAlert('خطا در تشخیص نوع فیلد. لطفاً دوباره تلاش کنید.', false);
                closeQRScanner();
                return;
            }

            closeQRScanner();

            if (currentScannerTarget === 'privateKey') {
                privateKeyInput.value = data;
                showAlert('کلید خصوصی از QR کد خوانده شد', true);
                highlightScannedField('privateKey');
            } else if (currentScannerTarget === 'recipient') {
                recipientInput.value = data;
                validateRecipientAddress();
                showAlert('آدرس گیرنده از QR کد خوانده شد', true);
                highlightScannedField('recipient');
            } else if (currentScannerTarget === 'destinationTag') {
                destinationTagInput.value = data;
                validateDestinationTag();
                showAlert('تگ مقصد از QR کد خوانده شد', true);
                highlightScannedField('destinationTag');
            } else {
                showAlert('نوع فیلد نامشخص است', false);
            }

            setTimeout(() => {
                currentScannerTarget = null;
            }, 500);
        }

        function highlightScannedField(fieldType) {
            let fieldElement;

            switch (fieldType) {
                case 'privateKey':
                    fieldElement = privateKeyInput;
                    break;
                case 'recipient':
                    fieldElement = recipientInput;
                    break;
                case 'destinationTag':
                    fieldElement = destinationTagInput;
                    break;
                default:
                    return;
            }

            fieldElement.style.border = '2px solid #28a745';
            fieldElement.style.boxShadow = '0 0 10px rgba(40, 167, 69, 0.5)';

            fieldElement.scrollIntoView({ behavior: 'smooth', block: 'center' });

            setTimeout(() => {
                fieldElement.style.border = '';
                fieldElement.style.boxShadow = '';
            }, 2000);
        }

        async function encryptText(text, password) {
            try {
                const salt = crypto.getRandomValues(new Uint8Array(SALT_LENGTH));
                const iv = crypto.getRandomValues(new Uint8Array(IV_LENGTH));

                const encoder = new TextEncoder();
                const passwordBuffer = encoder.encode(password);

                const keyMaterial = await crypto.subtle.importKey(
                    'raw',
                    passwordBuffer,
                    'PBKDF2',
                    false,
                    ['deriveKey']
                );

                const key = await crypto.subtle.deriveKey(
                    {
                        name: 'PBKDF2',
                        salt: salt,
                        iterations: PBKDF2_ITERATIONS,
                        hash: 'SHA-256'
                    },
                    keyMaterial,
                    {
                        name: 'AES-GCM',
                        length: PBKDF2_KEY_LENGTH
                    },
                    false,
                    ['encrypt']
                );

                const textBuffer = encoder.encode(text);
                const encryptedBuffer = await crypto.subtle.encrypt(
                    {
                        name: 'AES-GCM',
                        iv: iv,
                    },
                    key,
                    textBuffer
                );

                const combined = new Uint8Array(
                    salt.length + iv.length + encryptedBuffer.byteLength
                );

                combined.set(salt, 0);
                combined.set(iv, salt.length);
                combined.set(new Uint8Array(encryptedBuffer), salt.length + iv.length);

                return Array.from(combined).map(b => b.toString(16).padStart(2, '0')).join('');

            } catch (error) {
                console.error('خطا در رمزگذاری:', error);
                throw new Error('خطا در رمزگذاری متن');
            }
        }

        async function decryptText(encryptedData, password) {
            try {
                const combined = new Uint8Array(encryptedData.match(/.{1,2}/g).map(byte => parseInt(byte, 16)));

                const salt = combined.slice(0, SALT_LENGTH);
                const iv = combined.slice(SALT_LENGTH, SALT_LENGTH + IV_LENGTH);
                const ciphertextWithTag = combined.slice(SALT_LENGTH + IV_LENGTH);

                const encoder = new TextEncoder();
                const passwordBuffer = encoder.encode(password);

                const keyMaterial = await crypto.subtle.importKey(
                    'raw',
                    passwordBuffer,
                    'PBKDF2',
                    false,
                    ['deriveKey']
                );

                const key = await crypto.subtle.deriveKey(
                    {
                        name: 'PBKDF2',
                        salt: salt,
                        iterations: PBKDF2_ITERATIONS,
                        hash: 'SHA-256'
                    },
                    keyMaterial,
                    {
                        name: 'AES-GCM',
                        length: PBKDF2_KEY_LENGTH
                    },
                    false,
                    ['decrypt']
                );

                const decryptedBuffer = await crypto.subtle.decrypt(
                    {
                        name: 'AES-GCM',
                        iv: iv,
                    },
                    key,
                    ciphertextWithTag
                );

                const decoder = new TextDecoder();
                return decoder.decode(decryptedBuffer);

            } catch (error) {
                console.error('خطا در رمزگشایی:', error);
                throw new Error('رمز عبور یا کلید خصوصی رمزگذاری شده معتبر نیست');
            }
        }

        async function closeQRScanner() {
            scanning = false;

            if (scannerStream) {
                scannerStream.getTracks().forEach(track => track.stop());
                scannerStream = null;
            }

            qrVideo.srcObject = null;
            scannerModal.style.display = 'none';

            await new Promise(resolve => setTimeout(resolve, 50));

            scannerStatus.textContent = 'در حال آماده‌سازی اسکنر...';
            scannerStatus.style.color = '';
            cameraPermission.style.display = 'block';
            scannerContainer.classList.add('hidden');
            currentScannerTarget = null;
        }
    </script>
</body>

</html>